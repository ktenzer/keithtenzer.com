I"2<h2><img class="alignnone wp-image-9855" src="/assets/2017/05/redhatvirtual-8648b589ea764898.jpeg" alt="redhatvirtual-8648b589ea764898" width="492" height="277" /></h2>
<h2>Overview</h2>
<p>In this article we will setup a Red Hat Enterprise Virtualization (RHV) environment. RHV is based on upstream opensource projects <a href="https://www.linux-kvm.org/page/Main_Page">KVM </a>and <a href="https://www.ovirt.org/">Ovirt</a>. RHV is composed of Red Hat Enterprise Linux (RHEL which includes KVM) and Red Hat Enterprise Virtualization Management (RHV-M), based on Ovirt. As of this article the latest version is RHV 4.1.</p>
<p>RHV has of late become very interesting to customers looking for alternatives to VMware. Below are a few reasons why you should be interested in RHV:</p>
<ul>
<li>100% opensource no proprietary code and no proprietary licencing.</li>
<li>Best Hypervisor for running Red Hat Enterprise Linux (RHEL).</li>
<li>Integrated and built with RHEL, uses SELinux to secure Hypervisor.</li>
<li><a href="https://www.redhat.com/en/files/resources/en-rhev-performance-specvirt-11055197.pdf">RHV leads VMware in SPECvirt performance and price per performance (last results 2013)</a>.</li>
<li>RHV scales vertically and performs extremely well on 4 or even 8 socket servers.</li>
<li>All features are included in RHV subscription, no licensing for extra capabilities.</li>
<li>KVM is future proof and is the defacto standard for OpenStack and modern virtualizations platforms.</li>
</ul>
<p><!--more--></p>
<h2>Preparation</h2>
<p>In this configuration I am using two physical servers. Each has a dual-core CPU and 16GB RAM. Specifically I am using two <a href="https://www.amazon.com/Intel-NUC5CPYH-Graphics-2-5-Inch-BOXNUC5CPYH/dp/B00XPVRR5M/ref=sr_1_3?s=pc&amp;ie=UTF8&amp;qid=1493724242&amp;sr=1-3&amp;keywords=intel+nuc">Intel NUC</a>s which make a great, portable lab environments. In my environment I named the Hypervisor hosts rhevh01.lab and rhevh02.lab.</p>
<p><strong>[RHEVH01 and RHEVH02]</strong></p>
<p><strong>Install RHEL 7.3 on both nodes.</strong></p>
<p><strong>Enable subscription and configure repositories.</strong></p>
<pre># subscription-manager register
# subscription-manager list --available
# subscription-manager attach --pool=
# subscription-manager repos --disable=*
# subscription-manager repos --enable=rhel-7-server-rpms \ 
--enable=rhel-7-server-rhv-4.1-mgmt-agent-rpms</pre>
<p><strong>Disable firewalld and NetworkManager</strong></p>
<pre># systemctl stop firewalld
# systemctl disable firewalld
# systemctl stop NetworkManager
#systemctl disable NetworkManager</pre>
<p><strong>Update.</strong></p>
<pre>#yum update -y
#systemctl reboot</pre>
<p><strong>Configure NFS.</strong></p>
<p>RHV requires shared storage in order to cluster Hypervisors. In this case we will expose the local storage of both nodes as NFS shares.</p>
<pre># yum install nfs-utils rpcbind
# systemctl enable rpcbind
# systemctl enable nfs-server
# systemctl start rpcbind
# systemctl start nfs-server</pre>
<p><strong>Configure and export NFS share.</strong></p>
<pre># mkdir /usr/share/rhev
# chown -R 36:36 /usr/share/rhev
# chmod -R 0755 /usr/share/rhev</pre>
<pre># vi /etc/exports 
/usr/share/rhev 192.168.2.0/24(rw)</pre>
<pre># exportfs -a</pre>
<h2>RHV Installation</h2>
<p>There are two different installations approaches for the hypervisor and management. RHV as mentioned earlier consists of the Hypervisor host(s) (RHEL + KVM) and a system running the management software (RHV-M).</p>
<p><strong>Hypervisor Options</strong></p>
<ul>
<li>Use RHEL</li>
<li>Use RHEV-H (Based on RHEL but designed to run as a Hypervisor, only software required for running Hypervisor installed)</li>
</ul>
<p><strong>RHV-M Options</strong></p>
<ul>
<li>Install RHV-M on separate VM or physical server.</li>
<li>Use Hosted-engine which deploys RHV-M on the actual RHV cluster. In this example we will choose hosted-engine and this is my personal preference because RHV-M automatically gets all the capabilities and benefits of running on RHV, such as HA.</li>
</ul>
<h2>Install hosted engine</h2>
<p><strong>[RHEVH01]</strong></p>
<p><strong>Install hosted-engine software and dependencies.</strong></p>
<pre>[root@rhevh01 ~]# yum install -y ovirt-hosted-engine-setup
[root@rhevh01 ~]# yum install -y rhevm-appliance</pre>
<p><strong>Install screen for using with setup.</strong></p>
<pre># yum -y install screen</pre>
<p><strong>Start screen session.</strong></p>
<p>This is used in event you have network connection issue during setup.</p>
<pre># screen</pre>
<p><strong>Deploy hosted-engine on hypervisor host.</strong></p>
<pre># hosted-engine --deploy</pre>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p><strong>Select nfs3 for storage and configure OVF using cloud-init</strong></p>
<p>[ INFO ] Stage: Setup validation</p>
<p>--== CONFIGURATION PREVIEW ==--</p>
<p>Bridge interface : eno1<br />
Engine FQDN : rhevm.lab<br />
Bridge name : ovirtmgmt<br />
Host address : rhevh01.lab<br />
SSH daemon port : 22<br />
Firewall manager : iptables<br />
Gateway address : 192.168.0.1<br />
Host name for web application : hosted_engine_1<br />
Storage Domain type : nfs3<br />
Host ID : 1<br />
Image size GB : 50<br />
Storage connection : 192.168.0.21:/usr/share/rhev<br />
Console type : vnc<br />
Memory size MB : 4096<br />
MAC address : 00:16:3e:3c:79:9b<br />
Boot type : disk<br />
Number of CPUs : 2<br />
OVF archive (for disk boot) : /usr/share/ovirt-engine-appliance/rhevm-appliance-4.0.20170307.0-1.el7ev.ova<br />
Appliance version : 4.0.20170307.0-1.el7ev<br />
Restart engine VM after engine-setup: True<br />
CPU Type : model_Haswell-noTSX</p>
<p>Please confirm installation settings (Yes, No)[Yes]:</p>
<p>Note: If deployment fails it may be because of conflict in version of ebtables.</p>
<p><strong>Check if you have ebtables version &gt; 2.0.10-13 (optional).</strong></p>
<pre>qpm -qa | grep ebtables</pre>
<pre># yum downgrade ebtables-2.0.10-13.el7.x86_64</pre>
<h2>Configure RHV cluster in RHV-M</h2>
<p>Once we have installed the hosted-engine we can complete the setup and configure both nodes in a RHV cluster.</p>
<p><strong>[RHV-M Console]</strong></p>
<p><strong>Connect to RHV-M management console.</strong></p>
<p>Note: The hostname of RHV-M not IP needs to be used to access the management console.</p>
<p>http://rhevm.lab/ovirt-engine</p>
<p><img class="alignnone size-full wp-image-9556" src="/assets/2017/05/rhevm_login.jpg" alt="rhevm_login" width="1102" height="846" /></p>
<p>Select Datacenter-&gt;Hosts-&gt;New.</p>
<p><img class="alignnone size-full wp-image-9558" src="/assets/2017/05/rhevm_add_host.jpg" alt="rhevm_add_host" width="736" height="707" /></p>
<p>RHV-M will configure the second node and bring it into the cluster.</p>
<p><img class="alignnone size-full wp-image-9559" src="/assets/2017/05/rhevm_hypervisor_installed.jpg" alt="rhevm_hypervisor_installed" width="1218" height="164" /></p>
<p><strong>Add iptables rules to allow NFS.</strong></p>
<p>This is specific to this setup as we are cheap and lazy. We are using local disks on Hypervisor hosts for storage.</p>
<p><strong>[RHEVH01 and RHEVH02]</strong></p>
<pre># vi /etc/sysconcfig/iptables
</pre>
:ET