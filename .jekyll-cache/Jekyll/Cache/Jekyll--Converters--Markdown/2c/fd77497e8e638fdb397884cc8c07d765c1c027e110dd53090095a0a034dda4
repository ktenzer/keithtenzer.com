I"J<h2><img class="alignnone  wp-image-12890" src="/assets/2019/10/OpenShift-LogoType.svg_.png" alt="OpenShift-LogoType.svg" width="105" height="112" />Â <img class="alignnone  wp-image-5500" src="/assets/2019/10/heavy-plus-sign.png" alt="heavy-plus-sign" width="96" height="96" /><img class="alignnone  wp-image-12374" src="/assets/2019/10/openstack-logo.png" alt="openstack-logo" width="204" height="103" /></h2>
<h2>Overview</h2>
<p>In this article we start a new journey, automated infrastructure in the on-premise datacenter. We will deploy OpenShift 4.2 on OpenStack. As I am sure you are aware, OpenShift is Red Hat's enterprise kubernetes platform. Kubernetes is of course the brains but by itself is not a platform. OpenShift brings with kubernetes, monitoring, aggregate logging, container registry, security, automated deployment/upgrade, developer experience, huge middleware tooling built around JBoss, serverless frameworks, ISTIO (service mesh), CI/CD integration and the key word "<strong><span style="text-decoration:underline;">ENTERPRISE</span></strong>".</p>
<p><!--more--></p>
<p>OpenShift 4 brings with it, one thing that I feel is a breakthrough in our industry. It is the single feature I am most excited about and one of the reasons OpenShift 4 was re-designed, Installer Provision Infrastructure (IPI). Using IPI, OpenShift is capable of not only installing itself but deploying as well as managing the underlying infrastructure needed, from compute, to storage and network. Further using IPI OpenShift can also update, even upgrade itself over the air. This is a huge step forward in platform intelligence and where we need to be to deal with today's complexity.</p>
<p>Users can also still opt for User Provisioned Infrastructure (UPI), if they want to bring their own infrastructure, deal with micro-managing everything and waste a lot of time but why? Yeah I thought so too.</p>
<p>Up until now IPI has only supported public clouds: AWS, Azure and Google. Now with OpenShift 4.2 it is supporting OpenStack. For the first time we can bring IPI into the on-premise Datacenter where it is IMHO most needed. This single feature has the potential to revolutionize on-premise environments and bring them into the cloud-age with a single click and that promise is truly something to get excited about!</p>
<h2>Pre-requisites</h2>
<p>Before we start the installation it is important to understand some pre-requisites and how to properly configure them.</p>
<h3>Deploy OpenStack</h3>
<p>I have provided a guide for deploying OpenStack Stein (RHOSP 15) using packstack on Hetzner root servers <a href="https://keithtenzer.com/2019/10/28/openstack-15-stein-lab-installation-and-configuration-guide-for-hetzner-root-servers/">here</a>. Even if you aren't using a Hetzner root server this guide can help you spin up a demo OpenStack environment using RDO packstack. If you have Red Hat OpenStack Platform (RHOSP) 15 even better!</p>
<h3>Configure External DNS</h3>
<p>If you have problems later, this will likely be the cause, trust me from experience, get your DNS sorted from the beginning.</p>
<p>You will need a DNS domain, mine is keithtenzer.com. Once you have a domain you need to manage it somewhere. I can recommend <a href="http://cloudflare.com">cloudflare</a>, they even have a free tier. Once you have that you need to create two A records under the domain (keithtenzer.com).</p>
<pre>api.ocp4 144.76.130.237</pre>
<p>The OpenShift installer will ask for a floating ip for API traffic. This is required to install OpenShift. The OpenShift installer will configure an ingres port in OpenStack and use keepalived across the masters.</p>
<pre>*.apps.ocp4 144.76.130.228</pre>
<p>A DNS wildcard is used to send all application traffic to another IP. An additional IP is needed because the OpenShift router operator (ha-proxy) is responsible for handling application traffic not the API operator. The installer will also not automatically configure this floating ip on the ingress port like it does for API. That needs to be done after the installation.</p>
<p>The diagram below shows my DNS configuration.</p>
<p><img class="alignnone size-full wp-image-14228" src="/assets/2019/10/dns-ocp4.png" alt="dns-ocp4" width="1301" height="432" /></p>
<h3>OpenStack Configuration</h3>
<p>To deploy OpenShift we will need an external (floating ip) network, a compute flavor and setup a project properly.</p>
<p>In order to create an floating ip network you need a subnet of physical IPs that can communicate with the outside world. They don't have to be public but need to be routable to whatever is the "outside world", meaning outside of OpenStack.</p>
<p>In this example we have a flat internet routable network 144.76.130.224/28.</p>
<h4>Authenticate to OpenStack</h4>
<pre># source /root/keystonerc_admin</pre>
<h4>Create public network</h4>
<pre>(keystone_admin)]# openstack network create --provider-network-type flat \
--provider-physical-network extnet2 --external public</pre>
<h4>Create public subnet</h4>
<pre>(keystone_admin)]# openstack subnet create --network public \
--allocation-pool start=144.76.130.226,end=144.76.130.238 --no-dhcp \
--subnet-range 144.76.130.224/28 public_subnet</pre>
<h4>Create OpenStack flavor for OpenShift nodes</h4>
<pre>(keystone_admin)]# openstack flavor create --ram 16384 --disk 25 \
--vcpu 4 --public ocp.controller</pre>
<h4>Setup Project</h4>
<pre>(keystone_admin)]# openstack project create openshift_4
(keystone_admin)]# openstack quota set --ram -1 --cores -1 openshift_4
(keystone_admin)]# openstack quota set --secgroups 3 --secgroup-rules 60 \
openshift_4
(keystone_admin)]# openstack user create --password '&lt;password&gt;' \
openshift_admin
(keystone_admin)]# openstack role add --project openshift_4 --user \
openshift_admin admin
(keystone_admin)]# openstack role add --user openshift_admin --project \
openshift_4 swiftoperator</pre>
<h4>Create project RC file</h4>
<pre># vi keystonerc_openshift_admin
unset OS_SERVICE_TOKEN
export OS_USERNAME=openshift_admin
export OS_PASSWORD='&lt;password&gt;'
export OS_REGION_NAME=RegionOne
export OS_AUTH_URL=http://136.243.43.239:5000/v3
export PS1='[\u@\h \W(keystone_openshift_admin)]\$ '
</pre>
:ET