I"âI<h3><a href="https://keithtenzer.files.wordpress.com/2015/12/ovirt_300x100.png" rel="attachment wp-att-1469"><img class="alignnone size-full wp-image-1469" src="/assets/2016/01/ovirt_300x100.png" alt="oVirt_300x100" width="300" height="100" /></a></h3>
<h3>Overview</h3>
<p>RHEV has two separate distinct layers, the hypervisor itself and management. The hypervisor layer, RHEV-H is of course built on Red Hat Enterprise Linux (RHEL) and utilizesÂ KVM for the hypervisor technology. RHEV-H can be configured using pre-built RHEV-H image or usingÂ standard RHEL.Â The management layer, Red Hat Enterprise Virtualization Management (RHEV-M) provides management for a multi-hypervisor environment and uses concepts such as datacenters, clusters, networks and storage domains to describe virtualization resources. In this article we will focus on options for configuring RHEV-M. The upstream opensource project behind RHEV-M is <a href="http://www.ovirt.org/Home">oVirt</a>. There are two options as of RHEV 3.5 for configuring RHEV-M, standalone or hosted engine.</p>
<p>Below are other articles you may find of interest relating to RHEV:</p>
<ul>
<li><a href="http://keithtenzer.com/2015/01/05/red-hat-enterprise-virtualization-rhev-home-lab-configuration/">RHEV Overview and Home Lab Configuration</a></li>
<li><a href="http://keithtenzer.com/2015/01/08/red-hat-enterprise-virtualization-management-rhev-m-overview-apis-and-code-examples/">RHEVM Overview and APIs</a></li>
<li><a href="http://keithtenzer.com/2015/06/18/red-hat-enterprise-virtualization-rhev-hypervisor-host-options/">RHEV Hypervisor Host Options</a></li>
</ul>
<p><!--more--></p>
<h3>RHEV-M Standalone</h3>
<p>RHEV-M standalone means configuring a RHEL physical or virtual systemÂ as a RHEV-M host.</p>
<p><strong>PROS</strong></p>
<ul>
<li>Flexibility can install RHEV-M on any RHEL 6 host.</li>
</ul>
<p><strong>CONS</strong></p>
<ul>
<li>HA not built-in, you need to deal with HA on your own.</li>
<li>Can't use RHEL 7.</li>
<li>Requires additional host outside of virtualization environment.</li>
<li>RHEV-M runs outside virtualization environment and as such cannot directly utilizeÂ virtualization resources such as storage.</li>
</ul>
<p>To configure RHEV using this method follow the steps in this already postedÂ <a href="http://keithtenzer.com/2015/06/18/red-hat-enterprise-virtualization-rhev-hypervisor-host-options/">article</a>.</p>
<h3>RHEV-M Hosted Engine</h3>
<p>RHEV-M hosted engine means configuring RHEV-M as a virtual machine directly on a hypervisor host. RHEV-M lives inside the virtualization environment it is managing. Before configuring hypervisor host, RHEV-M must be configured. As such hosted engine is installed using yum directly on chosen hypervisor host.Â Simply install RHEL 7 and follow the steps listed further below in this article.</p>
<p><strong>PROS</strong></p>
<ul>
<li>Takes advantage of RHEV, HA is built-in.</li>
<li>Simplified and streamlined installation of RHEV.</li>
<li>Does not require separate host system.</li>
</ul>
<p><strong>CONS</strong></p>
<ul>
<li>At least one hypervisor must be running in order to access RHEV-M.</li>
<li>If there are multiple-separate virtualization environments complexity could be greater.</li>
</ul>
<p>Follow the below guide to configure a RHEV environment using the hosted engine.</p>
<ul>
<li>Enable required repositories.</li>
</ul>
<pre style="padding-left:30px;">[root@rhevh01 ~]# subscription-manager register
[root@rhevh01 ~]# subscription-manager attach --pool=3848378728191899189
[root@rhevh01 ~]# subscription-manager repos --disable=*
[root@rhevh01 ~]# subscription-manager repos --enable=rhel-7-server-rpms
[root@rhevh01 ~]# subscription-manager repos --enable=rhel-7-server-supplementary-rpms
[root@rhevh01 ~]# <code>subscription-manager repos --enable=rhel-7-server-optional-rpms
</code>[root@rhevh01 ~]# <code></code>subscription-manager repos --enable=rhel-7-server-rhev-mgmt-agent-rpms 
[root@rhevh01 ~]# yum update -y</pre>
<p>The hosted engine requires an NFS or ISCSI share. In this case we will use NFSv3 and create a local share on our hypervisor host. This storage is only used for hosted engine and won't show up in RHEV-M.</p>
<ul>
<li>InstallÂ iptables (optional). Note: as of writing of this article, firewalld does not work with RHEV 3.5, at least that has been my experience.</li>
</ul>
<pre style="padding-left:30px;">[root@rhevh01 ~]# yum -y install iptables-services</pre>
<ul>
<li>Disable firewalld.</li>
</ul>
<pre style="padding-left:30px;">[root@rhevh01 ~]# systemctl stop firewalld
[root@rhevh01 ~]# systemctl disable firewalld</pre>
<ul>
<li>Enable iptables (optional).</li>
</ul>
<pre style="padding-left:30px;">[root@rhevh01 ~]# systemctl enable iptables
[root@rhevh01 ~]# systemctl start iptables</pre>
<ul>
<li>Configure iptables rules for RHEV and NFS (optional).</li>
</ul>
<pre style="padding-left:30px;">[root@rhevh01 ~]# vi /etc/sysconfig/iptables</pre>
<pre style="padding-left:30px;">*filter
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [64:6816]
-A INPUT -p udp -m udp --dport 32769 -j ACCEPT
-A INPUT -p tcp -m tcp --dport 32803 -j ACCEPT
-A INPUT -p udp -m udp --dport 662 -j ACCEPT
-A INPUT -p tcp -m tcp --dport 662 -j ACCEPT
-A INPUT -p udp -m udp --dport 875 -j ACCEPT
-A INPUT -p tcp -m tcp --dport 875 -j ACCEPT
-A INPUT -p udp -m udp --dport 892 -j ACCEPT
-A INPUT -p tcp -m tcp --dport 892 -j ACCEPT
-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
-A INPUT -p icmp -j ACCEPT
-A INPUT -i lo -j ACCEPT
-A INPUT -p tcp -m tcp --dport 54321 -j ACCEPT
-A INPUT -p tcp -m tcp --dport 111 -j ACCEPT
-A INPUT -p udp -m udp --dport 111 -j ACCEPT
-A INPUT -p tcp -m tcp --dport 22 -j ACCEPT
-A INPUT -p udp -m udp --dport 161 -j ACCEPT
-A INPUT -p tcp -m tcp --dport 38465 -j ACCEPT
-A INPUT -p tcp -m tcp --dport 38466 -j ACCEPT
-A INPUT -p tcp -m tcp --dport 38467 -j ACCEPT
-A INPUT -p tcp -m tcp --dport 2049 -j ACCEPT
-A INPUT -p tcp -m tcp --dport 39543 -j ACCEPT
-A INPUT -p tcp -m tcp --dport 55863 -j ACCEPT
-A INPUT -p tcp -m tcp --dport 38468 -j ACCEPT
-A INPUT -p udp -m udp --dport 963 -j ACCEPT
-A INPUT -p tcp -m tcp --dport 965 -j ACCEPT
-A INPUT -p tcp -m tcp --dport 16514 -j ACCEPT
-A INPUT -p tcp -m multiport --dports 5900:6923 -j ACCEPT
-A INPUT -p tcp -m multiport --dports 49152:49216 -j ACCEPT
-A INPUT -j REJECT --reject-with icmp-host-prohibited
-A FORWARD -m physdev ! --physdev-is-bridged -j REJECT --reject-with icmp-host-prohibited
COMMIT</pre>
<ul>
<li>Restart iptables (optional).</li>
</ul>
<pre style="padding-left:30px;">[root@rhevh01 ~]# systemctl restart iptables</pre>
<ul>
<li>Configure NFS Services.</li>
</ul>
<pre style="padding-left:30px;">[root@rhevh01 ~]# yum install nfs-utils rpcbind
[root@rhevh01 ~]# systemctl enable rpcbind
[root@rhevh01 ~]# systemctl enable nfs-server
[root@rhevh01 ~]# systemctl start rpcbind
[root@rhevh01 ~]# systemctl start nfs-server</pre>
<ul>
<li>Configure NFS Share.</li>
</ul>
<pre style="padding-left:30px;">[root@rhevh01 ~]# mkdir /usr/share/rhev
[root@rhevh01 ~]# chown -R 36:36 /usr/share/rhev
[root@rhevh01 ~]# chmod -R 0755 /usr/share/rhev</pre>
<pre style="padding-left:30px;">[root@rhevh01 ~]# vi /etc/exports 
/usr/share/rhev 192.168.2.0/24(rw)</pre>
<pre style="padding-left:30px;">[root@rhevh01 ~]# exportfs -a</pre>
<ul>
<li>Install Hosted Engine.</li>
</ul>
<pre style="padding-left:30px;">[root@rhevh01 ~]# yum install -y ovirt-hosted-engine-setup</pre>
<p>Note: if you are connecting via ssh you will need to forward X11. If you are using windows then you need to install Xming and Putty explained <a href="https://wiki.utdallas.edu/wiki/display/FAQ/X11+Forwarding+using+Xming+and+PuTTY">here</a>.</p>
<ul>
<li>Install X11 libraries (optional).</li>
</ul>
<pre style="padding-left:30px;">[root@rhevh01 ~]# yum groupinstall -y "Server with GUI"</pre>
<ul>
<li>Configure Hosted Engine. Note: in this example, screen is used and this is strongly recommended if installing through ssh connection. In fact, anytime you are working through ssh you should use screen, if something unexpected happens you can reconnect.</li>
</ul>
<pre style="padding-left:30px;">[root@rhevh01 ~]# yum install -y screen</pre>
<pre style="padding-left:30px;">[root@rhevh01 ~]# screenÂ hosted-engine --deploy</pre>
<pre style="padding-left:30px;">--== VM CONFIGURATION ==--</pre>
<pre style="padding-left:30px;">Please specify the device to boot the VM from (cdrom, disk, pxe) [cdrom]: disk
 Please specify path to OVF archive you would like to use [None]: /usr/share/rhev/rhevm-appliance-20150421.0-1.x86_64.rhevm.ova
[ INFO ] Checking OVF archive content (could take a few minutes depending on archive size)
[ INFO ] Checking OVF XML content (could take a few minutes depending on archive size)
[WARNING] OVF does not contain a valid image description, using default.
 Please specify an alias for the Hosted Engine image [hosted_engine]:
 The following CPU types are supported by this host:
 - model_SandyBridge: Intel SandyBridge Family
 - model_Westmere: Intel Westmere Family
 - model_Nehalem: Intel Nehalem Family
 - model_Penryn: Intel Penryn Family
 - model_Conroe: Intel Conroe Family
 Please specify the CPU type to be used by the VM [model_SandyBridge]:
[WARNING] Minimum requirements for CPUs not met
 You may specify a unicast MAC address for the VM or accept a randomly generated default [00:16:3e:04:eb:78]:
 Please specify the console type you would like to use to connect to the VM (vnc, spice) [vnc]: spice</pre>
<pre style="padding-left:30px;">--== HOSTED ENGINE CONFIGURATION ==--</pre>
<pre style="padding-left:30px;">Enter the name which will be used to identify this host inside the Administrator Portal [hosted_engine_1]:
 Enter 'admin@internal' user password that will be used for accessing the Administrator Portal:
 Confirm 'admin@internal' user password:
 Please provide the FQDN for the engine you would like to use.
 This needs to match the FQDN that you will use for the engine installation within the VM.
 Note: This will be the FQDN of the VM you are now going to create,
 it should not point to the base host or to any other existing machine.
 Engine FQDN: he01.lab
[WARNING] Failed to resolve he01.lab using DNS, it can be resolved only locally
 Please provide the name of the SMTP server through which we will send notifications [localhost]:
 Please provide the TCP port number of the SMTP server [25]:
 Please provide the email address from which notifications will be sent [root@localhost]:
 Please provide a comma-separated list of email addresses which will get notifications [root@localhost]:
[ INFO ] Stage: Setup validation
[WARNING] Failed to resolve rhevh01.lab using DNS, it can be resolved only locally</pre>
<pre style="padding-left:30px;">--== CONFIGURATION PREVIEW ==--</pre>
<pre style="padding-left:30px;">Bridge interface : eno1
 Engine FQDN : he01.lab
 Bridge name : rhevm
 SSH daemon port : 22
 Firewall manager : iptables
 Gateway address : 192.168.0.1
 Host name for web application : hosted_engine_1
 Host ID : 1
 Image alias : hosted_engine
 Image size GB : 50
 Storage connection : rhevh01.lab:/usr/share/rhev
 Console type : qxl
 Memory size MB : 4096
 MAC address : 00:16:3e:04:eb:78
 Boot type : disk
 Number of CPUs : 1
 OVF archive (for disk boot) : /usr/share/rhev/rhevm-appliance-20150421.0-1.x86_64.rhevm.ova
 CPU Type : model_SandyBridge</pre>
<pre style="padding-left:30px;">Please confirm installation settings (Yes, No)[Yes]:</pre>
<p>Once you confirm settings the hosted engine will be deployed and you will be prompted to connect to the console of the hosted engine.</p>
<ul>
<li>Using remote-viewer connect to console of hosted engine.</li>
</ul>
<pre style="padding-left:30px;">[root@rhevh01 ~]# /bin/remote-viewer --spice-ca-file=/etc/pki/vdsm/libvirt-spice/ca-cert.pem spice://localhost?tls-port=5901 --spice-host-subject="C=EN, L=Test, O=Test, CN=Test"</pre>
<p><a href="https://keithtenzer.files.wordpress.com/2016/01/hosted_engine_setup_tool.jpg" rel="attachment wp-att-1489"><img class="alignnone wp-image-1489" src="/assets/2016/01/hosted_engine_setup_tool.jpg?w=300" alt="Hosted_Engine_Setup_Tool" width="1266" height="650" /></a></p>
<ul>
<li>Configure authentication settings and set root password in the tools menu.</li>
<li>Configure networking.</li>
<li>Register with subscription manager.</li>
</ul>
<pre style="padding-left:30px;">[root@rhevm ~]# subscription-manager register</pre>
<pre style="padding-left:30px;">[root@rhevm ~]# subscription-manager attach --pool=3948394898198989000922</pre>
<ul>
<li>Configure yum repositories.</li>
</ul>
<pre style="padding-left:30px;">[root@rhevm ~]# subscription-manager repos --disable=* 
[root@rhevm ~]# subscription-manager repos --enable=rhel-6-server-rpms 
[root@rhevm ~]# subscription-manager repos --enable=rhel-6-server-optional-rpms 
[root@rhevm ~]# subscription-manager repos --enable=rhel-6-server-supplementary-rpms 
[root@rhevm ~]# subscription-manager repos --enable=rhel-6-server-rhev-mgmt-agent-rpms 
[root@rhevm ~]# subscription-manager repos --enable=rhel-6-server-rhevm-3.5-rpms</pre>
<ul>
<li>Installed RHEV-M.</li>
</ul>
<pre style="padding-left:30px;"># yum update -y</pre>
<pre style="padding-left:30px;"># yum install -y rhevm</pre>
<pre style="padding-left:30px;"># engine-setup</pre>
<ul>
<li>After completing engine-setup go back to hypervisor and press [1] to continue hosted engine setup.</li>
</ul>
<pre style="padding-left:30px;">[ INFO ] Engine replied: DB Up!Welcome to Health Status!
 Enter the name of the cluster to which you want to add the host (Default) [Default]:
[ INFO ] Waiting for the host to become operational in the engine. This may take several minutes...
[ INFO ] Still waiting for VDSM host to become operational...
[ INFO ] Still waiting for VDSM host to become operational...
[ INFO ] The VDSM Host is now operational
 Please shutdown the VM allowing the system to launch it as a monitored service.
 The system will wait until the VM is down.</pre>
<ul>
<li>Shutdown the hosted engine VM.</li>
</ul>
<pre style="padding-left:30px;">[root@rhevm ~]#Â shutdown -h now</pre>
<p>Once the hosted VM is shutdown, the installation completes. Congrats, you have successfully deployed a RHEV environment with the hosted engine option.</p>
<h3>Add Additional Hypervisor Host to RHEV-M Hosted Engine</h3>
<p>Adding an additional hypervisor host using the hosted engine is a simple process.</p>
<ul>
<li>Enable required repositories.</li>
</ul>
<pre style="padding-left:30px;">[root@rhevh01 ~]# subscription-manager register
[root@rhevh01 ~]# subscription-manager attach --pool=3848378728191899189
[root@rhevh02 ~]# subscription-manager repos --disable=*
[root@rhevh02 ~]# subscription-manager repos --enable=rhel-7-server-rpms
[root@rhevh02 ~]# subscription-manager repos --enable=rhel-7-server-supplementary-rpms
[root@rhevh02 ~]# <code>subscription-manager repos --enable=rhel-7-server-optional-rpms
</code>[root@rhevh02 ~]# <code></code>subscription-manager repos --enable=rhel-7-server-rhev-mgmt-agent-rpms 
[root@rhevh02 ~]# yum update -y</pre>
<ul>
<li>InstallÂ iptables (optional). Note: as of writing of this article, firewalld does not work with RHEV 3.5.</li>
</ul>
<pre style="padding-left:30px;">[root@rhevh02 ~]# yum -y install iptables-services</pre>
<ul>
<li>Disable firewalld.</li>
</ul>
<pre style="padding-left:30px;">[root@rhevh02 ~]# systemctl stop firewalld
[root@rhevh02 ~]# systemctl disable firewalld</pre>
<ul>
<li>Enable iptables (optional).</li>
</ul>
<pre style="padding-left:30px;">[root@rhevh02 ~]# systemctl enable iptables
[root@rhevh02 ~]# systemctl start iptables</pre>
<ul>
<li>Configure iptables rules for RHEV and NFS (optional).</li>
</ul>
<pre style="padding-left:30px;">[root@rhevh02 ~]# vi /etc/sysconfig/iptables</pre>
<pre style="padding-left:30px;">*filter
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [64:6816]
-A INPUT -p udp -m udp --dport 32769 -j ACCEPT
-A INPUT -p tcp -m tcp --dport 32803 -j ACCEPT
-A INPUT -p udp -m udp --dport 662 -j ACCEPT
-A INPUT -p tcp -m tcp --dport 662 -j ACCEPT
-A INPUT -p udp -m udp --dport 875 -j ACCEPT
-A INPUT -p tcp -m tcp --dport 875 -j ACCEPT
-A INPUT -p udp -m udp --dport 892 -j ACCEPT
-A INPUT -p tcp -m tcp --dport 892 -j ACCEPT
-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
-A INPUT -p icmp -j ACCEPT
-A INPUT -i lo -j ACCEPT
-A INPUT -p tcp -m tcp --dport 54321 -j ACCEPT
-A INPUT -p tcp -m tcp --dport 111 -j ACCEPT
-A INPUT -p udp -m udp --dport 111 -j ACCEPT
-A INPUT -p tcp -m tcp --dport 22 -j ACCEPT
-A INPUT -p udp -m udp --dport 161 -j ACCEPT
-A INPUT -p tcp -m tcp --dport 38465 -j ACCEPT
-A INPUT -p tcp -m tcp --dport 38466 -j ACCEPT
-A INPUT -p tcp -m tcp --dport 38467 -j ACCEPT
-A INPUT -p tcp -m tcp --dport 2049 -j ACCEPT
-A INPUT -p tcp -m tcp --dport 39543 -j ACCEPT
-A INPUT -p tcp -m tcp --dport 55863 -j ACCEPT
-A INPUT -p tcp -m tcp --dport 38468 -j ACCEPT
-A INPUT -p udp -m udp --dport 963 -j ACCEPT
-A INPUT -p tcp -m tcp --dport 965 -j ACCEPT
-A INPUT -p tcp -m tcp --dport 16514 -j ACCEPT
-A INPUT -p tcp -m multiport --dports 5900:6923 -j ACCEPT
-A INPUT -p tcp -m multiport --dports 49152:49216 -j ACCEPT
-A INPUT -j REJECT --reject-with icmp-host-prohibited
-A FORWARD -m physdev ! --physdev-is-bridged -j REJECT --reject-with icmp-host-prohibited
COMMIT</pre>
<ul>
<li>Restart iptables (optional).</li>
</ul>
<pre style="padding-left:30px;">[root@rhevh02 ~]# systemctl restart iptables</pre>
<ul>
<li>Install Hosted Engine.</li>
</ul>
<pre style="padding-left:30px;">[root@rhevh02 ~]# yum install -y ovirt-hosted-engine-setup</pre>
<p>Note: if you are connecting via ssh you will need to forward X11. If you are using windows then you need to install Xming and Putty explained <a href="https://wiki.utdallas.edu/wiki/display/FAQ/X11+Forwarding+using+Xming+and+PuTTY">here</a>.</p>
<ul>
<li>Install X11 libraries (optional).</li>
</ul>
<pre style="padding-left:30px;">[root@rhevh02 ~]# yum groupinstall -y "Server with GUI"</pre>
<ul>
<li>Configure Hosted Engine. Note: in this example screen is used and this is strongly recommended if installing through ssh connection.</li>
</ul>
<pre style="padding-left:30px;">[root@rhevh02 ~]# yum install -y screen</pre>
<pre style="padding-left:30px;">[root@rhevh02 ~]# screenÂ hosted-engine --deploy</pre>
<p>When prompted for storage connection, provide the same NFS share used when originally configuring hosted engine [rhevh01.lab:/usr/share/rhev]. The install script will detect the storage connectionÂ and instead of deploying hosted engine, will add the hypervisor host to already running hosted engine.</p>
<p>In order to interact with the hosted engine, the hosted-engine CLIÂ must be used. You can start, stop and get the status of the hosted engine using this CLI tool.</p>
<pre style="padding-left:30px;">[root@rhevh01 ~]# hosted-engine --vm-status
</pre>
:ET