<h2><img class="alignnone  wp-image-14443" src="/assets/2020/04/38202270.png?w=173&amp;h=173" alt="38202270" width="173" height="173" /></h2>
<h2>Overview</h2>
<p>In this article we will provide a hands-on guide to building your very first operator in Ansible. Using the Operator SDK we will learn how to create boilerplate code, build and deploy an operator.</p>
<p>This article is part of a series that will walk you through understanding and building operators in Go or Ansible end-to-end.</p>
<ul>
<li><a href="https://keithtenzer.com/2020/04/23/openshift-operator-getting-started-part-i/">OpenShift Operator Getting Started Part I</a></li>
<li><a href="https://keithtenzer.com/2020/01/27/openshift-operator-sdk-go-getting-started-guide-part-ii/">OpenShift Operator SDK: Go Getting Started Guide Part II</a></li>
<li><a href="https://keithtenzer.com/2020/04/23/openshift-operator-sdk-ansible-getting-started-guide-part-iii/">OpenShift Operator SDK: Ansible Getting Started Guide Part III</a></li>
<li><a href="https://keithtenzer.com/2020/04/23/openshift-operator-lifecycle-management-guide-integrating-operators-in-olm-part-iv/">OpenShift Operator Lifecycle Management Guide: Integrating Operators in OLM Part IV</a></li>
</ul>
<p><!--more--></p>
<h2>Setup Development Environment</h2>
<p>There are some prerequisites needed to develop and build an operator using Ansible. Also this guide and the operator-sdk assume you know Ansible roles. If you aren not yet up to speed please read about Ansible roles before proceeding.</p>
<p><strong>Install Docker 17.03+</strong></p>
<p>Add the docker ce repositories. Note: you can also use podman and buildah instead of Docker for those that want a complete and clean divorce.</p>
<p><code><span class="nb">$ sudo </span>dnf <span class="nt">-y</span> install dnf-plugins-core</code></p>
<pre class="highlight">$ <code><span class="nb">sudo </span>dnf config-manager <span class="se">\</span>
    <span class="nt">--add-repo</span> <span class="se">\</span>
    https://download.docker.com/linux/fedora/docker-ce.repo</code></pre>
<p>Install docker-ce</p>
<pre>$ sudo dnf -y install docker-ce docker-ce-cli</pre>
<pre>$ sudo systemctl start docker
$ sudo systemctl enable docker</pre>
<p><strong>Install Ansible and Module Dependencies</strong></p>
<p>Install ansible</p>
<pre>$ dnf install ansible</pre>
<p>The Ansible runner and http runner is used to run a local version of the operator. This is very useful for development and testing.</p>
<pre>$ pip3 install --user ansible-runner
$ pip3 install --user ansible-runner-http</pre>
<p>Install required python modules</p>
<pre><code>$ pip3 install --user requests</code> <code>$ pip3 install --user openshift</code></pre>
<p><strong>Install Operator Framework SDK</strong></p>
<p>You can simply <a href="https://github.com/operator-framework/operator-sdk/releases">download</a>a pre-built release and install it under /usr/local/bin.</p>
<h2>Building Your First Operator</h2>
<p>The SDK is able to generate not only boilerplate code but also the CRDs, controller and API endpoints. In this example we will create a cars operator. It will simply provide an endpoint allowing us to do CRUD on car objects. Each car object will spawn a pod with a base image.</p>
<p>Using operatore-sdk cli create boilerplate code.</p>
<pre>$ operator-sdk new cars-operator --api-version=cars.example.com/v1alpha1 --kind=Car --type=ansible</pre>
<p>The operator sdk creates boilerplate roles.</p>
<pre>$ ls cars-operator
build  deploy  molecule  requirements.yml  roles  watches.yaml</pre>
<p>The build directory containers Dockerfile, deploy is where the yaml files are for creating the k8s operator objects (including CRD/CR), the roles directory contains a role called car and finally watches.yaml is the mapping from a k8s object / CRD to a roll.</p>
<p>By default when a car instance is created the operator will execute the role car. You can of course change the behavior, even configure finalizers for dealing with deletion of components not under the control of k8s (see the sdk <a href="https://github.com/operator-framework/operator-sdk/blob/master/doc/ansible/user-guide.md">guide</a>)</p>
<h2>Run Operator locally</h2>
<p>The Ansible operator can be run locally. Simply deploy the CRD, service account and role.</p>
<p>Create new project for our operator</p>
<pre>$ oc new-project cars-operator</pre>
<p>Setup service accounts and role bindings</p>
<pre>$ oc create -f deploy/service_account.yaml</pre>
<pre>$ oc create -f deploy/role.yaml</pre>
<pre>$ oc create -f deploy/role_binding.yaml</pre>
<p>Create the CRD for our operator</p>
<pre>$ oc create -f deploy/crds/cars.example.com_cars_crd.yaml</pre>
<p>Run Operator locally</p>
<pre>$ operator-sdk run --local</pre>
<p>Create a car</p>
<pre>$ vi car.yaml
apiVersion: cars.example.com/v1alpha1
kind: Car
metadata:
  name: example-car
spec:
  size: 3
  bmw:
    model: m3
  audi:
    model: rs4</pre>
<pre>$ oc create -f car.yaml</pre>
<p>Anything under 'spec' will be passed to Ansible as a variable. If you want to reference the size in the ansible role you simply use ''. You can also access nested variables such as the car model by using ''.</p>
<h2>Build Ansible Operator</h2>
<p><strong>Create User on Quay.io</strong></p>
<p>We will be using quay to store operator images. Authenticate using Github or Gmail to <a href="https://quay.io/">https://quay.io</a>. Once authenticated go to account settings and set a password.</p>
<p><strong>Test Quay.io Credentials</strong></p>
<pre>$ sudo docker login quay.io</pre>
<p><strong>Build Operator</strong></p>
<p>Using operator-sdk cli build the operator which will push the image to your local Docker registry. Make sure you are in the cars-operator directory.</p>
<pre>$ sudo operator-sdk build quay.io/ktenzer/cars-operator</pre>
<p>Note: Substitute ktenzer for your username.</p>
<p><strong>Push Operator to your Quay.io Account</strong></p>
<pre>$ sudo docker push quay.io/ktenzer/cars-operator:latest</pre>
<p><strong>Make Quay Repository Public</strong></p>
<p>By default your Quay repository will be private. If we want to access it from OpenShift we need to make it public. Login to quay.io with your username/password</p>
<p>Select the cars-operator repository</p>
<p><img class="alignnone  wp-image-14432" src="/assets/2020/04/screenshot-from-2020-01-25-13-04-42.png?w=1296&amp;h=347" alt="Screenshot from 2020-01-25 13-04-42" width="1296" height="347" /></p>
<p>Under Repository Settings enable visibility to be public</p>
<p><img class="alignnone  wp-image-14433" src="/assets/2020/04/screenshot-from-2020-01-25-13-05-07.png?w=1649&amp;h=405" alt="Screenshot from 2020-01-25 13-05-07" width="1649" height="405" /></p>
<p><strong>Update Image in operator.yaml</strong></p>
<p>We need to point the image to the location in our Quay repository.</p>
<pre>vi deploy/operator.yaml
---
# Replace this with the built image name
image: <strong>quay.io/ktenzer/cars-operator</strong>
command:
---</pre>
<h2>Deploy Cars Operator on OpenShift</h2>
<p>Now that the operator is built and pushed to our Quay repository we can deploy it on an OpenShift cluster.</p>
<p>Authenticate to OpenShift Cluster</p>
<pre>$oc login https://api.ocp4.keithtenzer.com:6443</pre>
<p>Create new project for our operator</p>
<pre>$ oc new-project cars-operator</pre>
<p>Setup service accounts and role bindings</p>
<pre>$ oc create -f deploy/service_account.yaml</pre>
<pre>$ oc create -f deploy/role.yaml</pre>
<pre>$ oc create -f deploy/role_binding.yaml</pre>
<p>Create the CRD for our operator</p>
<pre>$ oc create -f deploy/crds/cars.example.com_cars_crd.yaml</pre>
<p>Deploy our operator</p>
<pre>$ oc create -f deploy/operator.yaml</pre>
<p>Create the CR for our operator</p>
<pre>$ oc create -f deploy/crds/cars.example.com_v1alpha1_car_cr.yaml</pre>
<h2>Using Cars Operator</h2>
<p>The cars operator will automatically deploy an example-car. Whe can query our car object just like any other Kubernetes object. This is the beauty of CR/CRDs and operators. We can easily extend the Kubernetes API without needing to understand it’s complexity.</p>
<pre>$ oc get car
NAME AGE
example-car 31m</pre>
<p>Next we can get information about our example-car.</p>
<pre>$ oc get car example-car -o yaml
apiVersion: cars.example.com/v1alpha1
kind: Car
metadata:
  creationTimestamp: "2020-01-25T12:15:45Z"
  generation: 1
  name: example-car
  namespace: cars-operator
  resourceVersion: "2635723"
  selfLink: /apis/cars.example.com/v1alpha1/namespaces/cars-operator/cars/example-car
  uid: 6a424ef9-3f6c-11ea-a391-fa163e9f184b
spec:
  size: 3

</pre>
<p>Looking at the running pods in our cars-operator project we see the operator and our example-car.</p>
<pre>$ oc get pods -n cars-operator
NAME                            READY   STATUS    RESTARTS   AGE
cars-operator-b98bff54d-t2465   1/1     Running   0          5m
example-car-pod                 1/1     Running   0          5m</pre>
<p><strong>Create a new Car</strong></p>
<p>Lets now create a BMW car.</p>
<pre>$ vi bmw.yaml
kind: Car
metadata:
  name: bmw
spec:
  size: 3
  bmw:
    model: m3</pre>
<pre>$ oc create -f bmw.yaml</pre>
<p>Here we can see we now have a BMW car.</p>
<pre>$ oc get car
NAME          AGE
bmw           11m
example-car   31m</pre>
<p>Of course we can get information about our BMW car.</p>
<pre>$ oc get car bmw -o yaml
apiVersion: cars.example.com/v1alpha1
kind: Car
metadata:
  creationTimestamp: "2020-01-25T12:35:25Z"
  generation: 1
  name: bmw
  namespace: cars-operator
  resourceVersion: "2644044"
  selfLink: /apis/cars.example.com/v1alpha1/namespaces/cars-operator/cars/bmw
  uid: 294bc47f-3f6f-11ea-b32c-fa163e3e8e24
spec:
  size: 1</pre>
<p>Finally as with the example-car, the operator will start a new pod when the BMW car is created.</p>
<pre>$ oc get pods -n cars-operator
NAME                            READY   STATUS    RESTARTS   AGE
bmw-pod                         1/1     Running   0          10m
cars-operator-b98bff54d-t2465   1/1     Running   0          14m
example-car-pod                 1/1     Running   0          14m</pre>
<h2>Cleanup</h2>
<p>Follow these steps to remove the operator cleanly.</p>
<pre>$ oc delete -f deploy/crds/cars.example.com_v1alpha1_car_cr.yaml</pre>
<pre>$ oc delete -f deploy/operator.yaml</pre>
<pre>$ oc delete -f deploy/role.yaml</pre>
<pre>$ oc delete -f deploy/role_binding.yaml</pre>
<pre>$ oc delete -f deploy/service_account.yaml</pre>
<pre>$ oc delete -f deploy/crds/cars.example.com_cars_crd.yaml</pre>
<pre>$ oc delete project cars-operator</pre>
<h2>Summary</h2>
<p>In this article a step-by-step guide was provided to setup a development environment, generate boilerplate code and deploy our custom cars operator using Ansible on OpenShift with the Operator Framework.</p>
<p>Happy Operatoring!</p>
<p>(c) 2020 Keith Tenzer</p>
