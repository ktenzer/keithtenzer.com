<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.22.0 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
<link rel="icon" href="/assets/main/me.png">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>OpenStack Neutron: Configuring L3 HA - Keith Tenzer’s Blog</title>
<meta name="description" content="Overview In this article we will look at how to setup L3 HA in OpenStack Neutron. OpenStack networking can be rather complex, certainly when coming from a traditional networking world. The basic principles behind networking have not changed but OpenStack introduces lots of abstractions that make end-to-end visibility of network traffic flows very difficult to follow. As such before we get into the material it would be good to provide an overview of L3 as it pertains to OpenStack Neutron.  In Neutron L3 allows you to provide external connectivity to instances running in tenant networks that by nature are non-routable. Tenant networks are L2 networks and as such can only communicate with instances on same tenant network. L3 is implemented in Neutron using floating ip addresses. A floating ip is a address of an external network that uses NAT (SNAT/DNAT) to forward traffic to instance ip on tenant network. The below diagram illustrates this connectivity.  In this case we have two networks, a tenant network 10.10.1.0/24 named private and an external network 192.168.122.0/24 named public. The instance mycirros has the ip of 10.10.1.102. In order to communicate with other instances or devices outside the tenant network 10.10.1.0/24 an L3 router is required. Note that floating ips are only associated to an instance, the instance itself is completely unaware of floating ip. If you were to do an &quot;ip a&quot; on an instance you would not see the floating ip. Neutron implements NAT (SNAT/DNAT) in order to forward traffic between instance ip and floating ip using iptables rules. Since these rules can only be configured on a single network node per floating ip we have a problem. If that network node is lost then external connectivity will be interrupted to those instances. Neutron solves this problem with L3 HA. In L3 HA you configure multiple network nodes and on each the Open vSwitch (OVS) agent plugin. In event that a network node is lost, the HA router will failover to a standy on another node and connectivity will not be interrupted for those instances. Neutron ml2 plugins exist for many different SDN solutions not just OVS. Out-of-the-box OVS is of course provided. If you are using another SDN then you most likely would not care about L3 HA within Neutron since you wouldn&#39;t use the L3 agent but rather the SDN plugin and the SDN would provide its own HA solution. Install and Configure OpenStack Kilo In this example we will configure two systems running RHEL or CentOS 7.1. We will use RDO (packstack) to deploy OpenStack Kilo. In OpenStack there are different roles a node can have: controller, network, compute and storage. Things can be customized to even break out individual services like keystone. We will deploy one node as a controller, compute and network node. The second node will only be a network node. This is the minimum configuration required to configure L3 HA since you need two network nodes. [Controller node]  Install RHEL or CentOS 7.1. Ensure name resolution is working  #vi /etc/hosts 192.168.122.81 osp7-ctr1.lab.com osp7-ctr1  Ensure the hostname is set statically.  #hostnamectl set-hostname osp7-ctr1.lab.com  Disable network manager.  #systemctl disable NetworkManager.service  Disable firewalld to make configuration easier.   #systemctl disable firewalld.service  For RHEL systems register with subscription manager.   #subscription-manager register  #subscription-manager subscribe --auto  #subscription-manager repos --disable=*  #subscription-manager repos --enable=rhel-7-server-rpms  #subscription-manager repos --enable=rhel-7-server-openstack-7.0-rpms  Install yum-utils and update the system.   #yum install -y yum-utils  #yum update -y  #reboot [Network node]  Install RHEL or CentOS 7.1. Ensure name resolution is working  #vi /etc/hosts 192.168.122.82 osp7-net1.lab.com osp7-net1  Ensure the hostname is set statically.  #hostnamectl set-hostname osp7-net1.lab.com  Disable network manager.  #systemctl disable NetworkManager.service  Disable firewalld to make configuration easier.   #systemctl disable firewalld.service  For RHEL systems register with subscription manager.   #subscription-manager register  #subscription-manager subscribe --auto  #subscription-manager repos --disable=*  #subscription-manager repos --enable=rhel-7-server-rpms  #subscription-manager repos --enable=rhel-7-server-openstack-7.0-rpms  Install yum-utils and update the system.   #yum install -y yum-utils  #yum update -y  #reboot [Controller node]  Install packstack packages.   #yum install -y openstack-packstack  Create packstack answers file for customizing the installer.  #packstack --gen-answer-file /root/answers.txt  Update the packstack answers file. Add the second host (in this case 192.168.122.82) to list of network hosts.  #vi /root/answers.txt  CONFIG_NETWORK_HOSTS=192.168.122.81,192.168.122.82  CONFIG_KEYSTONE_ADMIN_PW=redhat  CONFIG_HORIZON_SSL=y  CONFIG_PROVISION_DEMO=n  CONFIG_HEAT_INSTALL=y  CONFIG_HEAT_CLOUDWATCH_INSTALL=y  CONFIG_HEAT_CFN_INSTALL=y  CONFIG_SAHARA_INSTALL=y  CONFIG_TROVE_INSTALL=y  CONFIG_CEILOMETER_INSTALL=y  CONFIG_LBAAS_INSTALL=y  Install OpenStack using packstack from RDO.  #packstack --answer-file /root/answers.txt . /root/keystonerc_admin  Check status of openstack services.  #openstack-status [Controller and Network nodes]  Backup the ifcfg-etho script.  #cp /etc/sysconfig/network-scripts/ifcfg-eth0 /root/  Configure external bridge for floating ip networks.  #vi /etc/sysconfig/network-scripts/ifcfg-eth0  DEVICE=eth0  ONBOOT=yes  TYPE=OVSPort  DEVICETYPE=ovs  OVS_BRIDGE=br-ex #vi /etc/sysconfig/network-scripts/ifcfg-br-ex  DEVICE=br-ex  BOOTPROTO=static  ONBOOT=yes  TYPE=OVSBridge  DEVICETYPE=ovs  USERCTL=yes  PEERDNS=yes  IPV6INIT=no  IPADDR=&lt;www.xxx.yyy.zzz&gt;  NETMASK=255.255.255.0  GATEWAY=&lt;GW IP&gt;  DNS1=&lt;DNS IP&gt;  Add the eht0 physical interface to the br-ex bridge in openVswitch for floating IP networks.  #ovs-vsctl add-port br-ex eth0 ; systemctl restart network.service &nbsp; Configure L3 HA [Controller node]  Configure common settings and enable L3 HA.  #openstack-config --set /etc/neutron/neutron.conf DEFAULT l3_ha True">


  <meta name="author" content="Keith Tenzer">
  
  <meta property="article:author" content="Keith Tenzer">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Keith Tenzer's Blog">
<meta property="og:title" content="OpenStack Neutron: Configuring L3 HA">
<meta property="og:url" content="http://localhost:4000/openstack/openstack-neutron-configuring-l3-ha/">


  <meta property="og:description" content="Overview In this article we will look at how to setup L3 HA in OpenStack Neutron. OpenStack networking can be rather complex, certainly when coming from a traditional networking world. The basic principles behind networking have not changed but OpenStack introduces lots of abstractions that make end-to-end visibility of network traffic flows very difficult to follow. As such before we get into the material it would be good to provide an overview of L3 as it pertains to OpenStack Neutron.  In Neutron L3 allows you to provide external connectivity to instances running in tenant networks that by nature are non-routable. Tenant networks are L2 networks and as such can only communicate with instances on same tenant network. L3 is implemented in Neutron using floating ip addresses. A floating ip is a address of an external network that uses NAT (SNAT/DNAT) to forward traffic to instance ip on tenant network. The below diagram illustrates this connectivity.  In this case we have two networks, a tenant network 10.10.1.0/24 named private and an external network 192.168.122.0/24 named public. The instance mycirros has the ip of 10.10.1.102. In order to communicate with other instances or devices outside the tenant network 10.10.1.0/24 an L3 router is required. Note that floating ips are only associated to an instance, the instance itself is completely unaware of floating ip. If you were to do an &quot;ip a&quot; on an instance you would not see the floating ip. Neutron implements NAT (SNAT/DNAT) in order to forward traffic between instance ip and floating ip using iptables rules. Since these rules can only be configured on a single network node per floating ip we have a problem. If that network node is lost then external connectivity will be interrupted to those instances. Neutron solves this problem with L3 HA. In L3 HA you configure multiple network nodes and on each the Open vSwitch (OVS) agent plugin. In event that a network node is lost, the HA router will failover to a standy on another node and connectivity will not be interrupted for those instances. Neutron ml2 plugins exist for many different SDN solutions not just OVS. Out-of-the-box OVS is of course provided. If you are using another SDN then you most likely would not care about L3 HA within Neutron since you wouldn&#39;t use the L3 agent but rather the SDN plugin and the SDN would provide its own HA solution. Install and Configure OpenStack Kilo In this example we will configure two systems running RHEL or CentOS 7.1. We will use RDO (packstack) to deploy OpenStack Kilo. In OpenStack there are different roles a node can have: controller, network, compute and storage. Things can be customized to even break out individual services like keystone. We will deploy one node as a controller, compute and network node. The second node will only be a network node. This is the minimum configuration required to configure L3 HA since you need two network nodes. [Controller node]  Install RHEL or CentOS 7.1. Ensure name resolution is working  #vi /etc/hosts 192.168.122.81 osp7-ctr1.lab.com osp7-ctr1  Ensure the hostname is set statically.  #hostnamectl set-hostname osp7-ctr1.lab.com  Disable network manager.  #systemctl disable NetworkManager.service  Disable firewalld to make configuration easier.   #systemctl disable firewalld.service  For RHEL systems register with subscription manager.   #subscription-manager register  #subscription-manager subscribe --auto  #subscription-manager repos --disable=*  #subscription-manager repos --enable=rhel-7-server-rpms  #subscription-manager repos --enable=rhel-7-server-openstack-7.0-rpms  Install yum-utils and update the system.   #yum install -y yum-utils  #yum update -y  #reboot [Network node]  Install RHEL or CentOS 7.1. Ensure name resolution is working  #vi /etc/hosts 192.168.122.82 osp7-net1.lab.com osp7-net1  Ensure the hostname is set statically.  #hostnamectl set-hostname osp7-net1.lab.com  Disable network manager.  #systemctl disable NetworkManager.service  Disable firewalld to make configuration easier.   #systemctl disable firewalld.service  For RHEL systems register with subscription manager.   #subscription-manager register  #subscription-manager subscribe --auto  #subscription-manager repos --disable=*  #subscription-manager repos --enable=rhel-7-server-rpms  #subscription-manager repos --enable=rhel-7-server-openstack-7.0-rpms  Install yum-utils and update the system.   #yum install -y yum-utils  #yum update -y  #reboot [Controller node]  Install packstack packages.   #yum install -y openstack-packstack  Create packstack answers file for customizing the installer.  #packstack --gen-answer-file /root/answers.txt  Update the packstack answers file. Add the second host (in this case 192.168.122.82) to list of network hosts.  #vi /root/answers.txt  CONFIG_NETWORK_HOSTS=192.168.122.81,192.168.122.82  CONFIG_KEYSTONE_ADMIN_PW=redhat  CONFIG_HORIZON_SSL=y  CONFIG_PROVISION_DEMO=n  CONFIG_HEAT_INSTALL=y  CONFIG_HEAT_CLOUDWATCH_INSTALL=y  CONFIG_HEAT_CFN_INSTALL=y  CONFIG_SAHARA_INSTALL=y  CONFIG_TROVE_INSTALL=y  CONFIG_CEILOMETER_INSTALL=y  CONFIG_LBAAS_INSTALL=y  Install OpenStack using packstack from RDO.  #packstack --answer-file /root/answers.txt . /root/keystonerc_admin  Check status of openstack services.  #openstack-status [Controller and Network nodes]  Backup the ifcfg-etho script.  #cp /etc/sysconfig/network-scripts/ifcfg-eth0 /root/  Configure external bridge for floating ip networks.  #vi /etc/sysconfig/network-scripts/ifcfg-eth0  DEVICE=eth0  ONBOOT=yes  TYPE=OVSPort  DEVICETYPE=ovs  OVS_BRIDGE=br-ex #vi /etc/sysconfig/network-scripts/ifcfg-br-ex  DEVICE=br-ex  BOOTPROTO=static  ONBOOT=yes  TYPE=OVSBridge  DEVICETYPE=ovs  USERCTL=yes  PEERDNS=yes  IPV6INIT=no  IPADDR=&lt;www.xxx.yyy.zzz&gt;  NETMASK=255.255.255.0  GATEWAY=&lt;GW IP&gt;  DNS1=&lt;DNS IP&gt;  Add the eht0 physical interface to the br-ex bridge in openVswitch for floating IP networks.  #ovs-vsctl add-port br-ex eth0 ; systemctl restart network.service &nbsp; Configure L3 HA [Controller node]  Configure common settings and enable L3 HA.  #openstack-config --set /etc/neutron/neutron.conf DEFAULT l3_ha True">





  <meta name="twitter:site" content="@keithtenzer">
  <meta name="twitter:title" content="OpenStack Neutron: Configuring L3 HA">
  <meta name="twitter:description" content="Overview In this article we will look at how to setup L3 HA in OpenStack Neutron. OpenStack networking can be rather complex, certainly when coming from a traditional networking world. The basic principles behind networking have not changed but OpenStack introduces lots of abstractions that make end-to-end visibility of network traffic flows very difficult to follow. As such before we get into the material it would be good to provide an overview of L3 as it pertains to OpenStack Neutron.  In Neutron L3 allows you to provide external connectivity to instances running in tenant networks that by nature are non-routable. Tenant networks are L2 networks and as such can only communicate with instances on same tenant network. L3 is implemented in Neutron using floating ip addresses. A floating ip is a address of an external network that uses NAT (SNAT/DNAT) to forward traffic to instance ip on tenant network. The below diagram illustrates this connectivity.  In this case we have two networks, a tenant network 10.10.1.0/24 named private and an external network 192.168.122.0/24 named public. The instance mycirros has the ip of 10.10.1.102. In order to communicate with other instances or devices outside the tenant network 10.10.1.0/24 an L3 router is required. Note that floating ips are only associated to an instance, the instance itself is completely unaware of floating ip. If you were to do an &quot;ip a&quot; on an instance you would not see the floating ip. Neutron implements NAT (SNAT/DNAT) in order to forward traffic between instance ip and floating ip using iptables rules. Since these rules can only be configured on a single network node per floating ip we have a problem. If that network node is lost then external connectivity will be interrupted to those instances. Neutron solves this problem with L3 HA. In L3 HA you configure multiple network nodes and on each the Open vSwitch (OVS) agent plugin. In event that a network node is lost, the HA router will failover to a standy on another node and connectivity will not be interrupted for those instances. Neutron ml2 plugins exist for many different SDN solutions not just OVS. Out-of-the-box OVS is of course provided. If you are using another SDN then you most likely would not care about L3 HA within Neutron since you wouldn&#39;t use the L3 agent but rather the SDN plugin and the SDN would provide its own HA solution. Install and Configure OpenStack Kilo In this example we will configure two systems running RHEL or CentOS 7.1. We will use RDO (packstack) to deploy OpenStack Kilo. In OpenStack there are different roles a node can have: controller, network, compute and storage. Things can be customized to even break out individual services like keystone. We will deploy one node as a controller, compute and network node. The second node will only be a network node. This is the minimum configuration required to configure L3 HA since you need two network nodes. [Controller node]  Install RHEL or CentOS 7.1. Ensure name resolution is working  #vi /etc/hosts 192.168.122.81 osp7-ctr1.lab.com osp7-ctr1  Ensure the hostname is set statically.  #hostnamectl set-hostname osp7-ctr1.lab.com  Disable network manager.  #systemctl disable NetworkManager.service  Disable firewalld to make configuration easier.   #systemctl disable firewalld.service  For RHEL systems register with subscription manager.   #subscription-manager register  #subscription-manager subscribe --auto  #subscription-manager repos --disable=*  #subscription-manager repos --enable=rhel-7-server-rpms  #subscription-manager repos --enable=rhel-7-server-openstack-7.0-rpms  Install yum-utils and update the system.   #yum install -y yum-utils  #yum update -y  #reboot [Network node]  Install RHEL or CentOS 7.1. Ensure name resolution is working  #vi /etc/hosts 192.168.122.82 osp7-net1.lab.com osp7-net1  Ensure the hostname is set statically.  #hostnamectl set-hostname osp7-net1.lab.com  Disable network manager.  #systemctl disable NetworkManager.service  Disable firewalld to make configuration easier.   #systemctl disable firewalld.service  For RHEL systems register with subscription manager.   #subscription-manager register  #subscription-manager subscribe --auto  #subscription-manager repos --disable=*  #subscription-manager repos --enable=rhel-7-server-rpms  #subscription-manager repos --enable=rhel-7-server-openstack-7.0-rpms  Install yum-utils and update the system.   #yum install -y yum-utils  #yum update -y  #reboot [Controller node]  Install packstack packages.   #yum install -y openstack-packstack  Create packstack answers file for customizing the installer.  #packstack --gen-answer-file /root/answers.txt  Update the packstack answers file. Add the second host (in this case 192.168.122.82) to list of network hosts.  #vi /root/answers.txt  CONFIG_NETWORK_HOSTS=192.168.122.81,192.168.122.82  CONFIG_KEYSTONE_ADMIN_PW=redhat  CONFIG_HORIZON_SSL=y  CONFIG_PROVISION_DEMO=n  CONFIG_HEAT_INSTALL=y  CONFIG_HEAT_CLOUDWATCH_INSTALL=y  CONFIG_HEAT_CFN_INSTALL=y  CONFIG_SAHARA_INSTALL=y  CONFIG_TROVE_INSTALL=y  CONFIG_CEILOMETER_INSTALL=y  CONFIG_LBAAS_INSTALL=y  Install OpenStack using packstack from RDO.  #packstack --answer-file /root/answers.txt . /root/keystonerc_admin  Check status of openstack services.  #openstack-status [Controller and Network nodes]  Backup the ifcfg-etho script.  #cp /etc/sysconfig/network-scripts/ifcfg-eth0 /root/  Configure external bridge for floating ip networks.  #vi /etc/sysconfig/network-scripts/ifcfg-eth0  DEVICE=eth0  ONBOOT=yes  TYPE=OVSPort  DEVICETYPE=ovs  OVS_BRIDGE=br-ex #vi /etc/sysconfig/network-scripts/ifcfg-br-ex  DEVICE=br-ex  BOOTPROTO=static  ONBOOT=yes  TYPE=OVSBridge  DEVICETYPE=ovs  USERCTL=yes  PEERDNS=yes  IPV6INIT=no  IPADDR=&lt;www.xxx.yyy.zzz&gt;  NETMASK=255.255.255.0  GATEWAY=&lt;GW IP&gt;  DNS1=&lt;DNS IP&gt;  Add the eht0 physical interface to the br-ex bridge in openVswitch for floating IP networks.  #ovs-vsctl add-port br-ex eth0 ; systemctl restart network.service &nbsp; Configure L3 HA [Controller node]  Configure common settings and enable L3 HA.  #openstack-config --set /etc/neutron/neutron.conf DEFAULT l3_ha True">
  <meta name="twitter:url" content="http://localhost:4000/openstack/openstack-neutron-configuring-l3-ha/">

  
    <meta name="twitter:card" content="summary">
    
  

  



  <meta property="article:published_time" content="2016-04-25T00:00:00-07:00">





  

  


<link rel="canonical" href="http://localhost:4000/openstack/openstack-neutron-configuring-l3-ha/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "Keith Tenzer",
      "url": "http://localhost:4000/"
    
  }
</script>







<!-- end _includes/seo.html -->



  <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Keith Tenzer's Blog Feed">


<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css">

<!--[if IE]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->


    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single wide">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
          Keith Tenzer's Blog
          <span class="site-subtitle">Cloud Computing and Code</span>
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/about/index.html">About</a>
            </li><li class="masthead__menu-item">
              <a href="/conferences-and-events/index.html">Conferences and Events</a>
            </li><li class="masthead__menu-item">
              <a href="/videos/index.html">Videos</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <svg class="icon" width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15.99 16">
            <path d="M15.5,13.12L13.19,10.8a1.69,1.69,0,0,0-1.28-.55l-0.06-.06A6.5,6.5,0,0,0,5.77,0,6.5,6.5,0,0,0,2.46,11.59a6.47,6.47,0,0,0,7.74.26l0.05,0.05a1.65,1.65,0,0,0,.5,1.24l2.38,2.38A1.68,1.68,0,0,0,15.5,13.12ZM6.4,2A4.41,4.41,0,1,1,2,6.4,4.43,4.43,0,0,1,6.4,2Z" transform="translate(-.01)"></path>
          </svg>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      


  
    



<nav class="breadcrumbs">
  <ol itemscope itemtype="https://schema.org/BreadcrumbList">
    
    
    
      
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="http://localhost:4000/" itemprop="item"><span itemprop="name">Home</span></a>
          <meta itemprop="position" content="1" />
        </li>
        <span class="sep">/</span>
      
      
        
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="/categories/#openstack" itemprop="item"><span itemprop="name">Openstack</span></a>
          <meta itemprop="position" content="2" />
        </li>
        <span class="sep">/</span>
      
    
      
      
        <li class="current">OpenStack Neutron: Configuring L3 HA</li>
      
    
  </ol>
</nav>

  


<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      
        <img src="/assets/main/me.png" alt="Keith Tenzer" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">Keith Tenzer</h3>
    
    
      <div class="author__bio" itemprop="description">
        <p>Principal Solutions Architect at Red Hat</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">Los Angeles, CA</span>
        </li>
      

      
        
          
        
          
        
          
            <li><a href="https://twitter.com/keithtenzer" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i><span class="label">Twitter</span></a></li>
          
        
          
        
          
            <li><a href="https://github.com/ktenzer" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span></a></li>
          
        
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="OpenStack Neutron: Configuring L3 HA">
    <meta itemprop="description" content="OverviewIn this article we will look at how to setup L3 HA in OpenStack Neutron. OpenStack networking can be rather complex, certainly when coming from a traditional networking world. The basic principles behind networking have not changed but OpenStack introduces lots of abstractions that make end-to-end visibility of network traffic flows very difficult to follow. As such before we get into the material it would be good to provide an overview of L3 as it pertains to OpenStack Neutron.In Neutron L3 allows you to provide external connectivity to instances running in tenant networks that by nature are non-routable. Tenant networks are L2 networks and as such can only communicate with instances on same tenant network. L3 is implemented in Neutron using floating ip addresses. A floating ip is a address of an external network that uses NAT (SNAT/DNAT) to forward traffic to instance ip on tenant network. The below diagram illustrates this connectivity.In this case we have two networks, a tenant network 10.10.1.0/24 named private and an external network 192.168.122.0/24 named public. The instance mycirros has the ip of 10.10.1.102. In order to communicate with other instances or devices outside the tenant network 10.10.1.0/24 an L3 router is required. Note that floating ips are only associated to an instance, the instance itself is completely unaware of floating ip. If you were to do an &quot;ip a&quot; on an instance you would not see the floating ip. Neutron implements NAT (SNAT/DNAT) in order to forward traffic between instance ip and floating ip using iptables rules. Since these rules can only be configured on a single network node per floating ip we have a problem. If that network node is lost then external connectivity will be interrupted to those instances.Neutron solves this problem with L3 HA. In L3 HA you configure multiple network nodes and on each the Open vSwitch (OVS) agent plugin. In event that a network node is lost, the HA router will failover to a standy on another node and connectivity will not be interrupted for those instances. Neutron ml2 plugins exist for many different SDN solutions not just OVS. Out-of-the-box OVS is of course provided. If you are using another SDN then you most likely would not care about L3 HA within Neutron since you wouldn&#39;t use the L3 agent but rather the SDN plugin and the SDN would provide its own HA solution.Install and Configure OpenStack KiloIn this example we will configure two systems running RHEL or CentOS 7.1. We will use RDO (packstack) to deploy OpenStack Kilo. In OpenStack there are different roles a node can have: controller, network, compute and storage. Things can be customized to even break out individual services like keystone. We will deploy one node as a controller, compute and network node. The second node will only be a network node. This is the minimum configuration required to configure L3 HA since you need two network nodes.[Controller node]Install RHEL or CentOS 7.1.Ensure name resolution is working#vi /etc/hosts192.168.122.81 osp7-ctr1.lab.com osp7-ctr1Ensure the hostname is set statically.#hostnamectl set-hostname osp7-ctr1.lab.comDisable network manager.#systemctl disable NetworkManager.serviceDisable firewalld to make configuration easier. #systemctl disable firewalld.serviceFor RHEL systems register with subscription manager. #subscription-manager register #subscription-manager subscribe --auto #subscription-manager repos --disable=* #subscription-manager repos --enable=rhel-7-server-rpms #subscription-manager repos --enable=rhel-7-server-openstack-7.0-rpmsInstall yum-utils and update the system. #yum install -y yum-utils #yum update -y #reboot[Network node]Install RHEL or CentOS 7.1.Ensure name resolution is working#vi /etc/hosts192.168.122.82 osp7-net1.lab.com osp7-net1Ensure the hostname is set statically.#hostnamectl set-hostname osp7-net1.lab.comDisable network manager.#systemctl disable NetworkManager.serviceDisable firewalld to make configuration easier. #systemctl disable firewalld.serviceFor RHEL systems register with subscription manager. #subscription-manager register #subscription-manager subscribe --auto #subscription-manager repos --disable=* #subscription-manager repos --enable=rhel-7-server-rpms #subscription-manager repos --enable=rhel-7-server-openstack-7.0-rpmsInstall yum-utils and update the system. #yum install -y yum-utils #yum update -y #reboot[Controller node]Install packstack packages. #yum install -y openstack-packstackCreate packstack answers file for customizing the installer.#packstack --gen-answer-file /root/answers.txtUpdate the packstack answers file. Add the second host (in this case 192.168.122.82) to list of network hosts.#vi /root/answers.txt CONFIG_NETWORK_HOSTS=192.168.122.81,192.168.122.82 CONFIG_KEYSTONE_ADMIN_PW=redhat CONFIG_HORIZON_SSL=y CONFIG_PROVISION_DEMO=n CONFIG_HEAT_INSTALL=y CONFIG_HEAT_CLOUDWATCH_INSTALL=y CONFIG_HEAT_CFN_INSTALL=y CONFIG_SAHARA_INSTALL=y CONFIG_TROVE_INSTALL=y CONFIG_CEILOMETER_INSTALL=y CONFIG_LBAAS_INSTALL=yInstall OpenStack using packstack from RDO.#packstack --answer-file /root/answers.txt. /root/keystonerc_adminCheck status of openstack services.#openstack-status[Controller and Network nodes]Backup the ifcfg-etho script.#cp /etc/sysconfig/network-scripts/ifcfg-eth0 /root/Configure external bridge for floating ip networks.#vi /etc/sysconfig/network-scripts/ifcfg-eth0 DEVICE=eth0 ONBOOT=yes TYPE=OVSPort DEVICETYPE=ovs OVS_BRIDGE=br-ex#vi /etc/sysconfig/network-scripts/ifcfg-br-ex DEVICE=br-ex BOOTPROTO=static ONBOOT=yes TYPE=OVSBridge DEVICETYPE=ovs USERCTL=yes PEERDNS=yes IPV6INIT=no IPADDR=&lt;www.xxx.yyy.zzz&gt; NETMASK=255.255.255.0 GATEWAY=&lt;GW IP&gt; DNS1=&lt;DNS IP&gt;Add the eht0 physical interface to the br-ex bridge in openVswitch for floating IP networks.#ovs-vsctl add-port br-ex eth0 ; systemctl restart network.service&nbsp;Configure L3 HA[Controller node]Configure common settings and enable L3 HA.#openstack-config --set /etc/neutron/neutron.conf DEFAULT l3_ha True">
    <meta itemprop="datePublished" content="2016-04-25T00:00:00-07:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">OpenStack Neutron: Configuring L3 HA
</h1>
          

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-calendar-alt" aria-hidden="true"></i>
        
        <time datetime="2016-04-25T00:00:00-07:00">April 25, 2016</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          19 minute read
        
      </span>
    
  </p>


        </header>
      

      <section class="page__content" itemprop="text">
        
        <h3><img class="alignnone size-full wp-image-2249" src="/assets/2016/04/networking.jpg" alt="Networking" width="460" height="240" /></h3>
<h3>Overview</h3>
<p>In this article we will look at how to setup L3 HA in OpenStack Neutron. OpenStack networking can be rather complex, certainly when coming from a traditional networking world. The basic principles behind networking have not changed but OpenStack introduces lots of abstractions that make end-to-end visibility of network traffic flows very difficult to follow. As such before we get into the material it would be good to provide an overview of L3 as it pertains to OpenStack Neutron.<br />
<!--more--></p>
<p>In Neutron L3 allows you to provide external connectivity to instances running in tenant networks that by nature are non-routable. Tenant networks are L2 networks and as such can only communicate with instances on same tenant network. L3 is implemented in Neutron using floating ip addresses. A floating ip is a address of an external network that uses NAT (SNAT/DNAT) to forward traffic to instance ip on tenant network. The below diagram illustrates this connectivity.</p>
<p><img class="alignnone size-full wp-image-2186" src="/assets/2016/04/screenshot-from-2016-04-25-120516.png" alt="Screenshot from 2016-04-25 12:05:16" width="513" height="523" /></p>
<p>In this case we have two networks, a tenant network 10.10.1.0/24 named private and an external network 192.168.122.0/24 named public. The instance mycirros has the ip of 10.10.1.102. In order to communicate with other instances or devices outside the tenant network 10.10.1.0/24 an L3 router is required. Note that floating ips are only associated to an instance, the instance itself is completely unaware of floating ip. If you were to do an "ip a" on an instance you would not see the floating ip. Neutron implements NAT (SNAT/DNAT) in order to forward traffic between instance ip and floating ip using iptables rules. Since these rules can only be configured on a single network node per floating ip we have a problem. If that network node is lost then external connectivity will be interrupted to those instances.</p>
<p>Neutron solves this problem with L3 HA. In L3 HA you configure multiple network nodes and on each the Open vSwitch (OVS) agent plugin. In event that a network node is lost, the HA router will failover to a standy on another node and connectivity will not be interrupted for those instances. Neutron ml2 plugins exist for many different SDN solutions not just OVS. Out-of-the-box OVS is of course provided. If you are using another SDN then you most likely would not care about L3 HA within Neutron since you wouldn't use the L3 agent but rather the SDN plugin and the SDN would provide its own HA solution.</p>
<h3>Install and Configure OpenStack Kilo</h3>
<p>In this example we will configure two systems running RHEL or CentOS 7.1. We will use RDO (packstack) to deploy OpenStack Kilo. In OpenStack there are different roles a node can have: controller, network, compute and storage. Things can be customized to even break out individual services like keystone. We will deploy one node as a controller, compute and network node. The second node will only be a network node. This is the minimum configuration required to configure L3 HA since you need two network nodes.</p>
<p>[Controller node]</p>
<ul>
<li>Install RHEL or CentOS 7.1.</li>
<li>Ensure name resolution is working</li>
</ul>
<pre style="padding-left:30px;">#vi /etc/hosts</pre>
<pre style="padding-left:30px;">192.168.122.81 osp7-ctr1.lab.com osp7-ctr1</pre>
<ul>
<li>Ensure the hostname is set statically.</li>
</ul>
<pre style="padding-left:30px;">#hostnamectl set-hostname osp7-ctr1.lab.com</pre>
<ul>
<li>Disable network manager.</li>
</ul>
<pre style="padding-left:30px;">#systemctl disable NetworkManager.service</pre>
<ul>
<li>Disable firewalld to make configuration easier.</li>
</ul>
<pre style="padding-left:30px;"> #systemctl disable firewalld.service</pre>
<ul>
<li>For RHEL systems register with subscription manager.</li>
</ul>
<pre style="padding-left:30px;"> #subscription-manager register
 #subscription-manager subscribe --auto
 #subscription-manager repos --disable=*
 #subscription-manager repos --enable=rhel-7-server-rpms
 #subscription-manager repos --enable=rhel-7-server-openstack-7.0-rpms</pre>
<ul>
<li>Install yum-utils and update the system.</li>
</ul>
<pre style="padding-left:30px;"> #yum install -y yum-utils
 #yum update -y
 #reboot</pre>
<p>[Network node]</p>
<ul>
<li>Install RHEL or CentOS 7.1.</li>
<li>Ensure name resolution is working</li>
</ul>
<pre style="padding-left:30px;">#vi /etc/hosts</pre>
<pre style="padding-left:30px;">192.168.122.82 osp7-net1.lab.com osp7-net1</pre>
<ul>
<li>Ensure the hostname is set statically.</li>
</ul>
<pre style="padding-left:30px;">#hostnamectl set-hostname osp7-net1.lab.com</pre>
<ul>
<li>Disable network manager.</li>
</ul>
<pre style="padding-left:30px;">#systemctl disable NetworkManager.service</pre>
<ul>
<li>Disable firewalld to make configuration easier.</li>
</ul>
<pre style="padding-left:30px;"> #systemctl disable firewalld.service</pre>
<ul>
<li>For RHEL systems register with subscription manager.</li>
</ul>
<pre style="padding-left:30px;"> #subscription-manager register
 #subscription-manager subscribe --auto
 #subscription-manager repos --disable=*
 #subscription-manager repos --enable=rhel-7-server-rpms
 #subscription-manager repos --enable=rhel-7-server-openstack-7.0-rpms</pre>
<ul>
<li>Install yum-utils and update the system.</li>
</ul>
<pre style="padding-left:30px;"> #yum install -y yum-utils
 #yum update -y
 #reboot</pre>
<p>[Controller node]</p>
<ul>
<li>Install packstack packages.</li>
</ul>
<pre style="padding-left:30px;"> #yum install -y openstack-packstack</pre>
<ul>
<li>Create packstack answers file for customizing the installer.</li>
</ul>
<pre style="padding-left:30px;">#packstack --gen-answer-file /root/answers.txt</pre>
<ul>
<li>Update the packstack answers file. Add the second host (in this case 192.168.122.82) to list of network hosts.</li>
</ul>
<pre style="padding-left:30px;">#vi /root/answers.txt
 CONFIG_NETWORK_HOSTS=192.168.122.81,192.168.122.82
 CONFIG_KEYSTONE_ADMIN_PW=redhat
 CONFIG_HORIZON_SSL=y
 CONFIG_PROVISION_DEMO=n
 CONFIG_HEAT_INSTALL=y
 CONFIG_HEAT_CLOUDWATCH_INSTALL=y
 CONFIG_HEAT_CFN_INSTALL=y
 CONFIG_SAHARA_INSTALL=y
 CONFIG_TROVE_INSTALL=y
 CONFIG_CEILOMETER_INSTALL=y
 CONFIG_LBAAS_INSTALL=y</pre>
<ul>
<li>Install OpenStack using packstack from RDO.</li>
</ul>
<pre style="padding-left:30px;">#packstack --answer-file /root/answers.txt</pre>
<pre style="padding-left:30px;">. /root/keystonerc_admin</pre>
<ul>
<li>Check status of openstack services.</li>
</ul>
<pre style="padding-left:30px;">#openstack-status</pre>
<p>[Controller and Network nodes]</p>
<ul>
<li>Backup the ifcfg-etho script.</li>
</ul>
<pre style="padding-left:30px;">#cp /etc/sysconfig/network-scripts/ifcfg-eth0 /root/</pre>
<ul>
<li>Configure external bridge for floating ip networks.</li>
</ul>
<pre style="padding-left:30px;">#vi /etc/sysconfig/network-scripts/ifcfg-eth0
 DEVICE=eth0
 ONBOOT=yes
 TYPE=OVSPort
 DEVICETYPE=ovs
 OVS_BRIDGE=br-ex</pre>
<pre style="padding-left:30px;">#vi /etc/sysconfig/network-scripts/ifcfg-br-ex
 DEVICE=br-ex
 BOOTPROTO=static
 ONBOOT=yes
 TYPE=OVSBridge
 DEVICETYPE=ovs
 USERCTL=yes
 PEERDNS=yes
 IPV6INIT=no
 IPADDR=&lt;www.xxx.yyy.zzz&gt;
 NETMASK=255.255.255.0
 GATEWAY=&lt;GW IP&gt;
 DNS1=&lt;DNS IP&gt;</pre>
<ul>
<li>Add the eht0 physical interface to the br-ex bridge in openVswitch for floating IP networks.</li>
</ul>
<pre style="padding-left:30px;">#ovs-vsctl add-port br-ex eth0 ; systemctl restart network.service</pre>
<p>&nbsp;</p>
<h3>Configure L3 HA</h3>
<p>[Controller node]</p>
<ul>
<li>Configure common settings and enable L3 HA.</li>
</ul>
<pre style="padding-left:30px;">#openstack-config --set /etc/neutron/neutron.conf DEFAULT l3_ha True

#openstack-config --set /etc/neutron/neutron.conf DEFAULT l3_ha_net_cidr 168.254.192.0/18

#openstack-config --set /etc/neutron/neutron.conf DEFAULT max_l3_agents_per_router 3

#openstack-config --set /etc/neutron/neutron.conf DEFAULT min_l3_agents_per_router 2

#openstack-config --set /etc/neutron/neutron.conf DEFAULT dhcp_agents_per_network 2</pre>
<p>[Controller node]</p>
<ul>
<li>Configure ml2 plugin.</li>
</ul>
<pre style="padding-left:30px;">#openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ml2 type_drivers flat,vlan,gre,vxlan

#openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ml2 tenant_network_types vxlan,vlan,gre

#openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ml2 mechanism_drivers openvswitch,l2population

#openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ml2 extension_drivers port_security

#openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ml2_type_flat flat_networks external

#openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ml2_type_vlan network_vlan_ranges datacenter:1000:2999

#openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ml2_type_gre tunnel_id_ranges 10:100

#openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ml2_type_vxlan vni_ranges 10:100

#openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini securitygroup enable_ipset True

#openstack-service restart neutron</pre>
<ul>
<li>Configure OVS Agent on Network node.</li>
</ul>
<p>[Network node]</p>
<pre style="padding-left:30px;">#openstack-config --set /etc/neutron/plugins/openvswitch/ovs_neutron_plugin.ini ovs bridge_mappings external:br-ex

#openstack-config --set /etc/neutron/plugins/openvswitch/ovs_neutron_plugin.ini agent tunnel_types vxlan,gre

#openstack-config --set /etc/neutron/plugins/openvswitch/ovs_neutron_plugin.ini agent l2_population True

#openstack-config --set /etc/neutron/plugins/openvswitch/ovs_neutron_plugin.ini agent prevent_arp_spoofing True

#openstack-config --set /etc/neutron/plugins/openvswitch/ovs_neutron_plugin.ini securitygroup firewall_driver neutron.agent.linux.iptables_firewall.OVSHybridIptablesFirewallDriver

#openstack-config --set /etc/neutron/plugins/openvswitch/ovs_neutron_plugin.ini securitygroup enable_security_group True</pre>
<ul>
<li>Configure L3 Agent on Network nodes.</li>
</ul>
<p>[Network node]</p>
<pre style="padding-left:30px;">#openstack-config --set /etc/neutron/l3_agent.ini DEFAULT interface_driver neutron.agent.linux.interface.OVSInterfaceDriver

#openstack-config --set /etc/neutron/l3_agent.ini DEFAULT use_namespaces True

#openstack-config --set /etc/neutron/l3_agent.ini DEFAULT external_network_bridge ""

#openstack-config --set /etc/neutron/l3_agent.ini DEFAULT agent_mode legacy</pre>
<ul>
<li>Configure DHCP agent on Network nodes.</li>
</ul>
<p>[Network node]</p>
<pre style="padding-left:30px;">#openstack-config --set /etc/neutron/dhcp_agent.ini DEFAULT interface_driver neutron.agent.linux.interface.OVSInterfaceDriver

#openstack-config --set /etc/neutron/dhcp_agent.ini DEFAULT dhcp_driver neutron.agent.linux.dhcp.Dnsmasq

#openstack-config --set /etc/neutron/dhcp_agent.ini DEFAULT enable_isolated_metadata True

Ensure that the metadata IP is correct, should be IP of controller.

#openstack-config --get /etc/neutron/metadata_agent.ini DEFAULT nova_metadata_ip</pre>
<ul>
<li>Check shared secret for metadata agent.</li>
</ul>
<pre style="padding-left:30px;">#openstack-config --get /etc/neutron/metadata_agent.ini DEFAULT metadata_proxy_shared_secret</pre>
<ul>
<li>The output should match that of controller node.</li>
</ul>
<pre style="padding-left:30px;">#openstack-config --get /etc/nova/nova.conf neutron metadata_proxy_shared_secret</pre>
<ul>
<li>Restart Services.</li>
</ul>
<p>[Network node]</p>
<pre style="padding-left:30px;">#systemctl restart openvswitch

#systemctl restart neutron-openvswitch-agent

#systemctl restart neutron-l3-agent

#systemctl restart neutron-dhcp-agent

#systemctl restart neutron-metadata-agent</pre>
<ul>
<li>Configure OVS Agent on compute nodes. Note: since we are running compute on the controller node we already did this but in case you have separate compute nodes these steps would be required.</li>
</ul>
<p>[Compute node]</p>
<pre style="padding-left:30px;">#openstack-config --set /etc/neutron/plugins/ml2/openvswitch_agent.ini ovs bridge_mappings datacenter:br-vlan

#openstack-config --set /etc/neutron/plugins/ml2/openvswitch_agent.ini agent tunnel_types vxlan,gre

#openstack-config --set /etc/neutron/plugins/ml2/openvswitch_agent.ini agent l2_population False

#openstack-config --set /etc/neutron/plugins/ml2/openvswitch_agent.ini agentprevent_arp_spoofing True

#openstack-config --set /etc/neutron/plugins/ml2/openvswitch_agent.ini securitygroup firewall_driver neutron.agent.linux.iptables_firewall.OVSHybridIptablesFirewallDriver

#openstack-config --set /etc/neutron/plugins/ml2/openvswitch_agent.ini securitygroup enable_security_group True</pre>
<ul>
<li>Restart services.</li>
</ul>
<pre style="padding-left:30px;">#systemctl restart openvswitch

#systemctl restart neutron-openvswitch-agent</pre>
<ul>
<li>Verify Neutron agents are working.</li>
</ul>
<p>[Controller node]</p>
<pre style="padding-left:30px;">#source keystonerc_admin</pre>
<pre style="padding-left:30px;">#neutron agent-list
+--------------------------------------+--------------------+-------------------+-------+----------------+---------------------------+
| id | agent_type | host | alive | admin_state_up | binary |
+--------------------------------------+--------------------+-------------------+-------+----------------+---------------------------+
| 0bc9823c-30d8-479f-9690-2a2a99e6b099 | Open vSwitch agent | osp7-ctr2.lab.com | :-) | True | neutron-openvswitch-agent |
| 5d104819-f28f-4a3c-9e18-7dfad70d938d | L3 agent | osp7-ctr1.lab.com | :-) | True | neutron-l3-agent |
| 68c8f35c-47d0-4e84-b089-c0c01f0b7570 | L3 agent | osp7-net1.lab.com | :-) | True | neutron-l3-agent |
| 995ab293-af3b-4386-b041-eac98359a84f | DHCP agent | osp7-net1.lab.com | :-) | True | neutron-dhcp-agent |
| ab98e58a-162c-460f-a34d-a700375d65e4 | Loadbalancer agent | osp7-ctr1.lab.com | :-) | True | neutron-lbaas-agent |
| b7ca70c9-0d3d-4ba6-ad73-a7cd12bd29f9 | Open vSwitch agent | osp7-ctr1.lab.com | :-) | True | neutron-openvswitch-agent |
| d5220a38-ba15-4e29-850f-bdadafdc72c5 | DHCP agent | osp7-ctr1.lab.com | :-) | True | neutron-dhcp-agent |
| dd63e733-ef74-46c7-b59c-5d4684d93d1b | Metadata agent | osp7-net1.lab.com | :-) | True | neutron-metadata-agent |
| df9bc78b-558a-44c0-96bc-8dec4c0f5ec0 | Loadbalancer agent | osp7-net1.lab.com | :-) | True | neutron-lbaas-agent |
| f343cdb4-3d34-46ac-bd7e-ac1c7e98fa78 | Metadata agent | osp7-ctr1.lab.com | :-) | True | neutron-metadata-agent |
+--------------------------------------+--------------------+-------------------+-------+----------------+---------------------------+</pre>
<h3>Create Networks with HA router</h3>
<p>[Controller node]</p>
<ul>
<li>Create private network.</li>
</ul>
<pre style="padding-left:30px;">#neutron net-create private</pre>
<pre style="padding-left:30px;">#neutron subnet-create private 10.10.1.0/24 --name private_subnet --allocation-pool start=10.10.1.100,end=10.10.1.200</pre>
<ul>
<li>Create public network. Note: these steps assume the physical network connected to eth0 is 192.168.122.0/24.</li>
</ul>
<pre style="padding-left:30px;">#neutron net-create public --router:external</pre>
<pre style="padding-left:30px;">#neutron subnet-create public 192.168.122.0/24 --name public_subnet --allocation-pool start=192.168.122.100,end=192.168.122.200 --disable-dhcp --gateway 192.168.122.1</pre>
<ul>
<li>Add a new HA router and configure router interfaces.</li>
</ul>
<pre style="padding-left:30px;">#neutron router-create router1 --ha True</pre>
<pre style="padding-left:30px;">#<span class="GramE">neutron</span> router-gateway-set router1 public</pre>
<pre style="padding-left:30px;">#neutron router-interface-add router1 private_subnet</pre>
<ul>
<li>Check status of HA router router1 and ensure HA is enabled.</li>
</ul>
<pre style="padding-left:30px;">#neutron router-show router1
+-----------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Field | Value |
+-----------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| admin_state_up | True |
| distributed | False |
| external_gateway_info | {"network_id": "59307306-7592-42c3-bae9-add052644040", "enable_snat": true, "external_fixed_ips": [{"subnet_id": "cd2ba99a-6d61-4106-af6a-71a7615fe891", "ip_address": "192.168.122.100"}]} |
| ha | True |
| id | e7d9bf3c-22a7-4413-9e44-c1fb450f1432 |
| name | router1 |
| routes | |
| status | ACTIVE |
| tenant_id | e8fa02de88824e85a2b4fcf36c510d60 |
+-----------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</pre>
<ul>
<li>Check which network node is hosting the router.</li>
</ul>
<pre style="padding-left:30px;">#neutron l3-agent-list-hosting-router router1
+--------------------------------------+-------------------+----------------+-------+----------+
| id | host | admin_state_up | alive | ha_state |
+--------------------------------------+-------------------+----------------+-------+----------+
| 68c8f35c-47d0-4e84-b089-c0c01f0b7570 | osp7-net1.lab.com | True | :-) | active |
| 5d104819-f28f-4a3c-9e18-7dfad70d938d | osp7-ctr1.lab.com | True | :-) | standby |
+--------------------------------------+-------------------+----------------+-------+----------+</pre>
<ul>
<li>Upload a glance image. In this case we will use a Cirros image because it is small and thus good for testing OpenStack.</li>
</ul>
<pre style="padding-left:30px;">#glance image-create --name "Cirros 0.3.4" --disk-format qcow2 --container-format bare --is-public True --copy http://download.cirros-cloud.net/0.3.4/cirros-0.3.4-x86_64-disk.img</pre>
<ul>
<li>Create a new m1.nano flavor for running Cirros image.</li>
</ul>
<pre style="padding-left:30px;">#nova flavor-create m1.nano 42 64 0 1</pre>
<ul>
<li>Create security group and allow all TCP ports.</li>
</ul>
<pre style="padding-left:30px;">#nova secgroup-create all "Allow all tcp ports"</pre>
<pre style="padding-left:30px;">#nova secgroup-add-rule all TCP 1 65535 0.0.0.0/0</pre>
<ul>
<li>Create a private ssh key for connecting to instances remotely.</li>
</ul>
<pre style="padding-left:30px;">#nova keypair-add admin</pre>
<ul>
<li>Create admin.pem file and add private key from output of keypair-add command.</li>
</ul>
<pre style="padding-left:30px;">#vi /root/admin.pem</pre>
<pre style="padding-left:30px;">#chmod 400 /root/admin.pem</pre>
<ul>
<li>List the network IDs.</li>
</ul>
<pre style="padding-left:30px;">#neutron net-list
 +--------------------------------------+---------+-------------------------------------------------------+
 | id | name | subnets |
 +--------------------------------------+---------+-------------------------------------------------------+
 | d4f3ed19-8be4-4d56-9f95-cfbac9fdf670 | private | 92d82f53-6e0b-4eef-b8b9-cae32cf40457 10.10.1.0/24     |
 | 37c024d6-8108-468c-bc25-1748db7f5e8f | public  | 22f2e901-186f-4041-ad93-f7b5ccc30a81 192.168.122.0/24 |</pre>
<ul>
<li>Start an instance and make sure to replace network id from above command.</li>
</ul>
<pre style="padding-left:30px;">#nova boot --flavor m1.nano --image "Cirros 0.3.4" --nic net-id=e6c4e128-5a86-47a7-b501-737935680090 --key-name admin --security-groups all mycirros</pre>
<ul>
<li>Create a floating IP and assign it to the mycirros instance.</li>
</ul>
<pre style="padding-left:30px;">#nova floating-ip-create</pre>
<pre style="padding-left:30px;">#nova floating-ip-associate mycirros &lt;FLOATING IP&gt;</pre>
<ul>
<li>Connect to mycirros instance using the private ssh key stored in the admin.pem file.</li>
</ul>
<pre style="padding-left:30px;">#ssh -i admin.pem cirros@&lt;FLOATING IP&gt;</pre>
<ul>
<li>Check the HA router namespace on node that is shown as active for router.</li>
</ul>
<pre style="padding-left:30px;">#ip netns show

qdhcp-e6c4e128-5a86-47a7-b501-737935680090
qrouter-e7d9bf3c-22a7-4413-9e44-c1fb450f1432</pre>
<pre style="padding-left:30px;">#ip netns exec qrouter-e7d9bf3c-22a7-4413-9e44-c1fb450f1432 ip a
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN 
 link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
 inet 127.0.0.1/8 scope host lo
 valid_lft forever preferred_lft forever
 inet6 ::1/128 scope host 
 valid_lft forever preferred_lft forever
12: ha-e0a8c860-c8: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UNKNOWN 
 link/ether fa:16:3e:ec:02:6d brd ff:ff:ff:ff:ff:ff
 inet 168.254.192.1/18 brd 168.254.255.255 scope global ha-e0a8c860-c8
 valid_lft forever preferred_lft forever
 inet 169.254.0.1/24 scope global ha-e0a8c860-c8
 valid_lft forever preferred_lft forever
 inet6 fe80::f816:3eff:feec:26d/64 scope link 
 valid_lft forever preferred_lft forever
13: qr-4435cc42-ea: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UNKNOWN 
 link/ether fa:16:3e:c1:27:47 brd ff:ff:ff:ff:ff:ff
 inet 10.10.1.1/24 scope global qr-4435cc42-ea
 valid_lft forever preferred_lft forever
 inet6 fe80::f816:3eff:fec1:2747/64 scope link nodad 
 valid_lft forever preferred_lft forever
14: qg-04e11260-25: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UNKNOWN 
 link/ether fa:16:3e:bb:5a:9f brd ff:ff:ff:ff:ff:ff
 inet 192.168.122.100/24 scope global qg-04e11260-25
 valid_lft forever preferred_lft forever
 inet 192.168.122.101/32 scope global qg-04e11260-25
 valid_lft forever preferred_lft forever
 inet6 fe80::f816:3eff:febb:5a9f/64 scope link nodad 
 valid_lft forever preferred_lft forever</pre>
<p>Notice the difference between the router namespace for the standby node. The tenant and floating ips are only configured on the active router.</p>
<h3>Summary</h3>
<p>In this article we have discussed the use case around Neutron L3 HA and seen how to configure L3 HA. In Neutron Layer 3 is responsible for external connectivity to and from instances. Floating IPs using SNAT/DNAT are configured that allow external connectivity for non-routable tenant IPs. Neutron HA router is required to protect against failures on L3 agent node and possible interruption to Floating IP traffic.  The L3 HA router is mainly for OVS based networks, other SDNs will provide their own solutions for L3 HA. I hope you have found this article of use. If you have any feedback, please share.</p>
<p>Happy OpenStacking!</p>
<p>(c) 2016 Keith Tenzer</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>

        
      </section>

      <footer class="page__meta">
        
        
  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      <a href="/tags/#l3-ha" class="page__taxonomy-item" rel="tag">L3 HA</a><span class="sep">, </span>
    
      <a href="/tags/#neutron" class="page__taxonomy-item" rel="tag">neutron</a><span class="sep">, </span>
    
      <a href="/tags/#openstack" class="page__taxonomy-item" rel="tag">OpenStack</a><span class="sep">, </span>
    
      <a href="/tags/#ovs" class="page__taxonomy-item" rel="tag">OVS</a>
    
    </span>
  </p>




  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      <a href="/categories/#openstack" class="page__taxonomy-item" rel="tag">OpenStack</a>
    
    </span>
  </p>


        

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2016-04-25T00:00:00-07:00">April 25, 2016</time></p>


      </footer>

      <section class="page__share">
  
    <h4 class="page__share-title">Share on</h4>
  

  <a href="https://twitter.com/intent/tweet?via=keithtenzer&text=OpenStack+Neutron%3A+Configuring+L3+HA%20http%3A%2F%2Flocalhost%3A4000%2Fopenstack%2Fopenstack-neutron-configuring-l3-ha%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Flocalhost%3A4000%2Fopenstack%2Fopenstack-neutron-configuring-l3-ha%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=http%3A%2F%2Flocalhost%3A4000%2Fopenstack%2Fopenstack-neutron-configuring-l3-ha%2F" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/openshift/openshift-enterprise-3-1-lab-setup/" class="pagination--pager" title="OpenShift Enterprise 3.1 Lab Setup
">Previous</a>
    
    
      <a href="/ansible/openstack-heat-and-ansible-automation-born-in-the-cloud/" class="pagination--pager" title="OpenStack Heat and Ansible - Automation Born in the Cloud
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">You may also enjoy</h4>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/linux/blog-with-gitops-practices-and-github/" rel="permalink">Blog with Gitops Practices and GitHub
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i>
        
        <time datetime="2022-02-10T00:00:00-08:00">February 10, 2022</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-fw fa-clock" aria-hidden="true"></i>
        
          13 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Overview
Want to build your brand while living the gitops revolution and not paying anything for it? That is exactly what this article will walk you through....</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/linux/The-Fedora-Workstation-Experience/" rel="permalink">The Fedora Workstation Experience
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i>
        
        <time datetime="2022-01-10T00:00:00-08:00">January 10, 2022</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-fw fa-clock" aria-hidden="true"></i>
        
          10 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">
Overview
A lot of people always ask me what is the best way to contribute to opensource? Of course contributing code, documentation, spreading the gospel or...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/openshift/building-ansible-operators-1-2-3/" rel="permalink">Building Ansible Operators 1-2-3
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i>
        
        <time datetime="2021-12-03T00:00:00-08:00">December 3, 2021</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-fw fa-clock" aria-hidden="true"></i>
        
          10 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Overview
In this article we will go step by step to build a Kubernetes Operator using Ansible and the Operator Framework. Operators provide the ability to no...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/openshift/openshift-service-mesh-getting-started-guide/" rel="permalink">OpenShift Service Mesh Getting Started Guide
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i>
        
        <time datetime="2021-04-27T00:00:00-07:00">April 27, 2021</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-fw fa-clock" aria-hidden="true"></i>
        
          11 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">






Overview
In this article we will explore the OpenShift Service Mesh and deploy a demo application to better understand the various concepts. First you...</p>
  </article>
</div>

        
      </div>
    </div>
  
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    

    
      
        
          <li><a href="https://twitter.com/keithtenzer"" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li>
        
      
        
      
        
          <li><a href="https://github.com/ktenzer" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
        
      
        
      
        
      
        
      
    

    
      <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
    
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2022 Keith Tenzer. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>







  </body>
</html>
