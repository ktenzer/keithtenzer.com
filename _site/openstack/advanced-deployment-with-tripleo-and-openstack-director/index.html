<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.22.0 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
<link rel="icon" href="/assets/main/me.png">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Advanced Deployment with TripleO and OpenStack Director - Keith Tenzer’s Blog</title>
<meta name="description" content="Overview In this article we will look at some advanced deployment scenarios using TripleO and the OpenStack Director. This article builds on a previous article: HOWTO: OpenStack Deployment using TripleO and the Red Hat OpenStack Director. It assumes you have a working OpenStack environment built with Red Hat OpenStack Director and complete with undercloud as well as overcloud. We will tear down existing OpenStack environment, create a new deployment using custom OpenStack Ironic profiles, customize post-installation and show how to add additional compute resources.  Tear Down Existing Environment One of the advantages of TripleO is that it uses OpenStack to deploy OpenStack. This makes it of course very easy to tear down and rebuilt environments. The basic idea is that immutable and reproducible infrastructure leads to much higher stability. Production environments can be tested properly because they are reproducible. Production is never changed, it is re-deployed and only the deployment configuration is ever changed. These are common practices for any software engineering group but only recently have been applied to Infrastructure itself. Delete ironic baremetal nodes. [stack@undercloud ~]$ for i in $(ironic node-list | grep -v UUID | awk &#39; { print $2 } &#39;); do ironic node-delete $i; done Import the baremetal node configuration. [stack@undercloud ~]$ openstack baremetal import --json instackenv.json Undeploy overcloud by deleting the Heat stack. [stack@undercloud ~]$ heat stack-delete overcloud Ironic Profiles In our original deployment we used a single Ironic profile. Normally however you would probably have different resource expectations for controller, compute and even ceph nodes. Using AHC-Tools (Automated Health Check) it is possible to build Ironic profiles that match specific hardware. Install AHC-Tools. [stack@undercloud ~]$ sudo yum install -y ahc-tools Configure AHC-Tools. [stack@undercloud ~]$ sudo su - undercloud# sed &#39;s/\[discoverd/\[ironic/&#39; /etc/ironic-discoverd/discoverd.conf &gt; /etc/ahc-tools/ahc-tools.conf  [stack@undercloud ~]$ unset DIB_YUM_REPO_CONF [stack@undercloud ~]$ unset DIB_LOCAL_IMAGE [stack@undercloud ~]$ sudo systemctl stop bootif-fix  [stack@undercloud ~]$ source ~/stackrc  Enable discovery using AHC-Tools and re-deploy the undercloud. [stack@undercloud ~]$ openstack-config --set ~/undercloud.conf DEFAULT discovery_runbench true [stack@undercloud ~]$ openstack undercloud install [stack@undercloud ~]$ sudo systemctl start bootif-fix [stack@undercloud ~]$ source ~/stackrc [stack@undercloud ~]$ openstack baremetal import --json instackenv.json [stack@undercloud ~]$ openstack baremetal configure boot  Ironic nodes should be set to available. [stack@undercloud ~]$ ironic node-list +--------------------------------------+------+---------------+-------------+-----------------+-------------+ | UUID | Name | Instance UUID | Power State | Provision State | Maintenance | +--------------------------------------+------+---------------+-------------+-----------------+-------------+ | 88d5901b-8527-468b-8c7c-852d79096bcc | None | None | power off | available | False | | d1f47f58-3b29-4dc6-a16c-2999f3422b36 | None | None | power off | available | False | | 9e6f26df-22dd-4b2b-a862-78b29a284825 | None | None | power off | available | False | +--------------------------------------+------+---------------+-------------+-----------------+-------------+  Change Ironic node provision state to managed. Manual introspection requires nodes being set to managed. [stack@undercloud ~]$ ironic node-set-provision-state 88d5901b-8527-468b-8c7c-852d79096bcc manage [stack@undercloud ~]$ ironic node-set-provision-state d1f47f58-3b29-4dc6-a16c-2999f3422b36 manage [stack@undercloud ~]$ ironic node-set-provision-state 9e6f26df-22dd-4b2b-a862-78b29a284825 manage Start introspection for each Ironic node. [stack@undercloud ~]$ openstack baremetal introspection start 88d5901b-8527-468b-8c7c-852d79096bcc [stack@undercloud ~]$ openstack baremetal introspection start d1f47f58-3b29-4dc6-a16c-2999f3422b36 [stack@undercloud ~]$ openstack baremetal introspection start 9e6f26df-22dd-4b2b-a862-78b29a284825 Verify introspection completes. Check to ensure nodes power-on and in addition monitor introspection to ensure it completes.  [stack@undercloud ~]$ ironic node-list | grep &quot;power on&quot; | awk &#39;{print $2&quot; (&quot;$8&quot; &quot;$9&quot;)&quot;;}&#39;  To check introspection status view journalctl logs. [stack@undercloud ~]$ sudo journalctl -u openstack-ironic-discoverd -f  Check introspection status using CLI. [stack@undercloud ~]$ openstack baremetal introspection status 88d5901b-8527-468b-8c7c-852d79096bcc  +----------+-------+  | Field    | Value |  +----------+-------+  | error    | None  |   | finished | False |  +----------+-------+  Wait until introspection completes for all nodes. [stack@undercloud ~]$ openstack baremetal introspection status 88d5901b-8527-468b-8c7c-852d79096bcc  +----------+-------+  | Field    | Value |  +----------+-------+  | error    | None  |  | finished | True  |  +----------+-------+ Once introspection completes we need to set the state of each node to &#39;available&#39;. Again this is automatically done for us when doing automatic introspection. [stack@undercloud ~]$ for i in $(ironic node-list | grep -v UUID | awk &#39; { print $2 } &#39;); do ironic node-set-provision-state $i provide; done Generate report of benchmarking and introspection using ahc-tools. undercloud$ ahc-report --full We can view indentical systems as well as systems that are not consistent with our configuration undercloud$ ahc-report --categories | grep -A3 &quot;3 identical systems&quot; undercloud$ ahc-report --outliers | grep -i inconsistent | head -n5  Ironic hardware specs are stored in various configuration files. Once exists for compute, controller and ceph. In addition there is a configuration file that depicts the OpenStack overcloud topology. Controller specs are stored in following file: [stack@undercloud ~]$ cat /etc/ahc-tools/edeploy/control.specs [ (&#39;disk&#39;, &#39;$disk&#39;, &#39;size&#39;, &#39;gt(4)&#39;), (&#39;network&#39;, &#39;$eth&#39;, &#39;ipv4&#39;, &#39;network(192.0.2.0/24)&#39;), (&#39;memory&#39;, &#39;total&#39;, &#39;size&#39;, &#39;ge(4294967296)&#39;), ] Compute specs are stored in following file: [stack@undercloud ~]$ cat /etc/ahc-tools/edeploy/compute.specs [ (&#39;disk&#39;, &#39;$disk&#39;, &#39;size&#39;, &#39;gt(4)&#39;), (&#39;network&#39;, &#39;$eth&#39;, &#39;ipv4&#39;, &#39;network(192.0.2.0/24)&#39;), (&#39;memory&#39;, &#39;total&#39;, &#39;size&#39;, &#39;ge(4294967296)&#39;), ] OpenStack overcloud topology is stored in following file: [stack@undercloud ~]$ cat /etc/ahc-tools/edeploy/state [(&#39;control&#39;, &#39;1&#39;), (&#39;compute&#39;, &#39;*&#39;)] Change the compute and controller specs as follows: undercloud$ sudo su -  undercloud# cat &lt;&lt; EOF &gt; /etc/ahc-tools/edeploy/control.specs [ (&#39;cpu&#39;, &#39;logical&#39;, &#39;number&#39;, &#39;ge(4)&#39;), (&#39;disk&#39;, &#39;vda&#39;, &#39;size&#39;, &#39;gt(25)&#39;), ] EOF undercloud# cat &lt;&lt; EOF &gt; /etc/ahc-tools/edeploy/compute.specs [ (&#39;cpu&#39;, &#39;logical&#39;, &#39;number&#39;, &#39;ge(2)&#39;), (&#39;memory&#39;, &#39;total&#39;, &#39;size&#39;, &#39;ge(3000000)&#39;), ] EOF Run AHC and have it match profiles with discovered hardware. undercloud# ahc-match Node roles can now be viewed. In our case we have 1 controller and two compute nodes that were classified by AHC. [stack@undercloud ~]$ for i in $(ironic node-list | grep -v UUID | awk &#39;{print $2;}&#39; \ | sed -e /^$/d); do ironic node-show $i | grep -A1 properties; \ echo &quot;=======&quot;; done;">


  <meta name="author" content="Keith Tenzer">
  
  <meta property="article:author" content="Keith Tenzer">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Keith Tenzer's Blog">
<meta property="og:title" content="Advanced Deployment with TripleO and OpenStack Director">
<meta property="og:url" content="http://localhost:4000/openstack/advanced-deployment-with-tripleo-and-openstack-director/">


  <meta property="og:description" content="Overview In this article we will look at some advanced deployment scenarios using TripleO and the OpenStack Director. This article builds on a previous article: HOWTO: OpenStack Deployment using TripleO and the Red Hat OpenStack Director. It assumes you have a working OpenStack environment built with Red Hat OpenStack Director and complete with undercloud as well as overcloud. We will tear down existing OpenStack environment, create a new deployment using custom OpenStack Ironic profiles, customize post-installation and show how to add additional compute resources.  Tear Down Existing Environment One of the advantages of TripleO is that it uses OpenStack to deploy OpenStack. This makes it of course very easy to tear down and rebuilt environments. The basic idea is that immutable and reproducible infrastructure leads to much higher stability. Production environments can be tested properly because they are reproducible. Production is never changed, it is re-deployed and only the deployment configuration is ever changed. These are common practices for any software engineering group but only recently have been applied to Infrastructure itself. Delete ironic baremetal nodes. [stack@undercloud ~]$ for i in $(ironic node-list | grep -v UUID | awk &#39; { print $2 } &#39;); do ironic node-delete $i; done Import the baremetal node configuration. [stack@undercloud ~]$ openstack baremetal import --json instackenv.json Undeploy overcloud by deleting the Heat stack. [stack@undercloud ~]$ heat stack-delete overcloud Ironic Profiles In our original deployment we used a single Ironic profile. Normally however you would probably have different resource expectations for controller, compute and even ceph nodes. Using AHC-Tools (Automated Health Check) it is possible to build Ironic profiles that match specific hardware. Install AHC-Tools. [stack@undercloud ~]$ sudo yum install -y ahc-tools Configure AHC-Tools. [stack@undercloud ~]$ sudo su - undercloud# sed &#39;s/\[discoverd/\[ironic/&#39; /etc/ironic-discoverd/discoverd.conf &gt; /etc/ahc-tools/ahc-tools.conf  [stack@undercloud ~]$ unset DIB_YUM_REPO_CONF [stack@undercloud ~]$ unset DIB_LOCAL_IMAGE [stack@undercloud ~]$ sudo systemctl stop bootif-fix  [stack@undercloud ~]$ source ~/stackrc  Enable discovery using AHC-Tools and re-deploy the undercloud. [stack@undercloud ~]$ openstack-config --set ~/undercloud.conf DEFAULT discovery_runbench true [stack@undercloud ~]$ openstack undercloud install [stack@undercloud ~]$ sudo systemctl start bootif-fix [stack@undercloud ~]$ source ~/stackrc [stack@undercloud ~]$ openstack baremetal import --json instackenv.json [stack@undercloud ~]$ openstack baremetal configure boot  Ironic nodes should be set to available. [stack@undercloud ~]$ ironic node-list +--------------------------------------+------+---------------+-------------+-----------------+-------------+ | UUID | Name | Instance UUID | Power State | Provision State | Maintenance | +--------------------------------------+------+---------------+-------------+-----------------+-------------+ | 88d5901b-8527-468b-8c7c-852d79096bcc | None | None | power off | available | False | | d1f47f58-3b29-4dc6-a16c-2999f3422b36 | None | None | power off | available | False | | 9e6f26df-22dd-4b2b-a862-78b29a284825 | None | None | power off | available | False | +--------------------------------------+------+---------------+-------------+-----------------+-------------+  Change Ironic node provision state to managed. Manual introspection requires nodes being set to managed. [stack@undercloud ~]$ ironic node-set-provision-state 88d5901b-8527-468b-8c7c-852d79096bcc manage [stack@undercloud ~]$ ironic node-set-provision-state d1f47f58-3b29-4dc6-a16c-2999f3422b36 manage [stack@undercloud ~]$ ironic node-set-provision-state 9e6f26df-22dd-4b2b-a862-78b29a284825 manage Start introspection for each Ironic node. [stack@undercloud ~]$ openstack baremetal introspection start 88d5901b-8527-468b-8c7c-852d79096bcc [stack@undercloud ~]$ openstack baremetal introspection start d1f47f58-3b29-4dc6-a16c-2999f3422b36 [stack@undercloud ~]$ openstack baremetal introspection start 9e6f26df-22dd-4b2b-a862-78b29a284825 Verify introspection completes. Check to ensure nodes power-on and in addition monitor introspection to ensure it completes.  [stack@undercloud ~]$ ironic node-list | grep &quot;power on&quot; | awk &#39;{print $2&quot; (&quot;$8&quot; &quot;$9&quot;)&quot;;}&#39;  To check introspection status view journalctl logs. [stack@undercloud ~]$ sudo journalctl -u openstack-ironic-discoverd -f  Check introspection status using CLI. [stack@undercloud ~]$ openstack baremetal introspection status 88d5901b-8527-468b-8c7c-852d79096bcc  +----------+-------+  | Field    | Value |  +----------+-------+  | error    | None  |   | finished | False |  +----------+-------+  Wait until introspection completes for all nodes. [stack@undercloud ~]$ openstack baremetal introspection status 88d5901b-8527-468b-8c7c-852d79096bcc  +----------+-------+  | Field    | Value |  +----------+-------+  | error    | None  |  | finished | True  |  +----------+-------+ Once introspection completes we need to set the state of each node to &#39;available&#39;. Again this is automatically done for us when doing automatic introspection. [stack@undercloud ~]$ for i in $(ironic node-list | grep -v UUID | awk &#39; { print $2 } &#39;); do ironic node-set-provision-state $i provide; done Generate report of benchmarking and introspection using ahc-tools. undercloud$ ahc-report --full We can view indentical systems as well as systems that are not consistent with our configuration undercloud$ ahc-report --categories | grep -A3 &quot;3 identical systems&quot; undercloud$ ahc-report --outliers | grep -i inconsistent | head -n5  Ironic hardware specs are stored in various configuration files. Once exists for compute, controller and ceph. In addition there is a configuration file that depicts the OpenStack overcloud topology. Controller specs are stored in following file: [stack@undercloud ~]$ cat /etc/ahc-tools/edeploy/control.specs [ (&#39;disk&#39;, &#39;$disk&#39;, &#39;size&#39;, &#39;gt(4)&#39;), (&#39;network&#39;, &#39;$eth&#39;, &#39;ipv4&#39;, &#39;network(192.0.2.0/24)&#39;), (&#39;memory&#39;, &#39;total&#39;, &#39;size&#39;, &#39;ge(4294967296)&#39;), ] Compute specs are stored in following file: [stack@undercloud ~]$ cat /etc/ahc-tools/edeploy/compute.specs [ (&#39;disk&#39;, &#39;$disk&#39;, &#39;size&#39;, &#39;gt(4)&#39;), (&#39;network&#39;, &#39;$eth&#39;, &#39;ipv4&#39;, &#39;network(192.0.2.0/24)&#39;), (&#39;memory&#39;, &#39;total&#39;, &#39;size&#39;, &#39;ge(4294967296)&#39;), ] OpenStack overcloud topology is stored in following file: [stack@undercloud ~]$ cat /etc/ahc-tools/edeploy/state [(&#39;control&#39;, &#39;1&#39;), (&#39;compute&#39;, &#39;*&#39;)] Change the compute and controller specs as follows: undercloud$ sudo su -  undercloud# cat &lt;&lt; EOF &gt; /etc/ahc-tools/edeploy/control.specs [ (&#39;cpu&#39;, &#39;logical&#39;, &#39;number&#39;, &#39;ge(4)&#39;), (&#39;disk&#39;, &#39;vda&#39;, &#39;size&#39;, &#39;gt(25)&#39;), ] EOF undercloud# cat &lt;&lt; EOF &gt; /etc/ahc-tools/edeploy/compute.specs [ (&#39;cpu&#39;, &#39;logical&#39;, &#39;number&#39;, &#39;ge(2)&#39;), (&#39;memory&#39;, &#39;total&#39;, &#39;size&#39;, &#39;ge(3000000)&#39;), ] EOF Run AHC and have it match profiles with discovered hardware. undercloud# ahc-match Node roles can now be viewed. In our case we have 1 controller and two compute nodes that were classified by AHC. [stack@undercloud ~]$ for i in $(ironic node-list | grep -v UUID | awk &#39;{print $2;}&#39; \ | sed -e /^$/d); do ironic node-show $i | grep -A1 properties; \ echo &quot;=======&quot;; done;">





  <meta name="twitter:site" content="@keithtenzer">
  <meta name="twitter:title" content="Advanced Deployment with TripleO and OpenStack Director">
  <meta name="twitter:description" content="Overview In this article we will look at some advanced deployment scenarios using TripleO and the OpenStack Director. This article builds on a previous article: HOWTO: OpenStack Deployment using TripleO and the Red Hat OpenStack Director. It assumes you have a working OpenStack environment built with Red Hat OpenStack Director and complete with undercloud as well as overcloud. We will tear down existing OpenStack environment, create a new deployment using custom OpenStack Ironic profiles, customize post-installation and show how to add additional compute resources.  Tear Down Existing Environment One of the advantages of TripleO is that it uses OpenStack to deploy OpenStack. This makes it of course very easy to tear down and rebuilt environments. The basic idea is that immutable and reproducible infrastructure leads to much higher stability. Production environments can be tested properly because they are reproducible. Production is never changed, it is re-deployed and only the deployment configuration is ever changed. These are common practices for any software engineering group but only recently have been applied to Infrastructure itself. Delete ironic baremetal nodes. [stack@undercloud ~]$ for i in $(ironic node-list | grep -v UUID | awk &#39; { print $2 } &#39;); do ironic node-delete $i; done Import the baremetal node configuration. [stack@undercloud ~]$ openstack baremetal import --json instackenv.json Undeploy overcloud by deleting the Heat stack. [stack@undercloud ~]$ heat stack-delete overcloud Ironic Profiles In our original deployment we used a single Ironic profile. Normally however you would probably have different resource expectations for controller, compute and even ceph nodes. Using AHC-Tools (Automated Health Check) it is possible to build Ironic profiles that match specific hardware. Install AHC-Tools. [stack@undercloud ~]$ sudo yum install -y ahc-tools Configure AHC-Tools. [stack@undercloud ~]$ sudo su - undercloud# sed &#39;s/\[discoverd/\[ironic/&#39; /etc/ironic-discoverd/discoverd.conf &gt; /etc/ahc-tools/ahc-tools.conf  [stack@undercloud ~]$ unset DIB_YUM_REPO_CONF [stack@undercloud ~]$ unset DIB_LOCAL_IMAGE [stack@undercloud ~]$ sudo systemctl stop bootif-fix  [stack@undercloud ~]$ source ~/stackrc  Enable discovery using AHC-Tools and re-deploy the undercloud. [stack@undercloud ~]$ openstack-config --set ~/undercloud.conf DEFAULT discovery_runbench true [stack@undercloud ~]$ openstack undercloud install [stack@undercloud ~]$ sudo systemctl start bootif-fix [stack@undercloud ~]$ source ~/stackrc [stack@undercloud ~]$ openstack baremetal import --json instackenv.json [stack@undercloud ~]$ openstack baremetal configure boot  Ironic nodes should be set to available. [stack@undercloud ~]$ ironic node-list +--------------------------------------+------+---------------+-------------+-----------------+-------------+ | UUID | Name | Instance UUID | Power State | Provision State | Maintenance | +--------------------------------------+------+---------------+-------------+-----------------+-------------+ | 88d5901b-8527-468b-8c7c-852d79096bcc | None | None | power off | available | False | | d1f47f58-3b29-4dc6-a16c-2999f3422b36 | None | None | power off | available | False | | 9e6f26df-22dd-4b2b-a862-78b29a284825 | None | None | power off | available | False | +--------------------------------------+------+---------------+-------------+-----------------+-------------+  Change Ironic node provision state to managed. Manual introspection requires nodes being set to managed. [stack@undercloud ~]$ ironic node-set-provision-state 88d5901b-8527-468b-8c7c-852d79096bcc manage [stack@undercloud ~]$ ironic node-set-provision-state d1f47f58-3b29-4dc6-a16c-2999f3422b36 manage [stack@undercloud ~]$ ironic node-set-provision-state 9e6f26df-22dd-4b2b-a862-78b29a284825 manage Start introspection for each Ironic node. [stack@undercloud ~]$ openstack baremetal introspection start 88d5901b-8527-468b-8c7c-852d79096bcc [stack@undercloud ~]$ openstack baremetal introspection start d1f47f58-3b29-4dc6-a16c-2999f3422b36 [stack@undercloud ~]$ openstack baremetal introspection start 9e6f26df-22dd-4b2b-a862-78b29a284825 Verify introspection completes. Check to ensure nodes power-on and in addition monitor introspection to ensure it completes.  [stack@undercloud ~]$ ironic node-list | grep &quot;power on&quot; | awk &#39;{print $2&quot; (&quot;$8&quot; &quot;$9&quot;)&quot;;}&#39;  To check introspection status view journalctl logs. [stack@undercloud ~]$ sudo journalctl -u openstack-ironic-discoverd -f  Check introspection status using CLI. [stack@undercloud ~]$ openstack baremetal introspection status 88d5901b-8527-468b-8c7c-852d79096bcc  +----------+-------+  | Field    | Value |  +----------+-------+  | error    | None  |   | finished | False |  +----------+-------+  Wait until introspection completes for all nodes. [stack@undercloud ~]$ openstack baremetal introspection status 88d5901b-8527-468b-8c7c-852d79096bcc  +----------+-------+  | Field    | Value |  +----------+-------+  | error    | None  |  | finished | True  |  +----------+-------+ Once introspection completes we need to set the state of each node to &#39;available&#39;. Again this is automatically done for us when doing automatic introspection. [stack@undercloud ~]$ for i in $(ironic node-list | grep -v UUID | awk &#39; { print $2 } &#39;); do ironic node-set-provision-state $i provide; done Generate report of benchmarking and introspection using ahc-tools. undercloud$ ahc-report --full We can view indentical systems as well as systems that are not consistent with our configuration undercloud$ ahc-report --categories | grep -A3 &quot;3 identical systems&quot; undercloud$ ahc-report --outliers | grep -i inconsistent | head -n5  Ironic hardware specs are stored in various configuration files. Once exists for compute, controller and ceph. In addition there is a configuration file that depicts the OpenStack overcloud topology. Controller specs are stored in following file: [stack@undercloud ~]$ cat /etc/ahc-tools/edeploy/control.specs [ (&#39;disk&#39;, &#39;$disk&#39;, &#39;size&#39;, &#39;gt(4)&#39;), (&#39;network&#39;, &#39;$eth&#39;, &#39;ipv4&#39;, &#39;network(192.0.2.0/24)&#39;), (&#39;memory&#39;, &#39;total&#39;, &#39;size&#39;, &#39;ge(4294967296)&#39;), ] Compute specs are stored in following file: [stack@undercloud ~]$ cat /etc/ahc-tools/edeploy/compute.specs [ (&#39;disk&#39;, &#39;$disk&#39;, &#39;size&#39;, &#39;gt(4)&#39;), (&#39;network&#39;, &#39;$eth&#39;, &#39;ipv4&#39;, &#39;network(192.0.2.0/24)&#39;), (&#39;memory&#39;, &#39;total&#39;, &#39;size&#39;, &#39;ge(4294967296)&#39;), ] OpenStack overcloud topology is stored in following file: [stack@undercloud ~]$ cat /etc/ahc-tools/edeploy/state [(&#39;control&#39;, &#39;1&#39;), (&#39;compute&#39;, &#39;*&#39;)] Change the compute and controller specs as follows: undercloud$ sudo su -  undercloud# cat &lt;&lt; EOF &gt; /etc/ahc-tools/edeploy/control.specs [ (&#39;cpu&#39;, &#39;logical&#39;, &#39;number&#39;, &#39;ge(4)&#39;), (&#39;disk&#39;, &#39;vda&#39;, &#39;size&#39;, &#39;gt(25)&#39;), ] EOF undercloud# cat &lt;&lt; EOF &gt; /etc/ahc-tools/edeploy/compute.specs [ (&#39;cpu&#39;, &#39;logical&#39;, &#39;number&#39;, &#39;ge(2)&#39;), (&#39;memory&#39;, &#39;total&#39;, &#39;size&#39;, &#39;ge(3000000)&#39;), ] EOF Run AHC and have it match profiles with discovered hardware. undercloud# ahc-match Node roles can now be viewed. In our case we have 1 controller and two compute nodes that were classified by AHC. [stack@undercloud ~]$ for i in $(ironic node-list | grep -v UUID | awk &#39;{print $2;}&#39; \ | sed -e /^$/d); do ironic node-show $i | grep -A1 properties; \ echo &quot;=======&quot;; done;">
  <meta name="twitter:url" content="http://localhost:4000/openstack/advanced-deployment-with-tripleo-and-openstack-director/">

  
    <meta name="twitter:card" content="summary">
    
  

  



  <meta property="article:published_time" content="2015-11-09T00:00:00-08:00">





  

  


<link rel="canonical" href="http://localhost:4000/openstack/advanced-deployment-with-tripleo-and-openstack-director/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "Keith Tenzer",
      "url": "http://localhost:4000/"
    
  }
</script>







<!-- end _includes/seo.html -->



  <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Keith Tenzer's Blog Feed">


<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css">

<!--[if IE]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->


    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single wide">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
          Keith Tenzer's Blog
          <span class="site-subtitle">Cloud Computing and Code</span>
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/about/index.html">About</a>
            </li><li class="masthead__menu-item">
              <a href="/conferences-and-events/index.html">Conferences and Events</a>
            </li><li class="masthead__menu-item">
              <a href="/videos/index.html">Videos</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <svg class="icon" width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15.99 16">
            <path d="M15.5,13.12L13.19,10.8a1.69,1.69,0,0,0-1.28-.55l-0.06-.06A6.5,6.5,0,0,0,5.77,0,6.5,6.5,0,0,0,2.46,11.59a6.47,6.47,0,0,0,7.74.26l0.05,0.05a1.65,1.65,0,0,0,.5,1.24l2.38,2.38A1.68,1.68,0,0,0,15.5,13.12ZM6.4,2A4.41,4.41,0,1,1,2,6.4,4.43,4.43,0,0,1,6.4,2Z" transform="translate(-.01)"></path>
          </svg>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      


  
    



<nav class="breadcrumbs">
  <ol itemscope itemtype="https://schema.org/BreadcrumbList">
    
    
    
      
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="http://localhost:4000/" itemprop="item"><span itemprop="name">Home</span></a>
          <meta itemprop="position" content="1" />
        </li>
        <span class="sep">/</span>
      
      
        
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="/categories/#openstack" itemprop="item"><span itemprop="name">Openstack</span></a>
          <meta itemprop="position" content="2" />
        </li>
        <span class="sep">/</span>
      
    
      
      
        <li class="current">Advanced Deployment with TripleO and OpenStack Director</li>
      
    
  </ol>
</nav>

  


<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      
        <img src="/assets/main/me.png" alt="Keith Tenzer" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">Keith Tenzer</h3>
    
    
      <div class="author__bio" itemprop="description">
        <p>Principal Solutions Architect at Red Hat</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">Los Angeles, CA</span>
        </li>
      

      
        
          
        
          
        
          
            <li><a href="https://twitter.com/keithtenzer" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i><span class="label">Twitter</span></a></li>
          
        
          
        
          
            <li><a href="https://github.com/ktenzer" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span></a></li>
          
        
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Advanced Deployment with TripleO and OpenStack Director">
    <meta itemprop="description" content="OverviewIn this article we will look at some advanced deployment scenarios using TripleO and the OpenStack Director. This article builds on a previous article: HOWTO: OpenStack Deployment using TripleO and the Red Hat OpenStack Director. It assumes you have a working OpenStack environment built with Red Hat OpenStack Director and complete with undercloud as well as overcloud. We will tear down existing OpenStack environment, create a new deployment using custom OpenStack Ironic profiles, customize post-installation and show how to add additional compute resources.Tear Down Existing EnvironmentOne of the advantages of TripleO is that it uses OpenStack to deploy OpenStack. This makes it of course very easy to tear down and rebuilt environments. The basic idea is that immutable and reproducible infrastructure leads to much higher stability. Production environments can be tested properly because they are reproducible. Production is never changed, it is re-deployed and only the deployment configuration is ever changed. These are common practices for any software engineering group but only recently have been applied to Infrastructure itself.Delete ironic baremetal nodes.[stack@undercloud ~]$ for i in $(ironic node-list | grep -v UUID | awk &#39; { print $2 } &#39;); do ironic node-delete $i; doneImport the baremetal node configuration.[stack@undercloud ~]$ openstack baremetal import --json instackenv.jsonUndeploy overcloud by deleting the Heat stack.[stack@undercloud ~]$ heat stack-delete overcloudIronic ProfilesIn our original deployment we used a single Ironic profile. Normally however you would probably have different resource expectations for controller, compute and even ceph nodes. Using AHC-Tools (Automated Health Check) it is possible to build Ironic profiles that match specific hardware.Install AHC-Tools.[stack@undercloud ~]$ sudo yum install -y ahc-toolsConfigure AHC-Tools.[stack@undercloud ~]$ sudo su -undercloud# sed &#39;s/\[discoverd/\[ironic/&#39; /etc/ironic-discoverd/discoverd.conf &gt; /etc/ahc-tools/ahc-tools.conf [stack@undercloud ~]$ unset DIB_YUM_REPO_CONF[stack@undercloud ~]$ unset DIB_LOCAL_IMAGE[stack@undercloud ~]$ sudo systemctl stop bootif-fix [stack@undercloud ~]$ source ~/stackrc Enable discovery using AHC-Tools and re-deploy the undercloud.[stack@undercloud ~]$ openstack-config --set ~/undercloud.conf DEFAULT discovery_runbench true[stack@undercloud ~]$ openstack undercloud install[stack@undercloud ~]$ sudo systemctl start bootif-fix[stack@undercloud ~]$ source ~/stackrc[stack@undercloud ~]$ openstack baremetal import --json instackenv.json[stack@undercloud ~]$ openstack baremetal configure boot Ironic nodes should be set to available.[stack@undercloud ~]$ ironic node-list+--------------------------------------+------+---------------+-------------+-----------------+-------------+| UUID | Name | Instance UUID | Power State | Provision State | Maintenance |+--------------------------------------+------+---------------+-------------+-----------------+-------------+| 88d5901b-8527-468b-8c7c-852d79096bcc | None | None | power off | available | False || d1f47f58-3b29-4dc6-a16c-2999f3422b36 | None | None | power off | available | False || 9e6f26df-22dd-4b2b-a862-78b29a284825 | None | None | power off | available | False |+--------------------------------------+------+---------------+-------------+-----------------+-------------+Change Ironic node provision state to managed. Manual introspection requires nodes being set to managed.[stack@undercloud ~]$ ironic node-set-provision-state 88d5901b-8527-468b-8c7c-852d79096bcc manage[stack@undercloud ~]$ ironic node-set-provision-state d1f47f58-3b29-4dc6-a16c-2999f3422b36 manage[stack@undercloud ~]$ ironic node-set-provision-state 9e6f26df-22dd-4b2b-a862-78b29a284825 manageStart introspection for each Ironic node.[stack@undercloud ~]$ openstack baremetal introspection start 88d5901b-8527-468b-8c7c-852d79096bcc[stack@undercloud ~]$ openstack baremetal introspection start d1f47f58-3b29-4dc6-a16c-2999f3422b36[stack@undercloud ~]$ openstack baremetal introspection start 9e6f26df-22dd-4b2b-a862-78b29a284825Verify introspection completes. Check to ensure nodes power-on and in addition monitor introspection to ensure it completes. [stack@undercloud ~]$ ironic node-list | grep &quot;power on&quot; | awk &#39;{print $2&quot; (&quot;$8&quot; &quot;$9&quot;)&quot;;}&#39; To check introspection status view journalctl logs.[stack@undercloud ~]$ sudo journalctl -u openstack-ironic-discoverd -f Check introspection status using CLI.[stack@undercloud ~]$ openstack baremetal introspection status 88d5901b-8527-468b-8c7c-852d79096bcc +----------+-------+ | Field    | Value | +----------+-------+ | error    | None  |  | finished | False | +----------+-------+ Wait until introspection completes for all nodes.[stack@undercloud ~]$ openstack baremetal introspection status 88d5901b-8527-468b-8c7c-852d79096bcc +----------+-------+ | Field    | Value | +----------+-------+ | error    | None  | | finished | True  | +----------+-------+Once introspection completes we need to set the state of each node to &#39;available&#39;. Again this is automatically done for us when doing automatic introspection.[stack@undercloud ~]$ for i in $(ironic node-list | grep -v UUID | awk &#39; { print $2 } &#39;); do ironic node-set-provision-state $i provide; doneGenerate report of benchmarking and introspection using ahc-tools.undercloud$ ahc-report --fullWe can view indentical systems as well as systems that are not consistent with our configurationundercloud$ ahc-report --categories | grep -A3 &quot;3 identical systems&quot;undercloud$ ahc-report --outliers | grep -i inconsistent | head -n5 Ironic hardware specs are stored in various configuration files. Once exists for compute, controller and ceph. In addition there is a configuration file that depicts the OpenStack overcloud topology.Controller specs are stored in following file:[stack@undercloud ~]$ cat /etc/ahc-tools/edeploy/control.specs[(&#39;disk&#39;, &#39;$disk&#39;, &#39;size&#39;, &#39;gt(4)&#39;),(&#39;network&#39;, &#39;$eth&#39;, &#39;ipv4&#39;, &#39;network(192.0.2.0/24)&#39;),(&#39;memory&#39;, &#39;total&#39;, &#39;size&#39;, &#39;ge(4294967296)&#39;),]Compute specs are stored in following file:[stack@undercloud ~]$ cat /etc/ahc-tools/edeploy/compute.specs[(&#39;disk&#39;, &#39;$disk&#39;, &#39;size&#39;, &#39;gt(4)&#39;),(&#39;network&#39;, &#39;$eth&#39;, &#39;ipv4&#39;, &#39;network(192.0.2.0/24)&#39;),(&#39;memory&#39;, &#39;total&#39;, &#39;size&#39;, &#39;ge(4294967296)&#39;),]OpenStack overcloud topology is stored in following file:[stack@undercloud ~]$ cat /etc/ahc-tools/edeploy/state[(&#39;control&#39;, &#39;1&#39;), (&#39;compute&#39;, &#39;*&#39;)]Change the compute and controller specs as follows:undercloud$ sudo su - undercloud# cat &lt;&lt; EOF &gt; /etc/ahc-tools/edeploy/control.specs[(&#39;cpu&#39;, &#39;logical&#39;, &#39;number&#39;, &#39;ge(4)&#39;),(&#39;disk&#39;, &#39;vda&#39;, &#39;size&#39;, &#39;gt(25)&#39;),]EOFundercloud# cat &lt;&lt; EOF &gt; /etc/ahc-tools/edeploy/compute.specs[(&#39;cpu&#39;, &#39;logical&#39;, &#39;number&#39;, &#39;ge(2)&#39;),(&#39;memory&#39;, &#39;total&#39;, &#39;size&#39;, &#39;ge(3000000)&#39;),]EOFRun AHC and have it match profiles with discovered hardware.undercloud# ahc-matchNode roles can now be viewed. In our case we have 1 controller and two compute nodes that were classified by AHC.[stack@undercloud ~]$ for i in $(ironic node-list | grep -v UUID | awk &#39;{print $2;}&#39; \| sed -e /^$/d); do ironic node-show $i | grep -A1 properties; \echo &quot;=======&quot;; done;">
    <meta itemprop="datePublished" content="2015-11-09T00:00:00-08:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Advanced Deployment with TripleO and OpenStack Director
</h1>
          

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-calendar-alt" aria-hidden="true"></i>
        
        <time datetime="2015-11-09T00:00:00-08:00">November 9, 2015</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          15 minute read
        
      </span>
    
  </p>


        </header>
      

      <section class="page__content" itemprop="text">
        
        <h3><a href="https://keithtenzer.files.wordpress.com/2015/11/software-maintenance.jpg"><img class="alignnone size-full wp-image-1421" src="/assets/2015/11/software-maintenance.jpg" alt="software-maintenance" width="300" height="214" /></a></h3>
<h3>Overview</h3>
<p>In this article we will look at some advanced deployment scenarios using TripleO and the OpenStack Director. This article builds on a previous article: <a href="http://keithtenzer.com/2015/10/14/howto-openstack-deployment-using-tripleo-and-the-red-hat-openstack-director/">HOWTO: OpenStack Deployment using TripleO and the Red Hat OpenStack Director</a>. It assumes you have a working OpenStack environment built with Red Hat OpenStack Director and complete with undercloud as well as overcloud. We will tear down existing OpenStack environment, create a new deployment using custom OpenStack Ironic profiles, customize post-installation and show how to add additional compute resources.<br />
<!--more--></p>
<h3>Tear Down Existing Environment</h3>
<p>One of the advantages of TripleO is that it uses OpenStack to deploy OpenStack. This makes it of course very easy to tear down and rebuilt environments. The basic idea is that immutable and reproducible infrastructure leads to much higher stability. Production environments can be tested properly because they are reproducible. Production is never changed, it is re-deployed and only the deployment configuration is ever changed. These are common practices for any software engineering group but only recently have been applied to Infrastructure itself.</p>
<p>Delete ironic baremetal nodes.</p>
<pre style="padding-left:30px;">[stack@undercloud ~]$ for i in $(ironic node-list | grep -v UUID | awk ' { print $2 } '); do ironic node-delete $i; done</pre>
<p>Import the baremetal node configuration.</p>
<pre style="padding-left:30px;">[stack@undercloud ~]$ openstack baremetal import --json instackenv.json</pre>
<p>Undeploy overcloud by deleting the Heat stack.</p>
<pre style="padding-left:30px;">[stack@undercloud ~]$ heat stack-delete overcloud</pre>
<h3>Ironic Profiles</h3>
<p>In our original deployment we used a single Ironic profile. Normally however you would probably have different resource expectations for controller, compute and even ceph nodes. Using AHC-Tools (Automated Health Check) it is possible to build Ironic profiles that match specific hardware.</p>
<p>Install AHC-Tools.</p>
<pre style="padding-left:30px;"><code class="language-none">[stack@undercloud ~]$ sudo yum install -y ahc-tools</code></pre>
<p>Configure AHC-Tools.</p>
<pre style="padding-left:30px;"><code class="language-none">[stack@undercloud ~]$ sudo su -
undercloud# sed 's/\[discoverd/\[ironic/' /etc/ironic-discoverd/discoverd.conf &gt; /etc/ahc-tools/ahc-tools.conf </code></pre>
<pre style="padding-left:30px;"><code class="language-none">[stack@undercloud ~]$ unset DIB_YUM_REPO_CONF
[stack@undercloud ~]$ unset DIB_LOCAL_IMAGE
[stack@undercloud ~]$ sudo systemctl stop bootif-fix 
[stack@undercloud ~]$ source ~/stackrc </code></pre>
<p>Enable discovery using AHC-Tools and re-deploy the undercloud.</p>
<pre style="padding-left:30px;"><code class="language-none">[stack@undercloud ~]$ openstack-config --set ~/undercloud.conf DEFAULT discovery_runbench true
[stack@undercloud ~]$ openstack undercloud install
[stack@undercloud ~]$ sudo systemctl start bootif-fix
[stack@undercloud ~]$ source ~/stackrc</code></pre>
<pre style="padding-left:30px;"><code class="language-none">[stack@undercloud ~]$ </code>openstack baremetal import --json instackenv.json</pre>
<pre style="padding-left:30px;"><code class="language-none">[stack@undercloud ~]$ openstack baremetal configure boot </code></pre>
<p>Ironic nodes should be set to available.</p>
<pre style="padding-left:30px;"><code class="language-none">[stack@undercloud ~]$ ironic node-list
+--------------------------------------+------+---------------+-------------+-----------------+-------------+
| UUID | Name | Instance UUID | Power State | Provision State | Maintenance |
+--------------------------------------+------+---------------+-------------+-----------------+-------------+
| 88d5901b-8527-468b-8c7c-852d79096bcc | None | None | power off | available | False |
| d1f47f58-3b29-4dc6-a16c-2999f3422b36 | None | None | power off | available | False |
| 9e6f26df-22dd-4b2b-a862-78b29a284825 | None | None | power off | available | False |
+--------------------------------------+------+---------------+-------------+-----------------+-------------+
</code></pre>
<p>Change Ironic node provision state to managed. Manual introspection requires nodes being set to managed.</p>
<pre style="padding-left:30px;"><code class="language-none">[stack@undercloud ~]$ ironic node-set-provision-state 88d5901b-8527-468b-8c7c-852d79096bcc manage
[stack@undercloud ~]$ ironic node-set-provision-state d1f47f58-3b29-4dc6-a16c-2999f3422b36 manage
[stack@undercloud ~]$ ironic node-set-provision-state 9e6f26df-22dd-4b2b-a862-78b29a284825 manage</code></pre>
<p>Start introspection for each Ironic node.</p>
<pre style="padding-left:30px;"><code class="language-none">[stack@undercloud ~]$ openstack baremetal introspection start 88d5901b-8527-468b-8c7c-852d79096bcc
[stack@undercloud ~]$ openstack baremetal introspection start d1f47f58-3b29-4dc6-a16c-2999f3422b36
[stack@undercloud ~]$ openstack baremetal introspection start 9e6f26df-22dd-4b2b-a862-78b29a284825</code></pre>
<p><code class="language-none">Verify introspection completes. Check to ensure nodes power-on and in addition monitor introspection to ensure it completes. </code></p>
<pre style="padding-left:30px;"><code class="language-none">[stack@undercloud ~]$ ironic node-list | grep "power on" | awk '{print $2" ("$8" "$9")";}' </code></pre>
<p><code class="language-none">To check introspection status view journalctl logs.</code></p>
<pre style="padding-left:30px;"><code class="language-none">[stack@undercloud ~]$ </code><code class="language-none">sudo journalctl -u openstack-ironic-discoverd -f </code></pre>
<p>Check introspection status using CLI.</p>
<pre style="padding-left:30px;"><code class="language-none">[stack@undercloud ~]$ openstack baremetal introspection status 88d5901b-8527-468b-8c7c-852d79096bcc 
+----------+-------+ 
| Field    | Value | 
+----------+-------+ 
| error    | None  |  
| finished | False | 
+----------+-------+ </code></pre>
<p>Wait until introspection completes for all nodes.</p>
<pre style="padding-left:30px;">[stack@undercloud ~]$ openstack baremetal introspection status 88d5901b-8527-468b-8c7c-852d79096bcc 
+----------+-------+ 
| Field    | Value | 
+----------+-------+ 
| error    | None  | 
| finished | True  | 
+----------+-------+</pre>
<p>Once introspection completes we need to set the state of each node to 'available'. Again this is automatically done for us when doing automatic introspection.</p>
<pre style="padding-left:30px;">[stack@undercloud ~]$ <code class="language-none">for i in $(ironic node-list | grep -v UUID | awk ' { print $2 } '); do ironic node-set-provision-state $i provide; done</code></pre>
<p>Generate report of benchmarking and introspection using ahc-tools.</p>
<pre style="padding-left:30px;"><code class="language-none">undercloud$ ahc-report --full</code></pre>
<p>We can view indentical systems as well as systems that are not consistent with our configuration</p>
<pre style="padding-left:30px;"><code class="language-none">undercloud$ ahc-report --categories | grep -A3 "3 identical systems"
undercloud$ ahc-report --outliers | grep -i inconsistent | head -n5 </code></pre>
<p>Ironic hardware specs are stored in various configuration files. Once exists for compute, controller and ceph. In addition there is a configuration file that depicts the OpenStack overcloud topology.</p>
<p>Controller specs are stored in following file:</p>
<pre style="padding-left:30px;">[stack@undercloud ~]$ cat /etc/ahc-tools/edeploy/control.specs
[
('disk', '$disk', 'size', 'gt(4)'),
('network', '$eth', 'ipv4', 'network(192.0.2.0/24)'),
('memory', 'total', 'size', 'ge(4294967296)'),
]</pre>
<p>Compute specs are stored in following file:</p>
<pre style="padding-left:30px;">[stack@undercloud ~]$ cat /etc/ahc-tools/edeploy/compute.specs
[
('disk', '$disk', 'size', 'gt(4)'),
('network', '$eth', 'ipv4', 'network(192.0.2.0/24)'),
('memory', 'total', 'size', 'ge(4294967296)'),
]</pre>
<p>OpenStack overcloud topology is stored in following file:</p>
<pre style="padding-left:30px;">[stack@undercloud ~]$ cat /etc/ahc-tools/edeploy/state
[('control', '1'), ('compute', '*')]</pre>
<p>Change the compute and controller specs as follows:</p>
<pre style="padding-left:30px;"><code class="language-none">undercloud$ sudo su - 
undercloud# cat &lt;&lt; EOF &gt; /etc/ahc-tools/edeploy/control.specs
[
('cpu', 'logical', 'number', 'ge(4)'),
('disk', 'vda', 'size', 'gt(25)'),
]
EOF</code></pre>
<pre style="padding-left:30px;"><code class="language-none">undercloud# cat &lt;&lt; EOF &gt; /etc/ahc-tools/edeploy/compute.specs
[
('cpu', 'logical', 'number', 'ge(2)'),
('memory', 'total', 'size', 'ge(3000000)'),
]
EOF</code></pre>
<p>Run AHC and have it match profiles with discovered hardware.</p>
<pre style="padding-left:30px;"><code class="language-none">undercloud# ahc-match</code></pre>
<p>Node roles can now be viewed. In our case we have 1 controller and two compute nodes that were classified by AHC.</p>
<pre style="padding-left:30px;">[stack@undercloud ~]$ for i in $(ironic node-list | grep -v UUID | awk '{print $2;}' \
| sed -e /^$/d); do ironic node-show $i | grep -A1 properties; \
echo "======="; done;

| properties | {u'memory_mb': u'4096', u'cpu_arch': u'x86_64', u'local_gb': u'1', |
| | u'cpus': u'4', u'capabilities': u'profile:control,boot_option:local'} |
=======
| properties | {u'memory_mb': u'4096', u'cpu_arch': u'x86_64', u'local_gb': u'1', |
| | u'cpus': u'4', u'capabilities': u'profile:compute,boot_option:local'} |
=======Fgener
| properties | {u'memory_mb': u'4096', u'cpu_arch': u'x86_64', u'local_gb': u'1', |
| | u'cpus': u'4', u'capabilities': u'profile:compute,boot_option:local'} |</pre>
<p>Create new Ironic flavors for controller and compute nodes.</p>
<pre style="padding-left:30px;">[stack@undercloud ~]$ openstack flavor create --id auto --ram 4096 --disk 58 --vcpus 4 control</pre>
<pre style="padding-left:30px;">[stack@undercloud ~]$ openstack flavor create --id auto --ram 4096 --disk 58 --vcpus 2 compute</pre>
<p>Update flavors and map them to the Ironic profiles.</p>
<pre style="padding-left:30px;"><code class="language-none">undercloud$ openstack flavor set --property "cpu_arch"="x86_64" --property "capabilities:boot_option"="local" --property "capabilities:profile"="control" control </code></pre>
<pre style="padding-left:30px;"><code class="language-none">undercloud$ openstack flavor set --property "cpu_arch"="x86_64" --property "capabilities:boot_option"="local" --property "capabilities:profile"="compute" compute </code></pre>
<h3>Post Installation Customization</h3>
<p>Since the basis for TripleO is Heat, customization is thankfully quite simple. In this example we will install Nagios monitoring package to all OpenStack overcloud nodes as part of post-install phase.</p>
<p>Create post installation yaml files.</p>
<pre style="padding-left:30px;"><code class="language-none">undercloud$ cat &lt;&lt; EOF &gt; ~/templates/firstboot-environment.yaml 
resource_registry: 
  OS::TripleO::NodeUserData: /home/stack/my_templates/firstboot-config.yaml 
EOF </code></pre>
<pre style="padding-left:30px;"><code class="language-none">undercloud$ cat &lt;&lt; EOF &gt; ~/templates/firstboot-config.yaml
heat_template_version: 2014-10-16

resources:
  userdata:
    type: OS::Heat::MultipartMime
    properties:
      parts:
      - config: {get_resource: repo_config}

  repo_config:
    type: OS::Heat::SoftwareConfig
    properties:
      config: |
        #!/bin/bash
        yum install -y nagios

outputs:
  OS::stack_id:
    value: {get_resource: userdata}
EOF</code></pre>
<p>Deploy overcloud using custom Ironic profiles and post-installation customization.</p>
<pre style="padding-left:30px;">[stack@undercloud ~]$ openstack overcloud deploy --templates --control-flavor control --compute-flavor compute --control-scale 1 --compute-scale 1 --neutron-tunnel-types vxlan --neutron-network-type vxlan -e ~/templates/firstboot-environment.yaml
Deploying templates in the directory /usr/share/openstack-tripleo-heat-templates
 /home/stack/.ssh/known_hosts updated.
 Original contents retained as /home/stack/.ssh/known_hosts.old
 PKI initialization in init-keystone is deprecated and will be removed.
 Warning: Permanently added '192.168.126.104' (ECDSA) to the list of known hosts.
 The following cert files already exist, use --rebuild to remove the existing files before regenerating:
 /etc/keystone/ssl/certs/ca.pem already exists
 /etc/keystone/ssl/private/signing_key.pem already exists
 /etc/keystone/ssl/certs/signing_cert.pem already exists
 Connection to 192.168.126.104 closed.
 Overcloud Endpoint: http://192.168.126.104:5000/v2.0/
 Overcloud Deployed</pre>
<h3>Add Additional Compute Resources</h3>
<p>As we have seen we can control hardware through Ironic profiles and easily customize the deployment of OpenStack using Heat. Next we will add an additional compute resource. As you have noticed, we have configured three baremetal nodes but have only deployed two (1 X Compute, 1 X Control). A second compute node can easily be added to the OpenStack environment on-the-fly. Again we see the power of immutable infrastructure and automation.</p>
<p>Re-run deployment.</p>
<pre style="padding-left:30px;">[stack@undercloud ~]$ openstack overcloud deploy --templates --control-flavor control --compute-flavor compute --control-scale 1 --compute-scale 2 --neutron-tunnel-types vxlan --neutron-network-type vxlan -e ~/templates/firstboot-environment.yaml</pre>
<p>After deployment completes you should see an additional compute node.</p>
<pre style="padding-left:30px;">[stack@undercloud ~]$ nova list
+--------------------------------------+------------------------+--------+------------+-------------+---------------+
| ID | Name | Status | Task State | Power State | Networks                                                          |
+--------------------------------------+------------------------+--------+------------+-------------+---------------+
| 53813f9b-7020-4386-9c10-5818633c21ee | overcloud-compute-0    | ACTIVE | - | Running | ctlplane=192.168.126.106   |
| 76e2c3fd-7278-4ded-8893-e6c9d8b4a76f | overcloud-compute-1    | ACTIVE | - | Running | ctlplane=192.168.126.107   |
| 204dd901-a56d-40b6-9b18-bd8ce3ed75ab | overcloud-controller-0 | ACTIVE | - | Running | ctlplane=192.168.126.108   |
+--------------------------------------+------------------------+--------+------------+-------------+---------------+</pre>
<h3>Troubleshooting</h3>
<h4>Introspection Issues</h4>
<p>Sometimes introspection may fail. Unfortunately there is no good way of ending the process. To cancel introspection follow the following steps:</p>
<pre style="padding-left:30px;">[stack@undercloud ~]$ ironic node-set-power-state [NODE UUID] off</pre>
<pre style="padding-left:30px;">[stack@undercloud ~]$ sudo rm /var/lib/ironic-discoverd/discoverd.sqlite</pre>
<pre style="padding-left:30px;">[stack@undercloud ~]$ sudo systemctl restart openstack-ironic-discoverd</pre>
<p>Additionally you can change the discovery timeouty by editing the following file:</p>
<pre style="padding-left:30px;">[stack@undercloud ~]$ sudo vi /etc/ironic-discoverd/discoverd.conf</pre>
<p>Note: ensure you use rtl8139 network driver and not virtio if using KVM. The performance of rtl8139 is much better and using virtio will cause PXE timeouts.</p>
<h3>Summary</h3>
<p>In this article we have seen how to configure Ironic profiles, customize overcloud deployment and add additional compute resources dynamically. The real value of an OpenStack deployment tool is in its ability to create true environment stability. Anyone can install OpenStack and make it look pretty but maintaining it is a completely different story. I would put my money on the latter. Hopefully you found this article of use. As always feedback is welcome so let's hear it!</p>
<p>Happy OpenStacking!</p>
<p>(c) 2015 Keith Tenzer</p>

        
      </section>

      <footer class="page__meta">
        
        
  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      <a href="/tags/#heat" class="page__taxonomy-item" rel="tag">Heat</a><span class="sep">, </span>
    
      <a href="/tags/#ironic" class="page__taxonomy-item" rel="tag">Ironic</a><span class="sep">, </span>
    
      <a href="/tags/#kilo" class="page__taxonomy-item" rel="tag">Kilo</a><span class="sep">, </span>
    
      <a href="/tags/#openstack-director" class="page__taxonomy-item" rel="tag">OpenStack Director</a><span class="sep">, </span>
    
      <a href="/tags/#tripleo" class="page__taxonomy-item" rel="tag">TripleO</a>
    
    </span>
  </p>




  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      <a href="/categories/#openstack" class="page__taxonomy-item" rel="tag">OpenStack</a>
    
    </span>
  </p>


        

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2015-11-09T00:00:00-08:00">November 9, 2015</time></p>


      </footer>

      <section class="page__share">
  
    <h4 class="page__share-title">Share on</h4>
  

  <a href="https://twitter.com/intent/tweet?via=keithtenzer&text=Advanced+Deployment+with+TripleO+and+OpenStack+Director%20http%3A%2F%2Flocalhost%3A4000%2Fopenstack%2Fadvanced-deployment-with-tripleo-and-openstack-director%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Flocalhost%3A4000%2Fopenstack%2Fadvanced-deployment-with-tripleo-and-openstack-director%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=http%3A%2F%2Flocalhost%3A4000%2Fopenstack%2Fadvanced-deployment-with-tripleo-and-openstack-director%2F" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/openstack/howto-openstack-deployment-using-tripleo-and-the-red-hat-openstack-director/" class="pagination--pager" title="HOWTO: OpenStack Deployment using TripleO and the Red Hat OpenStack Director
">Previous</a>
    
    
      <a href="/cloudforms/detecting-security-vulnerabilities-in-docker-container-images/" class="pagination--pager" title="Detecting Security Vulnerabilities in Docker Container Images
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">You may also enjoy</h4>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/openshift/building-ansible-operators-1-2-3/" rel="permalink">Building Ansible Operators 1-2-3
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i>
        
        <time datetime="2021-12-03T00:00:00-08:00">December 3, 2021</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-fw fa-clock" aria-hidden="true"></i>
        
          9 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Overview
In this article we will go step by step in build a Kubernetes Operator using Ansible and the Operator Framework. Operators provide ability to not on...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/openshift/openshift-service-mesh-getting-started-guide/" rel="permalink">OpenShift Service Mesh Getting Started Guide
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i>
        
        <time datetime="2021-04-27T00:00:00-07:00">April 27, 2021</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-fw fa-clock" aria-hidden="true"></i>
        
          11 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">






Overview
In this article we will explore the OpenShift Service Mesh and deploy a demo application to better understand the various concepts. First you...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/openshift/openshift-4-aws-ipi-installation-getting-started-guide/" rel="permalink">OpenShift 4 AWS IPI Installation Getting Started Guide
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i>
        
        <time datetime="2021-01-18T00:00:00-08:00">January 18, 2021</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-fw fa-clock" aria-hidden="true"></i>
        
          8 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">


Happy new year as this will be the first post of 2021! 2020 was obviously a challenging year, my hope is I will have more time to devote to blogging in 20...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/ansible/windows-automation-with-ansible-getting-started-guide/" rel="permalink">Windows Automation with Ansible: Getting Started Guide
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i>
        
        <time datetime="2020-05-19T00:00:00-07:00">May 19, 2020</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-fw fa-clock" aria-hidden="true"></i>
        
          14 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">
Overview
In this article we will focus on how to get started with automation of windows using Ansible. Specifically we will look at installing 3rd party sof...</p>
  </article>
</div>

        
      </div>
    </div>
  
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    

    
      
        
          <li><a href="https://twitter.com/keithtenzer"" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li>
        
      
        
      
        
          <li><a href="https://github.com/ktenzer" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
        
      
        
      
        
      
        
      
    

    
      <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
    
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2021 Keith Tenzer. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>







  </body>
</html>
