<h2><img class="alignnone wp-image-9855" src="/assets/2017/05/redhatvirtual-8648b589ea764898.jpeg" alt="redhatvirtual-8648b589ea764898" width="492" height="277" /></h2>
<h2>Overview</h2>
<p>In this article we will setup a Red Hat Enterprise Virtualization (RHV) environment. RHV is based on upstream opensource projects <a href="https://www.linux-kvm.org/page/Main_Page">KVM </a>and <a href="https://www.ovirt.org/">Ovirt</a>. RHV is composed of Red Hat Enterprise Linux (RHEL which includes KVM) and Red Hat Enterprise Virtualization Management (RHV-M), based on Ovirt. As of this article the latest version is RHV 4.1.</p>
<p>RHV has of late become very interesting to customers looking for alternatives to VMware. Below are a few reasons why you should be interested in RHV:</p>
<ul>
<li>100% opensource no proprietary code and no proprietary licencing.</li>
<li>Best Hypervisor for running Red Hat Enterprise Linux (RHEL).</li>
<li>Integrated and built with RHEL, uses SELinux to secure Hypervisor.</li>
<li><a href="https://www.redhat.com/en/files/resources/en-rhev-performance-specvirt-11055197.pdf">RHV leads VMware in SPECvirt performance and price per performance (last results 2013)</a>.</li>
<li>RHV scales vertically and performs extremely well on 4 or even 8 socket servers.</li>
<li>All features are included in RHV subscription, no licensing for extra capabilities.</li>
<li>KVM is future proof and is the defacto standard for OpenStack and modern virtualizations platforms.</li>
</ul>
<p><!--more--></p>
<h2>Preparation</h2>
<p>In this configuration I am using two physical servers. Each has a dual-core CPU and 16GB RAM. Specifically I am using two <a href="https://www.amazon.com/Intel-NUC5CPYH-Graphics-2-5-Inch-BOXNUC5CPYH/dp/B00XPVRR5M/ref=sr_1_3?s=pc&amp;ie=UTF8&amp;qid=1493724242&amp;sr=1-3&amp;keywords=intel+nuc">Intel NUC</a>s which make a great, portable lab environments. In my environment I named the Hypervisor hosts rhevh01.lab and rhevh02.lab.</p>
<p><strong>[RHEVH01 and RHEVH02]</strong></p>
<p><strong>Install RHEL 7.3 on both nodes.</strong></p>
<p><strong>Enable subscription and configure repositories.</strong></p>
<pre># subscription-manager register
# subscription-manager list --available
# subscription-manager attach --pool=
# subscription-manager repos --disable=*
# subscription-manager repos --enable=rhel-7-server-rpms \ 
--enable=rhel-7-server-rhv-4.1-mgmt-agent-rpms</pre>
<p><strong>Disable firewalld and NetworkManager</strong></p>
<pre># systemctl stop firewalld
# systemctl disable firewalld
# systemctl stop NetworkManager
#systemctl disable NetworkManager</pre>
<p><strong>Update.</strong></p>
<pre>#yum update -y
#systemctl reboot</pre>
<p><strong>Configure NFS.</strong></p>
<p>RHV requires shared storage in order to cluster Hypervisors. In this case we will expose the local storage of both nodes as NFS shares.</p>
<pre># yum install nfs-utils rpcbind
# systemctl enable rpcbind
# systemctl enable nfs-server
# systemctl start rpcbind
# systemctl start nfs-server</pre>
<p><strong>Configure and export NFS share.</strong></p>
<pre># mkdir /usr/share/rhev
# chown -R 36:36 /usr/share/rhev
# chmod -R 0755 /usr/share/rhev</pre>
<pre># vi /etc/exports 
/usr/share/rhev 192.168.2.0/24(rw)</pre>
<pre># exportfs -a</pre>
<h2>RHV Installation</h2>
<p>There are two different installations approaches for the hypervisor and management. RHV as mentioned earlier consists of the Hypervisor host(s) (RHEL + KVM) and a system running the management software (RHV-M).</p>
<p><strong>Hypervisor Options</strong></p>
<ul>
<li>Use RHEL</li>
<li>Use RHEV-H (Based on RHEL but designed to run as a Hypervisor, only software required for running Hypervisor installed)</li>
</ul>
<p><strong>RHV-M Options</strong></p>
<ul>
<li>Install RHV-M on separate VM or physical server.</li>
<li>Use Hosted-engine which deploys RHV-M on the actual RHV cluster. In this example we will choose hosted-engine and this is my personal preference because RHV-M automatically gets all the capabilities and benefits of running on RHV, such as HA.</li>
</ul>
<h2>Install hosted engine</h2>
<p><strong>[RHEVH01]</strong></p>
<p><strong>Install hosted-engine software and dependencies.</strong></p>
<pre>[root@rhevh01 ~]# yum install -y ovirt-hosted-engine-setup
[root@rhevh01 ~]# yum install -y rhevm-appliance</pre>
<p><strong>Install screen for using with setup.</strong></p>
<pre># yum -y install screen</pre>
<p><strong>Start screen session.</strong></p>
<p>This is used in event you have network connection issue during setup.</p>
<pre># screen</pre>
<p><strong>Deploy hosted-engine on hypervisor host.</strong></p>
<pre># hosted-engine --deploy</pre>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p><strong>Select nfs3 for storage and configure OVF using cloud-init</strong></p>
<p>[ INFO ] Stage: Setup validation</p>
<p>--== CONFIGURATION PREVIEW ==--</p>
<p>Bridge interface : eno1<br />
Engine FQDN : rhevm.lab<br />
Bridge name : ovirtmgmt<br />
Host address : rhevh01.lab<br />
SSH daemon port : 22<br />
Firewall manager : iptables<br />
Gateway address : 192.168.0.1<br />
Host name for web application : hosted_engine_1<br />
Storage Domain type : nfs3<br />
Host ID : 1<br />
Image size GB : 50<br />
Storage connection : 192.168.0.21:/usr/share/rhev<br />
Console type : vnc<br />
Memory size MB : 4096<br />
MAC address : 00:16:3e:3c:79:9b<br />
Boot type : disk<br />
Number of CPUs : 2<br />
OVF archive (for disk boot) : /usr/share/ovirt-engine-appliance/rhevm-appliance-4.0.20170307.0-1.el7ev.ova<br />
Appliance version : 4.0.20170307.0-1.el7ev<br />
Restart engine VM after engine-setup: True<br />
CPU Type : model_Haswell-noTSX</p>
<p>Please confirm installation settings (Yes, No)[Yes]:</p>
<p>Note: If deployment fails it may be because of conflict in version of ebtables.</p>
<p><strong>Check if you have ebtables version &gt; 2.0.10-13 (optional).</strong></p>
<pre>qpm -qa | grep ebtables</pre>
<pre># yum downgrade ebtables-2.0.10-13.el7.x86_64</pre>
<h2>Configure RHV cluster in RHV-M</h2>
<p>Once we have installed the hosted-engine we can complete the setup and configure both nodes in a RHV cluster.</p>
<p><strong>[RHV-M Console]</strong></p>
<p><strong>Connect to RHV-M management console.</strong></p>
<p>Note: The hostname of RHV-M not IP needs to be used to access the management console.</p>
<p>http://rhevm.lab/ovirt-engine</p>
<p><img class="alignnone size-full wp-image-9556" src="/assets/2017/05/rhevm_login.jpg" alt="rhevm_login" width="1102" height="846" /></p>
<p>Select Datacenter-&gt;Hosts-&gt;New.</p>
<p><img class="alignnone size-full wp-image-9558" src="/assets/2017/05/rhevm_add_host.jpg" alt="rhevm_add_host" width="736" height="707" /></p>
<p>RHV-M will configure the second node and bring it into the cluster.</p>
<p><img class="alignnone size-full wp-image-9559" src="/assets/2017/05/rhevm_hypervisor_installed.jpg" alt="rhevm_hypervisor_installed" width="1218" height="164" /></p>
<p><strong>Add iptables rules to allow NFS.</strong></p>
<p>This is specific to this setup as we are cheap and lazy. We are using local disks on Hypervisor hosts for storage.</p>
<p><strong>[RHEVH01 and RHEVH02]</strong></p>
<pre># vi /etc/sysconcfig/iptables

#NFS
 -A INPUT -p tcp -m tcp --dport 2049 -j ACCEPT
 -A INPUT -p tcp -m tcp --dport 32803 -j ACCEPT
 -A INPUT -p tcp -m tcp --dport 32769 -j ACCEPT
 -A INPUT -p tcp -m tcp --dport 892 -j ACCEPT
 -A INPUT -p udp -m udp --dport 892 -j ACCEPT
 -A INPUT -p tcp -m tcp --dport 875 -j ACCEPT
 -A INPUT -p udp -m udp --dport 875 -j ACCEPT
 -A INPUT -p udp -m udp --dport 662 -j ACCEPT
 -A INPUT -p udp -m udp --dport 662 -j ACCEPT</pre>
<p><strong>Restart iptables.</strong></p>
<pre># systemctl restart iptables</pre>
<h2>Configure Storage Domains</h2>
<p>RHV has three types of storage domains: Data, ISO and Export.</p>
<ul>
<li>Data are for VM disks.</li>
<li>ISOs are what they say, for storing ISO images.</li>
<li>Export is for OVA or virtual machine templates.</li>
</ul>
<p>Storage domain's also play key roll in clustering and are used as quorum. One data storage domain will be the master.</p>
<p><strong>Add Data Storage Domain from RHEVH01.</strong></p>
<p>Select Datacenter-&gt;Storage-&gt;New</p>
<p><img class="alignnone size-full wp-image-9571" src="/assets/2017/05/rhevm_add_storage_domain.jpg" alt="rhevm_add_storage_domain" width="746" height="654" /></p>
<p><img class="alignnone size-full wp-image-9572" src="/assets/2017/05/rhevm_storage_domain_added.jpg" alt="rhevm_storage_domain_added" width="1192" height="160" /></p>
<p><img class="alignnone size-full wp-image-9574" src="/assets/2017/05/rhevm_datacenter.jpg" alt="rhevm_datacenter" width="953" height="119" /></p>
<p><strong>Add Data Storage Domain from RHEVH02.</strong></p>
<p>Select Datacenter-&gt;Storage-&gt;New</p>
<p><img class="alignnone size-full wp-image-9577" src="/assets/2017/05/rhevm_second_storage_domain1.jpg" alt="rhevm_second_storage_domain" width="755" height="649" /></p>
<p><strong>Add ISO Storage Domain from RHEVH01.</strong></p>
<p>Select Datacenter-&gt;Storage-&gt;New</p>
<p><img class="alignnone size-full wp-image-9583" src="/assets/2017/05/rhevm_iso_domain.jpg" alt="rhevm_iso_domain" width="753" height="651" /></p>
<p><strong>Add Export Storage Domain from RHEVH01.</strong></p>
<p>Select Datacenter-&gt;Storage-&gt;New</p>
<p><img class="alignnone size-full wp-image-9584" src="/assets/2017/05/rhevm_export_domain.jpg" alt="rhevm_export_domain" width="754" height="654" /></p>
<p>If everything worked you should see all the storage domains available.<img class="alignnone size-full wp-image-9586" src="/assets/2017/05/rhevm_all_storage_domains.jpg" alt="rhevm_all_storage_domains" width="1156" height="254" /></p>
<h2>Troubleshooting</h2>
<p>You should never do any of this on a production system! Always work with RH Support. Ok now that we cleared that up lets get into the bowels of RHV.</p>
<p>RHV-M stores state in it's database. It is possible and sometimes needed to access database to cleanup state, especially if you are like me and do something stupid, in this case destroy filesystems housing your RHV storage domains.</p>
<p>As such I have documented how to handle cleaning up any stale storage connections and even how to delete storage domains themselves manually from within database.</p>
<p><strong>[RHV-M Host]</strong></p>
<p><strong>Connect to RHV-M Database.</strong></p>
<pre># source /etc/ovirt-engine/engine.conf.d/10-setup-database.conf
# export PGPASSWORD=${ENGINE_DB_PASSWORD}
# psql -h localhost -U $ENGINE_DB_USER</pre>
<p><strong>Show list of storage connections.</strong></p>
<pre>engine=&gt; select id, connection from storage_server_connections;
 id | connection
 --------------------------------------+------------------------------
 02953919-feb8-49a5-812f-5d6459984ba3 | 192.168.0.21:/usr/share/data
 59037cc9-e0d0-446c-b38c-7e74ed2081cc | 192.168.0.21:/usr/share/rhev
 ee0d0921-338b-4ada-9bc9-28dc8978299d | 192.168.0.22:/usr/share/data
 (3 rows)</pre>
<p><strong>Delete a storage connection.</strong></p>
<pre>engine=&gt; DELETE from storage_server_connections where id='ee0d0921-338b-4ada-9bc9-28dc8978299d';
 DELETE 1</pre>
<p><strong>Cleaning up storage domains.</strong></p>
<p>Storage domains all have a connection listed in the storage_server_connections table. In addition they also exist in storage_domain_static and storage_domain_dynamic tables.</p>
<p><strong>List storage connections.</strong></p>
<pre>engine=&gt; select id, connection from storage_server_connections;
 id | connection
 --------------------------------------+--------------------------------
 02953919-feb8-49a5-812f-5d6459984ba3 | 192.168.0.21:/usr/share/data
 59037cc9-e0d0-446c-b38c-7e74ed2081cc | 192.168.0.21:/usr/share/rhev
 4e1f2603-66cf-4b68-b7db-7aadd74d50e7 | 192.168.0.22:/usr/share/data
 e38d9d3b-26c2-4c5e-96c6-6ee06a2fb4a6 | 192.168.0.21:/usr/share/iso
 6ad3e7ca-305d-44ab-9765-b5c72162def3 | 192.168.0.21:/usr/share/export
 (5 rows)</pre>
<p><strong>Show storage domain ids.</strong></p>
<pre>engine=&gt; select id, storage from storage_domain_static;
 id | storage
 --------------------------------------+--------------------------------------
 a4ba370b-4f28-414e-9620-960bff62fce5 | 02953919-feb8-49a5-812f-5d6459984ba3
 0e142f0b-e934-4b3c-b6ad-8c53b574e303 | 59037cc9-e0d0-446c-b38c-7e74ed2081cc
 d5ed7709-896a-4c33-b758-09ca957844b4 | ee0d0921-338b-4ada-9bc9-28dc8978299d
 788f3e56-a11d-4665-b851-50c95ebee5c5 | b7f4fee9-1bb9-414c-8cfa-3b9cbd95578b
 c3e101f0-ada3-465d-9411-c04e13d7749f | cc5d9f30-5eba-4a24-9212-11c8dff6248b
 7887943f-8860-4079-9679-4530bd525948 | 4e1f2603-66cf-4b68-b7db-7aadd74d50e7
 231d4b20-bc8a-41c7-9e58-226ce4aa26fa | e38d9d3b-26c2-4c5e-96c6-6ee06a2fb4a6
 30621071-3dba-401d-9605-02a914b4069a | 6ad3e7ca-305d-44ab-9765-b5c72162def3
 (8 rows)</pre>
<p><strong>Delete Storage Domains from dynamic table using id.</strong></p>
<p>engine=&gt; delete from storage_domain_dynamic where id = 'd5ed7709-896a-4c33-b758-09ca957844b4';<br />
DELETE 1<br />
engine=&gt; delete from storage_domain_dynamic where id = '788f3e56-a11d-4665-b851-50c95ebee5c5';<br />
DELETE 1<br />
engine=&gt; delete from storage_domain_dynamic where id = 'c3e101f0-ada3-465d-9411-c04e13d7749f';<br />
DELETE 1<br />
engine=&gt; delete from storage_domain_dynamic where id = '7887943f-8860-4079-9679-4530bd525948';<br />
DELETE 1<br />
<strong>Delete Storage Domains from statictable using id.</strong></p>
<pre>engine=&gt; delete from storage_domain_static where id = 'd5ed7709-896a-4c33-b758-09ca957844b4';
 DELETE 1
 engine=&gt; delete from storage_domain_static where id = '788f3e56-a11d-4665-b851-50c95ebee5c5';
 DELETE 1
 engine=&gt; delete from storage_domain_static where id = 'c3e101f0-ada3-465d-9411-c04e13d7749f';
 DELETE 1
 engine=&gt; delete from storage_domain_static where id = '7887943f-8860-4079-9679-4530bd525948';
 DELETE 1
</pre>
<p><strong>Show storage domains.</strong></p>
<pre>engine=&gt; select id, storage from storage_domain_static;
 id | storage
 --------------------------------------+--------------------------------------
 a4ba370b-4f28-414e-9620-960bff62fce5 | 02953919-feb8-49a5-812f-5d6459984ba3
 0e142f0b-e934-4b3c-b6ad-8c53b574e303 | 59037cc9-e0d0-446c-b38c-7e74ed2081cc
 231d4b20-bc8a-41c7-9e58-226ce4aa26fa | e38d9d3b-26c2-4c5e-96c6-6ee06a2fb4a6
 30621071-3dba-401d-9605-02a914b4069a | 6ad3e7ca-305d-44ab-9765-b5c72162def3
 (4 rows)</pre>
<h2>Summary</h2>
<p>In this article we discussed some of the advantages of Red Hat Enterprise Virtualization (RHV). We went through steps to build a basic lab environment. Showed how to configure RHV cluster and add storage domains. Finally we looked at some troubleshooting steps using RHV database. Hopefully you found this article informative. Feedback always appreciated!</p>
<p>Happy RHVing!</p>
<p>(c) 2017 Keith Tenzer</p>
