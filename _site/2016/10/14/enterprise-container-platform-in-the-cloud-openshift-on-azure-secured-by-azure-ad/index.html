<p><img class="alignnone  wp-image-5511" src="/assets/2016/10/msazurelogo.png" alt="msazurelogo" width="318" height="164" /> <img class="alignnone  wp-image-5506" src="/assets/2016/10/plus_sign.gif" alt="plus_sign" width="102" height="102" /> <img class="alignnone  wp-image-5513" src="/assets/2016/10/openshiftlogo.png" alt="openshiftlogo" width="145" height="168" /></p>
<h3>Overview</h3>
<p>This article is a collaboration from Rolf Masuch (Microsoft) and Keith Tenzer (Red Hat). It is based on our work together in the field with enterprise customers.</p>
<p>In this article we will explore how to deploy a production ready OpenShift enterprise container platform on the Microsoft Azure Cloud. The entire deployment is completely automated using Ansible and <a href="https://azure.microsoft.com/en-us/documentation/articles/resource-group-overview/">ARM</a> (Azure Resource Manager). Everything is template driven using APIs. The bennefit of this approach is the ability to build-up and tear-down a complete OpenShift environment in the Azure cloud before your coffee gets cold.</p>
<p>Since OpenShift already uses Ansible as its installation and configuration management tool, it made sense to stick with Ansible as opposed to using other tools such as Power Shell. A Red Hat colleague, Ivan McKinley created an Ansible playbook that builds out all the required Azure infrastructure components and integrates the existing OpenShift installation playbook. The result is an optimally configure OpenShift environment on the Azure Cloud. We have used this recipe to deploy real production Environments for customers and it leverages both Microsoft as well as Red Hat best practices.</p>
<p><!--more--></p>
<p>You can access and contribute improvements to the Ansible playbook under Ivan's Github repository:</p>
<p><a href="https://github.com/ivanthelad/ansible-azure">https://github.com/ivanthelad/ansible-azure</a></p>
<p>The following, related articles might also be of Interest in case you want a basic understanding of OpenShift.</p>
<ul>
<li><a href="https://keithtenzer.com/2016/08/04/openshift-enterprise-3-2-all-in-one-lab-environment/">OpenShift v3.2 All-in-one Lab Environment</a></li>
<li><a href="https://keithtenzer.com/2016/08/11/openshift-v3-basic-release-deployment-scenarios/">OpenShift Basic Release Deployment Scenarios</a></li>
</ul>
<p>The pre-requisites for deploying OpenShift on Azure are a valid OpenShift subscription and a valid Azure subscription.</p>
<ul>
<li>If you don't already have a OpenShift Subscription you can purchase one or get an eval by talking to your partner or Red Hat account manager.</li>
<li>If you don't already have a Microsoft Azure Subscription you can start one <a href="https://azure.microsoft.com/en-us/free/">here</a>.</li>
</ul>
<h3>Deploying to Azure</h3>
<p>Install Fedora 24 workstation for use as deployment workstation. You need very recent versions of python 2.7 (2.7.12) and unfortunately it isn't available in RHEL or CentOS at writing of this article so we used Fedora.</p>
<h4>Install Python and Dependencies</h4>
<pre># sudo yum install python
# sudo yum install python-pip
# sudo dnf install python-devel
# sudo dnf install redhat-rpm-config
# sudo dnf install openssl-devel</pre>
<h4>Install Azure CLI</h4>
<pre># sudo dnf install npm
# sudo npm install azure-cli -g
# sudo pip install --upgrade pip
# sudo pip install azure==2.0.0rc5</pre>
<h4>Authenticate Azure CLI</h4>
<pre>[ktenzer@ktenzer ansible-azure]$ azure login
 info: Executing command login
 \info: To sign in, use a web browser to open the page https://aka.ms/devicelogin. Enter the code CB8P5ZCKP to authenticate.
 -info: Added subscription Pay-As-You-Go
 info: Added subscription ITS - RedHat Openshift
 info: Setting subscription "Pay-As-You-Go" as default
 +
 info: login command OK</pre>
<h4>List Azure Resource Groups</h4>
<p>In order to list resource groups you need your Azure subscription id. You can view this by logging into Azure portal with your user.</p>
<pre>[ktenzer@ktenzer ansible-azure]$ azure group list --subscription &lt;subscription id&gt;
 info: Executing command group list
 + Listing resource groups
 data: Name Location Provisioning State Tags:
 data: ------------- ---------- ------------------ -----
 data: OpenShift_POC westeurope Succeeded null
 data: Shared westeurope Succeeded null
 info: group list command OK</pre>
<h4>Install Ansible Core</h4>
<pre># sudo dnf install ansible</pre>
<h4>Clone OpenShift Azure Ansible Playbooks</h4>
<pre># git clone https://github.com/ivanthelad/ansible-azure.git</pre>
<h4>Update Playbook parameters</h4>
<pre># cd ansible-azure</pre>
<pre># cp group_vars/all_example group_vars/all</pre>
<pre># vi group_vars/all
resource_group_name: &lt;new resource group name&gt;
## Azure AD user.
ad_username: &lt;Azure user e.g. keith.tenzer@domain.onmicrosoft.com&gt;
### Azure AD password
ad_password: &lt;Azure Password&gt;
#### Azure Subscription ID
subscriptionID: "&lt;subscription id from Azure&gt;"
## user to login to the jump host. this user will only be created on the jumphost
adminUsername: &lt;username e.g. ktenzer&gt;
## user pwd for jump host
## Password for the jump host
adminPassword: &lt;password&gt;
##### Public key for jump host
### Access to environment only allowed through jumphost
sshkey: &lt;ssh key e.g. cat /home/ktenzer/.ssh/id_rsa.pub&gt;

# see https://azure.microsoft.com/en-us/documentation/articles/cloud-services-sizes-specs/
### Size for the master
master_vmSize: Standard_DS3_v2
#master_vmSize: Standard_D2_v2
#master_vmSize: Standard_D1_v2

### Size for the nodes
node_vmSize: Standard_DS3_v2
#node_vmSize: Standard_D2_v2
#node_vmSize: Standard_D1_v2

#### Region to deploy in
region: westeurope

## docker info
docker_storage_device: /dev/sdc
create_vgname: docker_vg
filesystem: 'xfs'
create_lvsize: '80%FREE'
#create_lvsize: '2g'

#### subscription information
rh_subscription_user: &lt;Red Hat Subscription User&gt;
rh_subscription_pass: &lt;Red Hat Subscription Password&gt;
openshift_pool_id: &lt;Red Hat Subscription Pool Id&gt;

########### list of node ###########
### Warning, you currently cannot create more infra nodes ####
### this will change in the future
### You can add as many nodes as you want
#####################################
jumphost:
 jumphost1:
 name: jumphost1
 tags:
 region: westeurope
 zone: jumphost
 stage: jumphost

masters:
 master1:
 name: master1
 tags:
 region: westeurope
 zone: infra
 stage: none
 master2:
 name: master2
 tags:
 region: westeurope
 zone: infra
 stage: none
 master3:
 name: master3
 tags:
 region: westeurope
 zone: infra
 stage: none

infranodes:
 infranode1:
 name: infranode1
 tags:
 region: westeurope
 zone: infra
 stage: dev
nodes:
 node1:
 name: node1
 tags:
 region: westeurope
 zone: app
 stage: dev
 node2:
 name: node2
 tags:
 region: westeurope
 zone: app
 stage: dev</pre>
<h4>Run Ansible Playbook</h4>
<pre># ansible-playbook --forks=50 -i inventory.azure playbooks/setup_multimaster.new.yml</pre>
<h4>Connect to OpenShift environment</h4>
<p>In order to connect to OpenShift environment you need to access jump box. The public IP of jumpbox will be set during playbook run, simply look at outputs to get the public IP for jumpbox.</p>
<p><strong>Connect to jumphost</strong></p>
<pre># ssh -i /home/ktenzer/.ssh/id_rsa.pub ktenzer@&lt;jumphost public IP&gt;</pre>
<p><strong>Connect to master1</strong></p>
<p>There are three masters and you can connect and manage environment from any of them.</p>
<pre>[ktenzer@jumphost1 ~]$ ssh master1</pre>
<p><strong>Login as built-in system:admin user</strong></p>
<pre>[ktenzer@master1 ~]$ oc login -u system:admin</pre>
<p><strong>List OpenShift nodes</strong></p>
<pre>[ktenzer@master1 ~]$ oc get nodes
NAME                                                       STATUS AGE
infranode1.KgsZ98734738nshjdsj2.ax.internal.cloudapp.net   Ready  34d
master1.KgsZ98734738nshjdsj2.ax.internal.cloudapp.net      Ready 34d
master2.KgsZ98734738nshjdsj2.ax.internal.cloudapp.net      Ready 34d
master3.KgsZ98734738nshjdsj2.ax.internal.cloudapp.net      Ready 34d
node1.KgsZ98734738nshjdsj2.ax.internal.cloudapp.net        Ready 34d
node2.KgsZ98734738nshjdsj2.ax.internal.cloudapp.net        Ready 34d</pre>
<p>The deployment defaults to a highly available three master node OpenShift cluster. It also deploys three nodes, one for infrastructure and other two for applications. Ideally you would want a second infrastructure node so infrastructure services such as routing, image registry, logging and metrics are also highly available. Adding additional nodes is simply a matter of updating the playbook and re-running it. In addition changing OpenShift configuration is also just matter of updating playbook and re-running it.</p>
<p>In order to access the UI get the public URL from the master configuration file. When accessing the public URL traffic is balanced across all three OpenShift master servers.</p>
<pre>[root@master1 ~]# cat /etc/origin/master/master-config.yaml |grep masterPublicURL 
masterPublicURL: https://master-&lt;Resource Group&gt;.westeurope.cloudapp.azure.com:8443</pre>
<h3>Azure AD Authentication</h3>
<p>OpenShift like most platforms has two layers that govern access to the environment. Authentication grants a user access to the platform and authorization gives a user privileges within the environment. OpenShift supports many authentication providers. In the case of Azure AD openId is used for authentication and OpenShift offloads authentication entirely to Azure AD. Any user permitted to access the OpenShift authentication application in Azure AD is permitted to login to the OpenShift environment. Once a user in Azure AD authenticates to OpenShift, privileges can be given at project level to allow the user access within the environment. We will first configure Azure AD by setting up an authentication application and then allowing access within Azure. Once that is configured we will go through steps to allow OpenShift to use the Azure AD authentication application. Finally we will show how user management works within OpenShift when using Azure AD as authentication provider.</p>
<h2>Configure Azure AD Application for OpenShift</h2>
<p><span lang="en">The following steps describe how to create an Azure WebApp as your authentication barrier, before accessing the OpenShift Admin portal.</span></p>
<p><span lang="en">Since you already have installed OpenShift into Azure the normal disclaimers about getting a subscription do not apply here. In case you are just reading through and want to do more in Azure this is the link: </span><a href="http://www.Azure.com/"><span lang="en">http://www.Azure.com</span></a></p>
<p><strong>Create Application</strong></p>
<p><span lang="en">To create the application, log in to the Azure portal </span><a href="https://portal.azure.com/"><span lang="en">https://portal.azure.com</span></a><span lang="en"> and click on the plus symbol (1), then on Web + mobile (2) and finally on Web App (3).</span></p>
<p><img class="alignnone size-full wp-image-5372" src="/assets/2016/10/azure_1.png" alt="azure_1" width="1374" height="659" /></p>
<p><span lang="en">This will open another part on the screen that needs to be filled with further details about the new Web App. These parts are called blades and are used in the Azure portal to present details and configuration options. The first box takes (1) the application name that will become part of the DNS Name of the application. It needs to be unique within the namespace of azurewebsites.net. Your subscription in the following dropdown should be pre-filled. The next option, Resource Group, should be set to“Use existing” from the dropdown (2) and should point to the resource group where your OpenShift installation resides. Special attention is needed for the App Service plan and its location (3). The default location may need adjustment. Click on the tile to configure your service plan. After that click on create at the bottom of the blade to create your Web App. You may want to tick the checkbox “Pin to dashboard” for easier access later.</span></p>
<p><img class="alignnone size-full wp-image-5375" src="/assets/2016/10/azure_2.png" alt="azure_2" width="604" height="835" /></p>
<p><strong>Enable Authentication for Application</strong></p>
<p><span lang="en">When your application has been deployed click on it to access its blade and continue with the configuration by clicking on Authentication/Authorization in the settings.</span></p>
<p><img class="alignnone size-full wp-image-5378" src="/assets/2016/10/azure_3.png" alt="azure_3" width="453" height="211" /></p>
<p><span lang="en">The right side of the blade will change and you can click on the button for App Service Authentication (1) to turn it on. The dropdown for the Authentication providers should show “Log in with Azure Active Directory” (2). Click on the tile below (3) to configure the Azure Active Directory details.</span></p>
<p><img class="alignnone size-full wp-image-5381" src="/assets/2016/10/azure_4.png" alt="azure_4" width="1079" height="661" /></p>
<p><span lang="en">In the Azure Active Directory Settings dialog select the Management mode option (1) “Express”. The Current Active Directory (2) should read your own Azure Active Directory name. In the lower part of the dialog the button “Create New AD App” is pre-selected and you can provide an additional application name under “Create App”. By default it can be the same as the Web App name. After that click on OK at the bottom of the blade.</span></p>
<p><img class="alignnone size-full wp-image-5384" src="/assets/2016/10/azure_5.png" alt="azure_5" width="1120" height="884" /></p>
<p><img class="alignnone size-full wp-image-5386" src="/assets/2016/10/azure_6.png" alt="azure_6" width="1084" height="202" /></p>
<p><span lang="en">Don’t forget to click on Save at the top of the blade.</span></p>
<p><img class="alignnone size-full wp-image-5388" src="/assets/2016/10/azure_7.png" alt="azure_7" width="512" height="183" /></p>
<p><span lang="en">Now that the Web App part is finished you can close all the blades and return to the dashboard. The next steps are done in the new Azure Active Directory blade.</span></p>
<p><img class="alignnone size-full wp-image-5392" src="/assets/2016/10/azure_8.png" alt="azure_8" width="404" height="84" /></p>
<p><strong>Configure Azure AD for Application</strong></p>
<p><span lang="en">When you click on it the new blade should open with your existing Azure Active Directory details and the tile App registrations should read “1”. Click on that tile to continue.</span></p>
<p><img class="alignnone size-full wp-image-5395" src="/assets/2016/10/azure_9.png" alt="azure_9" width="1120" height="955" /></p>
<p><span lang="en"><span style="color:#00ffff;"><span style="color:#3366ff;">Click on Endpoints in order to retrieve the Azure Tenant Id. It is the number after the https://login.windows.net part. Take note of the tenant id as it is needed in the OpenShift configuration</span><span style="color:#0000ff;">. </span></span>Click on the Application you configured in the step before to access its details and configuration options.</span></p>
<p><img class="alignnone size-full wp-image-5398" src="/assets/2016/10/azure_10.png" alt="azure_10" width="1129" height="403" /></p>
<p><span lang="en" style="color:#0000ff;">In the settings blade of your app click on Properties (1) to access the applications Application ID. You need this information as well to configure OpenShift to make use of the Azure AD authentication.</span></p>
<p><img class="alignnone size-full wp-image-5401" src="/assets/2016/10/azure_11.png" alt="azure_11" width="1778" height="796" /></p>
<p><img class="alignnone size-full wp-image-5403" src="/assets/2016/10/azure_12.png" alt="azure_12" width="1209" height="1456" /></p>
<p><span lang="en"><span style="color:#0000ff;">Close the Properties blade and click on Keys (2) in the Settings blade to create an individual access key. This key is also needed for the OpenShift configuration.</span> Add a key description (1), select a duration of one or two years or even unlimited live time under (2) and click on save. Pay special attention to the warning displayed about the key that is now shown in the value (4). Copy that key and verify that it is stored properly somewhere else before leaving that blade!</span></p>
<p><img class="alignnone size-full wp-image-5406" src="/assets/2016/10/azure_13.png" alt="azure_13" width="2112" height="799" /></p>
<p><img class="alignnone size-full wp-image-5409" src="/assets/2016/10/azure_14.png" alt="azure_14" width="1314" height="376" /></p>
<p><span lang="en">In general, when you add the gathered information into OpenShift, all access to the URL of the installation will now be verified through Azure Active Directory authentication. In case you want to limit the usage to a certain group of users or even individual users you can configure this also but currently only in the Classic Azure portal under </span><span lang="en"><a href="https://manage.windowsazure.com/">https://manage.windowsazure.com</a>.</span></p>
<p><span lang="en">You may have to sign out and sign in again to access the portal. Once you have signed in, scroll to the Azure Active directory icon and click on the name of your Azure AD to access the dashboard.</span></p>
<p><img class="alignnone size-full wp-image-5411" src="/assets/2016/10/azure_15.png" alt="azure_15" width="421" height="161" /></p>
<h2><strong>Enable User Access to Applications Azure AD</strong></h2>
<p><span lang="en">Click on APPLICATIONS (1), search (2) for your application in case there are more than one and click on your applications name (3) to go to its properties.</span></p>
<p><img class="alignnone size-full wp-image-5414" src="/assets/2016/10/azure_16.png" alt="azure_16" width="1779" height="433" /></p>
<p><span lang="en">In the properties click on “CONFIGURE” and toggle the button “USER ASSIGNMENT REQUIRED TO ACCESS APP” to “YES” and click on “SAVE” at the bottom of the page.</span></p>
<p><img class="alignnone size-full wp-image-5416" src="/assets/2016/10/azure_17.png" alt="azure_17" width="858" height="180" /></p>
<p><img class="alignnone size-full wp-image-5418" src="/assets/2016/10/azure_18.png" alt="azure_18" width="1220" height="266" /></p>
<p><span lang="en">Now that the application is toggled users and/or groups need to be assigned to it. You configure that under “USERS AND GROUPS” on the same page. </span></p>
<p><img class="alignnone size-full wp-image-5421" src="/assets/2016/10/azure_19.png" alt="azure_19" width="1824" height="405" /></p>
<p><span lang="en">Select one of your users, click on assign at the bottom of the page and confirm the dialog. Verify the access by opening a new browser window in private mode and navigate to the OpenShift URL. You should be prompted with an authentication dialog from your Azure AD.</span></p>
<p><img class="alignnone size-full wp-image-5423" src="/assets/2016/10/azure_20.png" alt="azure_20" width="1652" height="73" /></p>
<p><img class="alignnone size-full wp-image-5426" src="/assets/2016/10/azure_21.png" alt="azure_21" width="131" height="113" /></p>
<p><img class="alignnone size-full wp-image-5428" src="/assets/2016/10/azure_22.png" alt="azure_22" width="2264" height="106" /></p>
<h4>Configure OpenShift for Azure AD Authentication</h4>
<p>OpenShift supports many identity providers. In this case we are using OpenId to authenticate users against Azure AD. In order to configure Azure AD authentication in OpenShift the following information from Azure AD is required:</p>
<ul>
<li><span style="color:#0000ff;">Tenant Id - The tenant id from any of the endpoint URLs</span></li>
<li><span style="color:#0000ff;">Client Id - The Application Id from Azure AD Application</span></li>
<li><span style="color:#0000ff;">Client Secret Key - The key that was created for the Application in Azure AD</span><span style="color:#3366ff;"><br />
</span></li>
</ul>
<p><strong>Configure OpenId Provider</strong></p>
<p>This information should have been captured from the steps above. On all three OpenShift masters edit the master configuration and add openId provider.</p>
<pre>[root@master1 ~]# vi /etc/origin/master/master-config.yaml
identityProviders:
 - name: openId
 challenge: false
 login: true
 mappingMethod: claim
 provider:
 apiVersion: v1
 kind: OpenIDIdentityProvider
 <span style="color:#0000ff;">clientID: &lt;client id&gt;</span>
 <span style="color:#0000ff;">clientSecret: &lt;client secret key&gt;</span>
 claims:
 id:
 - sub
 preferredUsername:
 - preferred_username
 name:
 - name
 email:
 - email
 urls:
 authorize: https://login.microsoftonline.com/<span style="color:#0000ff;">&lt;tenant id</span>&gt;/oauth2/authorize
 token: https://login.microsoftonline.com/<span style="color:#0000ff;">&lt;tenant id&gt;</span>/oauth2/token</pre>
<p>Restart OpenShift on all masters.</p>
<pre>[root@master1 ~]# systemctl restart atomic-openshift-master-api
[root@master1 ~]# systemctl restart atomic-openshift-master-controllers</pre>
<pre>[root@master2 ~]# systemctl restart atomic-openshift-master-api
[root@master2 ~]# systemctl restart atomic-openshift-master-controllers</pre>
<pre>[root@master3 ~]# systemctl restart atomic-openshift-master-api
[root@master3 ~]# systemctl restart atomic-openshift-master-controllers</pre>
<p><strong>Login as Azure AD user</strong></p>
<p><strong>Using the GUI</strong></p>
<p><span lang="en">Verify the access by opening a new browser window in private mode and navigate to the OpenShift URL </span>https://master-Resource-Group.westeurope.cloudapp.azure.com:8443<span lang="en">. You should be prompted with an authentication dialog of your Azure AD.</span></p>
<p><strong>Using the CLI</strong></p>
<p>[root@master1 ~]# oc login -u keith.tenzer@mydomain.onmicrosoft.com -n default<br />
Login failed (401 Unauthorized)<br />
You must obtain an API token by visiting https://master-Resource_Group.westeurope.cloudapp.azure.com:8443/oauth/token/request</p>
<pre>[root@master1 ~]# oc login --token=0h9tKLlTicyAr5dYIgW5xiejiMVHIvltEuX6LLVW8CY --server=https://master-Resource-Group.westeurope.cloudapp.azure.com:8443
 Logged into "https://master-&lt;resource group&gt;.westeurope.cloudapp.azure.com:8443" as "G374shPb01h2jwssdjhGhghsghGHJSK" using the token provided.</pre>
<p>Notice that the user is actually known to OpenShift is "G374shPb01h2jwssdjhGhghsghGHJSK" not  keith.tenzer@mydomain.onmicrosoft.com</p>
<p><strong>List OpenShift users</strong></p>
<p>Once Azure AD users login they are automatically added to OpenShift.</p>
<pre>[root@master ~]# oc get users
 NAME                                        UID                                   FULL NAME    IDENTITIES
 G374shPb01h2jwssdjhGhghsghGHJSK             1245fec9f-598f-1656-12as-123g4g936742 Keith Tenzer openId:G374shPb01h2jwssdjhGhghsghGHJSK</pre>
<p><strong>List OpenShift identities</strong></p>
<pre>[root@master ~]# oc get identity
NAME                                               IDP    NAME                                       IDP USER NAME                   USER NAME                                   USER UID
openId:G374shPb01h2jwssdjhGhghsghGHJSK             openId FGnyqZlyGFzNCI99feUypSdEoNapBAJ03tg5MWlDSZ G374shPb01h2jwssdjhGhghsghGHJSK 1245fec9f-598f-1656-12as-123g4g936742</pre>
<p><strong>Give Azure AD user cluster-admin permission</strong></p>
<pre>[root@master ~]# oadm policy add-cluster-role-to-user cluster-admin "G374shPb01h2jwssdjhGhghsghGHJSK"</pre>
<p><strong>Give user permission to project</strong></p>
<pre>[root@master ~]# oadm policy add-role-to-user admin "G374shPb01h2jwssdjhGhghsghGHJSK" -n test</pre>
<p><strong>Remove Azure AD user from OpenShift</strong></p>
<p>Delete user</p>
<pre>[root@master ~]# oc delete user G374shPb01h2jwssdjhGhghsghGHJSK</pre>
<p>Delete identity</p>
<pre>[root@master ~]# oc delete identity openId:G374shPb01h2jwssdjhGhghsghGHJSK</pre>
<h3>Summary</h3>
<p>In this article we have detailed how to standup a production-ready OpenShift environment automatically, before your coffee gets cold in the Azure Cloud. We have seen how to integrate OpenShift into Azure AD for authentication. There is no doubt, container platforms are the future for applications. Container technology enables application to be developed and deployed at much faster speeds, greatly improving a organizations ability to innovate and connect to it's market segment. Many enterprises are interested in getting their hands on these technologies and evaluating them rather quickly. There is no faster way then standing up OpenShift in the Azure cloud! We hope you found this article interesting and look forward to your feedback.</p>
<p>Happy OpenShifting in the Azure Cloud!</p>
<p>(c) 2016 Keith Tenzer and Rolf Masuch</p>
