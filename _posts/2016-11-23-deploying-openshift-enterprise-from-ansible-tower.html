---
layout: single 
title: Deploying OpenShift Enterprise from Ansible Tower
categories:
- OpenShift
tags:
- Ansible 
- Tower 
- Automation 
- OpenShift 
- Kubernetes 
---
<h3><img class="alignnone  wp-image-6050" src="{{ site.baseurl }}/assets/2016/11/ansible-tower-logotype-large-rgb-fullgrey-300x124.png" alt="ansible-tower-logotype-large-rgb-fullgrey-300x124" width="375" height="155" /> <img class="alignnone  wp-image-5506" src="{{ site.baseurl }}/assets/2016/11/plus_sign.gif" alt="plus_sign" width="113" height="113" /> <img class="alignnone  wp-image-5513" src="{{ site.baseurl }}/assets/2016/11/openshiftlogo.png" alt="openshiftlogo" width="148" height="172" /></h3>
<h3>Overview</h3>
<p>In this article we will look at how to use Ansible Tower to deploy and manage OpenShift environments. OpenShift of course uses Ansible as its deployment and configuration tool already. While that is great, using Tower provides several major advantages:</p>
<ul>
<li>UI for OpenShift deployment and configuration management</li>
<li>Secure store for credentials</li>
<li>RBAC and ability to delegate different responsibilities for OpenShift deployments</li>
<li>Easy to visualize and manage multiple OpenShift environments and even versions of OpenShift</li>
<li>History, audit trail and detailed logging in central location for all OpenShift environments and deployments</li>
</ul>
<p><!--more--></p>
<h3>Prepare OpenShift Environment</h3>
<p>In this example we will be doing an all-in-one deployment of OpenShift. The following steps should be done on OpenShift masters and nodes. Again here we just have one node since it is an all-in-one.</p>
<h4>CONFIGURE A VMs WITH FOLLOWING:</h4>
<ul>
<li>RHEL 7.2</li>
<li>2 CPUs</li>
<li>4096 RAM</li>
<li>30GB disk for OS</li>
<li>25GB disk for docker images</li>
</ul>
<h4>REGISTER VALID SUBSCRIPTION</h4>
<pre># subscription-manager register</pre>
<pre># subscription-manager attach --pool=843298293829382</pre>
<pre class="nowrap"># subscription-manager repos --disable="*"</pre>
<pre class="nowrap">#subscription-manager repos \
    --enable="rhel-7-server-rpms" \
    --enable="rhel-7-server-extras-rpms" \
    --enable="rhel-7-server-ose-3.3-rpms"</pre>
<h4>INSTALL REQUIRED TOOLS</h4>
<pre class="nowrap"># yum install -y wget git net-tools bind-utils iptables-services bridge-utils bash-completion</pre>
<h4>UPDATE</h4>
<pre class="nowrap"># yum update -y</pre>
<h4>RESTART OPENSHIFT MASTER</h4>
<pre class="nowrap"># systemctl reboot</pre>
<h4>CONFIGURE DOCKER</h4>
<pre class="nowrap"># yum install -y docker-1.10.3</pre>
<h4>ENABLE DOCKER DAEMON TO PULL FROM OPENSHIFT REGISTRY</h4>
<pre># vi /etc/sysconfig/docker
OPTIONS='--selinux-enabled --insecure-registry 172.30.0.0/16'</pre>
<h4>SETUP DOCKER STORAGE FOR OPENSHIFT REGISTRY</h4>
<p>Note: we will use the second disk for configuring docker storage.</p>
<pre class="nowrap"># cat &lt;&lt;EOF &gt; /etc/sysconfig/docker-storage-setup
DEVS=/dev/vdb
VG=docker-vg
EOF</pre>
<pre class="nowrap"># docker-storage-setup</pre>
<h4>ENABLE AND START DOCKER DAEMON</h4>
<pre># systemctl enable docker</pre>
<pre># systemctl start docker</pre>
<h3>Import OpenShift inventory into Ansible Tower</h3>
<p>These steps should be done directly on the host running Ansible Tower.</p>
<h4>Create Inventory in Ansible Tower</h4>
<p>Under inventories add a new inventory.</p>
<p><img class="alignnone size-full wp-image-6025" src="{{ site.baseurl }}/assets/2016/11/ans_group.png" alt="ans_group" width="1832" height="498" /></p>
<h4>Create directors for OpenShift inventory</h4>
<pre># mkdir /root/ose3</pre>
<h4>Setup ansible-hosts file</h4>
<pre># vi /root/ose3/ansible-hosts
##########################
### OSEv3 Server Types ###
##########################
[OSEv3:children]
masters
nodes
etcd

##############################
### host group for masters ###
##############################
[masters]
ose3-master2.lab.com

###################################
### host group for etcd servers ###
###################################
[etcd]
ose3-master2.lab.com

##################################################
### host group for nodes, includes region info ###
##################################################
[nodes]
ose3-master2.lab.com openshift_schedulable=True</pre>
<h4>Create directory for group_vars</h4>
<p>Note: this is required because Tower import tool does not yet support [groupname:vars] directly in inventory file.</p>
<pre># mkdir /root/ose3/group_vars</pre>
<h4>Setup OpenShift parameters using group_vars file</h4>
<pre># vi /root/ose3/group_Vars/OSEv3
ansible_ssh_user: root
os_sdn_network_plugin_name: 'redhat/openshift-ovs-subnet'
deployment_type: openshift-enterprise
openshift_master_default_subdomain: apps.lab.com
openshift_master_identity_providers: [{'name': 'htpasswd_auth', 'login': 'true', 'challenge': 'true', 'kind': 'HTPasswdPasswordIdentityProvider', 'filename': '/etc/origin/master/htpasswd'}]
openshift_node_kubelet_args: {'maximum-dead-containers': ['100'], 'maximum-dead-containers-per-container': ['2'], 'minimum-container-ttl-duration': ['10s'], 'max-pods': ['110'], 'image-gc-high-threshold': ['90'], 'image-gc-low-threshold': ['80']}
logrotate_scripts: [{"name": "syslog", "path": "/var/log/cron\n/var/log/maillog\n/var/log/messages\n/var/log/secure\n/var/log/spooler\n", "options": ["daily", "rotate 7", "compress", "sharedscripts", "missingok"], "scripts": {"postrotate": "/bin/kill -HUP `cat /var/run/syslogd.pid 2&gt; /dev/null` 2&gt; /dev/null || true"}}]
openshift_docker_options: "--log-opt max-size=1M --log-opt max-file=3"
openshift_node_iptables_sync_period: 5s
openshift_master_pod_eviction_timeout: 3m
osm_controller_args: {'resource-quota-sync-period': ['10s']}
osm_api_server_args: {'max-requests-inflight': ['400']}
openshift_use_dnsmasq: false</pre>
<h4>Import OpenShift inventory</h4>
<pre># tower-manage inventory_import --source=/root/ose --inventory-name="OSE_3.3" --overwrite --overwrite-vars</pre>
<p>After import is complete you should see inventory. Under OSE_3.3 inventory, a group called OSEv3 should be visible. If you edit the OSEv3 group you should see the variables used to drive OpenShift deployment. Here you can easily change things in order to update or change OpenShift deployment.</p>
<p><img class="alignnone size-full wp-image-6031" src="{{ site.baseurl }}/assets/2016/11/ansible_inv2.png" alt="ansible_inv2" width="1836" height="579" /></p>
<p>Under the OSEv3 group you should see all the OpenShift server groups and under those the actual systems.</p>
<p><img class="alignnone size-full wp-image-6075" src="{{ site.baseurl }}/assets/2016/11/ansible_inv1.png" alt="ansible_inv1" width="942" height="509" /></p>
<h3>Configure Ansible Tower</h3>
<h4>Create Project in Tower</h4>
<p>Under projects add a new project. Add Github URL to <a href="https://github.com/openshift/openshift-ansible">ansible-openshift</a> project. Ensure you add the correct branch. OpenShift v3.3 correlates to branch release-1.3. You should add a separate project for every release.</p>
<p>Note: make sure you check what version of ansible-openshift correlates to version of OpenShift you want to deploy!</p>
<p><img class="alignnone size-full wp-image-5999" src="{{ site.baseurl }}/assets/2016/11/ans1.png" alt="ans1" width="1846" height="728" /></p>
<h4>Add credentials for OpenShift nodes</h4>
<p>Under settings-&gt;credentials add new credentials called OSE.</p>
<p>Note: In this example I added the root user and password but you can use non-root user or ssh keys instead of password. In fact there is already a group_var parameter to use sudo.</p>
<p><img class="alignnone size-full wp-image-6004" src="{{ site.baseurl }}/assets/2016/11/ans_pwd.png" alt="ans_pwd" width="1839" height="568" /></p>
<h4>Add job template</h4>
<p>Under job templates add a new template. Select the inventory, project and machine credentials. Select playbooks/byo/config.yaml for the playbook.</p>
<p><img class="alignnone size-full wp-image-6021" src="{{ site.baseurl }}/assets/2016/11/ans_template.png" alt="ans_template" width="1771" height="592" /></p>
<p>Deploy OpenShift</p>
<p>To deploy or update your OpenShift deployment you simply need to run the playbook from Tower by clicking the rocket next to your job template.</p>
<p><img class="alignnone size-full wp-image-6037" src="{{ site.baseurl }}/assets/2016/11/ans_deploy.png" alt="ans_deploy" width="1871" height="400" /></p>
<p>You can follow the deployment status by looking at the job in Tower.</p>
<p><img class="alignnone size-full wp-image-6041" src="{{ site.baseurl }}/assets/2016/11/ans_job.png" alt="ans_job" width="1866" height="770" /></p>
<h3>Summary</h3>
<p>In this article we looked at how to deploy OpenShift using Ansible Tower. The default method for deploying and managing OpenShift is Ansible Core. Tower however gives you a lot of advantages providing central management, credentials store, RBAC, maintain multiple versions or multiple OpenShift environments and of course the more you do with ansible the more sense it makes to start using Tower. I hope you found this article informative and interesting. Looking forward to hearing your thoughts and feedback.</p>
<p>Happy OpenShifting!</p>
<p>(c) 2016 Keith Tenzer</p>
