---
layout: post
title: Explaining OpenStack Cinder Types and Scheduler
date: 2017-05-31 15:05:38.000000000 -07:00
type: post
parent_id: '0'
published: true
password: ''
status: publish
categories: []
tags:
- Cinder
- KVM
- Linux
- OpenStack
- Storage
meta:
  _rest_api_published: '1'
  _rest_api_client_id: "-1"
  _publicize_job_id: '5633132512'
  publicize_linkedin_url: https://www.linkedin.com/updates?discuss=&scope=329229505&stype=M&topic=6275698586386866176&type=U&a=cYFo
  _publicize_done_9423386: '1'
  _wpas_done_9468659: '1'
author:
  login: ktenzer1
  email: keith.tenzer@gmail.com
  display_name: ktenzer
  first_name: ''
  last_name: ''
permalink: "/2017/05/31/explaining-openstack-cinder-types-and-scheduler/"
---
<h2><img class="alignnone size-full wp-image-10161" src="{{ site.baseurl }}/assets/2017/05/openstack-logo-2016.png" alt="openstack-logo-2016" width="770" height="211" /></h2>
<h2>Overview</h2>
<p>OpenStack Cinder is responsible for handling block storage in the context of OpenStack. Cinder provides a standard API and interface that allows storage companies to create their own drivers in order to integrate storage capabilities into OpenStack in a consistent way. Each storage pool exposed to OpenStack Cinder is a backend and you can have many storage backends. You can also have many of the same kind of storage backends. In this article we will look at two advanced features Cinder provides: types and the scheduler.</p>
<p>Cinder types essentially allow us to label Cinder storage backends. This allows for building out storage services that have expected characteristics and capabilities. The Cinder driver exposes those storage capabilities to Cinder.</p>
<p>The Cinder scheduler is responsible for deciding where to create Cinder volumes when we have more than one of the same kind of storage backend. This is done by looking at the filter rules in order to identify the most appropriate storage backend. More about filter rules can be found <a href="https://docs.openstack.org/developer/cinder/scheduler-filters.html">here</a>.</p>
<p><!--more--></p>
<h2>Prerequisites</h2>
<p>In order to follow along you will need an OpenStack environment. The easiest thing to do is setup an all-in-one environment with RDO. Those steps are documented <a href="https://keithtenzer.com/2017/03/27/openstack-10-newton-lab-installation-and-configuration-guide/">here</a>.</p>
<p>If you want to use Ceph and don't have an environment or things setup properly then you can follow below guides:</p>
<ul>
<li><a href="https://keithtenzer.com/2017/02/03/red-hat-ceph-storage-2-0-lab-object-storage-configuration-guide/">Ceph setup</a></li>
<li><a href="https://keithtenzer.com/2016/09/12/openstack-integrating-ceph-as-storage-backend/">Ceph OpenStack configuration</a></li>
</ul>
<h2>Configure Storage Backends</h2>
<p>[OpenStack Controller]</p>
<p><strong>Add two disks to OpenStack controller. </strong></p>
<p>For all-in-one setup this is straight-forward. If you have multiple controllers then it needs to be a controller running openstack-cinder-volume service.</p>
<p><strong>Create LVM Storage Backends.</strong></p>
<p>Authenticate to OpenStack using keystone source file.</p>
<pre># source /root/keystonerc_admin</pre>
<p>Determine appropriate block device names for newly added disks. The below commands can be useful. In this case the two disks are vdb and vdc.</p>
<pre># blkid
# lsblk</pre>
<p><strong>Create physical volumes and volume groups.</strong></p>
<pre># pvcreate /dev/vdb
# vgcreate lvm-1 /dev/vdb</pre>
<pre># pvcreate /dev/vdc
# vgcreate lvm-2 /dev/vdc</pre>
<p><strong>Update Cinder configuration and add LVM backends.</strong></p>
<pre># vi /etc/cinder/cinder.conf
default_volume_type = rbd
enabled_backends = lvm1,lvm2,rbd

[lvm1]
iscsi_helper=lioadm
iscsi_ip_address=192.168.122.80
volume_driver=cinder.volume.drivers.lvm.LVMVolumeDriver
volumes_dir=/var/lib/cinder/volumes
volume_backend_name=lvm
volume_group=lvm-1
<strong>filter_function = "volume.size &lt; 5"</strong>

[lvm2]
iscsi_helper=lioadm
iscsi_ip_address=172.16.7.50
volume_driver=cinder.volume.drivers.lvm.LVMVolumeDriver
volume_dir=/var/lib/cinder/volumes
volume_backend_name=lvm
volume_group=lvm-2
<strong>filter_function = "volume.size &gt;= 5"</strong></pre>
<p>Notice we also added filter rules. Since we have multiple lvm backends defined, filter rules will help scheduler decide what backend to use for provisioning Cinder volumes. In this case we have added a filter based on size. Cinder volumes smaller than 5GB will end up on backend lvm1 while Cinder volumes larger than 5GB will end up on backend lvm2.</p>
<p><strong>Restart Cinder Services.</strong></p>
<pre># systemctl restart openstack-cinder-api
# systemctl restart openstack-cinder-volume</pre>
<h2>Configure Cinder Types</h2>
<p>As mentioned Cinder types are used to create storage services and provide certain capabilities that are exposed by the driver. In this case we are simply labeling the backends however capabilities such as replication, backup and other things are also exposed via cinder types. This depends on the storage backend and the underlying storage capabilities.</p>
<p><strong>Create Cinder Types for backend lvm1.</strong></p>
<pre># openstack volume type create --public LVM1
 +---------------------------------+--------------------------------------+
 | Field | Value |
 +---------------------------------+--------------------------------------+
 | description | None |
 | id | 7ee9c132-3556-4294-80d5-a87dffaa8db4 |
 | is_public | True |
 | name | LVM |
 | os-volume-type-access:is_public | True |
 +---------------------------------+--------------------------------------+</pre>
<pre># openstack volume type set --property volume_backend_name=lvm1 LVM1</pre>
<p><strong>Create Cinder Types for backend lvm2.</strong></p>
<pre># openstack volume type create --public LVM2
+---------------------------------+--------------------------------------+
| Field | Value |
+---------------------------------+--------------------------------------+
| description | None |
| id | 7ee9c132-3556-4294-80d5-a87dffaa8db4 |
| is_public | True |
| name | LVM |
| os-volume-type-access:is_public | True |
+---------------------------------+--------------------------------------+</pre>
<pre># openstack volume type set --property volume_backend_name=lvm2 LVM2</pre>
<p><strong>List Cinder backends.</strong></p>
<pre># cinder get-pools
 +----------+------------------------+
 | Property | Value |
 +----------+------------------------+
 | name | osp10.lab.com@lvm2#lvm |
 +----------+------------------------+
 +----------+-----------------------+
 | Property | Value |
 +----------+-----------------------+
 | name | osp10.lab.com@lvm1#lvm |
 +----------+-----------------------+</pre>
<h2>Create Cinder Volumes</h2>
<p>Now that multiple lvm backends are configured, types exist and scheduler has filter rules, we can provision Cinder volumes.</p>
<p><strong>Create 3GB Cinder Volume.</strong></p>
<pre># openstack volume create --size 3 3gb-vol --type lvm
 +---------------------+--------------------------------------+
 | Field | Value |
 +---------------------+--------------------------------------+
 | attachments | [] |
 | availability_zone | nova |
 | bootable | false |
 | consistencygroup_id | None |
 | created_at | 2017-03-29T15:17:58.457813 |
 | description | None |
 | encrypted | False |
 | id | 4d764067-da2a-476c-8f64-a52203e2dfd7 |
 | migration_status | None |
 | multiattach | False |
 | name | 3gb-vol |
 | properties | |
 | replication_status | disabled |
 | size | 3 |
 | snapshot_id | None |
 | source_volid | None |
 | status | creating |
 | type | LVM |
 | updated_at | None |
 | user_id | 9d592f8a49654e8592de4e69fd15e603 |
 +---------------------+--------------------------------------+</pre>
<p><strong>Create 6GB Cinder Volume.</strong></p>
<pre># openstack volume create --size 6 6gb-vol --type lvm
 +---------------------+--------------------------------------+
 | Field | Value |
 +---------------------+--------------------------------------+
 | attachments | [] |
 | availability_zone | nova |
 | bootable | false |
 | consistencygroup_id | None |
 | created_at | 2017-03-29T15:18:21.086318 |
 | description | None |
 | encrypted | False |
 | id | 5a39b0c3-fb07-481e-a150-36c0eae1adc3 |
 | migration_status | None |
 | multiattach | False |
 | name | 6gb-vol |
 | properties | |
 | replication_status | disabled |
 | size | 6 |
 | snapshot_id | None |
 | source_volid | None |
 | status | creating |
 | type | LVM |
 | updated_at | None |
 | user_id | 9d592f8a49654e8592de4e69fd15e603 |
 +---------------------+--------------------------------------+</pre>
<p><strong>List Cinder Volumes.</strong></p>
<pre># openstack volume list
 +--------------------------------------+--------------+-----------+------+-------------+
 | ID | Display Name | Status | Size | Attached to |
 +--------------------------------------+--------------+-----------+------+-------------+
 | <strong>5a39b0c3-fb07-481e-a150-36c0eae1adc3</strong> | 6gb-vol | available | 6 | |
 | <strong>4d764067-da2a-476c-8f64-a52203e2dfd7</strong> | 3gb-vol | available | 3 | |
 +--------------------------------------+--------------+-----------+------+-------------+</pre>
<p><strong>Show Details on LVM volumes</strong></p>
<pre># lvs
 LV VG Attr LSize Pool Origin Data% Meta% Move Log Cpy%Sync Convert
 volume-<strong>4d764067-da2a-476c-8f64-a52203e2dfd7</strong> lvm-1 -wi-a----- 3.00g
 volume-<strong>5a39b0c3-fb07-481e-a150-36c0eae1adc3</strong> lvm-2 -wi-a----- 6.00g
 root rhel -wi-ao---- 91.57g
 swap rhel -wi-ao---- 7.88g</pre>
<p>Using the Cinder volume id we can see that the scheduler properly placed the Cinder volumes according to the filter. In this case the 3GB volumes ended up on lvm-1 backend and the 6GB volume on lvm-2 backend.</p>
<h2>Summary</h2>
<p>In this article we explained how to build intelligent storage services using OpenStack Cinder. Using Cinder types we can define service levels and capabilities. Using the scheduler we can apply filters that apply intelligent decision making, in order to find the most appropriate storage backend. Finally we provided a basic example using two LVM backends and a filter based on volume size.</p>
<p>Happy OpenStacking!</p>
<p>(c) 2017 Keith Tenzer</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
