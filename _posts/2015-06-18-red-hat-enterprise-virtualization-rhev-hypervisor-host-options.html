---
layout: single 
title: Red Hat Enterprise Virtualization (RHEV) - Hypervisor Host Options
categories:
- RHEV
tags:
- KVM
- Linux
- RHEL
- Virtualization
---
<h3>Overview</h3>
<p>Red Hat Enterprise Virtualization (RHEV) has two options for running a hypervisor host: 1) use the RHEV-H host 2) use Red Hat Enterprise Linux 6 or 7. Option 1 is similar to VMware ESXi, RHEV-H is an optimized OS for running Virtual Machines.  Option 2 allows you to configure a standard RHEL 6 or 7 host and add it to RHEV as a hypervisor.<!--more--></p>
<p>Which option is best?</p>
<p>The answer here depends on your requirements but just having feedom of choice is an evolution and step in the right direction. If you would like to install extra packages or your hardware requires certain kernel modules then RHEL 7 is the best choice as you need that flexibility. If you dont need anything but the hypervisor itself then RHEV-H is the way to go.</p>
<p>Some additional use cases for using RHEL 6 or 7?</p>
<ul>
<li>Application clustering using pacemaker</li>
<li>Utilizing local hypervisor storage within cluster</li>
<li>Special monitoring requirements</li>
</ul>
<p>Red Hat Enterprise Virtualization Management (RHEV-M) is required before proceeding. For more general information about RHEV and configuring RHEV-M please check out this past <a href="http://keithtenzer.com/2015/01/05/red-hat-enterprise-virtualization-rhev-home-lab-configuration/">article</a>.</p>
<h3>Adding RHEV Hypervisor Host</h3>
<p>As mentioned RHEV-H is an optimized OS for running virtual machines. In order to configure RHEV-H please follow the below steps:</p>
<ul>
<li>Download RHEV-H ISO</li>
<li>Boot ISO image and follow standard installation steps</li>
<li><span style="font-family:Consolas, Monaco, monospace;line-height:1.5;">ssh -l admin &lt;RHEV-H FQDN or IP&gt;</span></li>
</ul>
<p>By default root account is disabled for login. The account used to configure RHEV-H is admin and upon logging in as admin you are provided with the following configuration menu.</p>
<p><a href="https://keithtenzer.files.wordpress.com/2014/12/rhev_ovirt_engine.jpg"><img class="alignnone wp-image-291" src="{{ site.baseurl }}/assets/2015/06/rhev_ovirt_engine.jpg?w=300" alt="RHEV_ovirt_engine" width="975" height="312" /></a></p>
<p>Besides configuring network settings it is important to configure access to Red Hat Enterprise Virtualization Management (RHEV-M). Under the oVirt Engine menu the IP and port of the RHEV-M server must be configured. This will add the RHEV-H host to the Default datacenter in RHEV-M and from there all additional configuration can be done through RHEV-M.</p>
<h3>Adding RHEL 7 Host</h3>
<p>Instead of going with RHEV-H as mentioned we can build the hypervisor ourselves using RHEL 6 or RHEL 7 as baseline. One word of caution it is only possible to cluster hypervisors that are either RHEL 6 or RHEL 7, not a mix.</p>
<h4>Install RHEL 7 minimal OS</h4>
<p>Download and install RHEL 7 ISO. Choose a minimal install and configure static networking.</p>
<h4>Required Repositories</h4>
<pre style="padding-left:30px;">#systemctl stop NetworkManager</pre>
<pre style="padding-left:30px;">#systemctl disable NetworkManager</pre>
<pre style="padding-left:30px;">#subscription-manager repos --enable=rhel-7-server-rpms</pre>
<pre style="padding-left:30px;">#subscription-manager repos --enable=rhel-7-server-optional-rpms</pre>
<pre style="padding-left:30px;">#subscription-manager repos --enable=rhel-7-server-rhev-mgmt-agent-rpms</pre>
<pre style="padding-left:30px;">#yum update -y</pre>
<h4>Configure Firewall</h4>
<p>The RHEV Hypervisor requires iptables not firewalld. On RHEL 7 we need to disable firewalld and enable iptables. In addition we also need to disable Network Manager.</p>
<pre style="padding-left:30px;">#systemctl stop firewalld</pre>
<pre style="padding-left:30px;">#systemctl disable firewalld</pre>
<pre style="padding-left:30px;">#systemctl stop NetworkManager</pre>
<pre style="padding-left:30px;">#systemctl disable NetworkManager</pre>
<pre style="padding-left:30px;">#yum -y install iptables-services</pre>
<pre style="padding-left:30px;">#systemctl enable iptables.service</pre>
<pre style="padding-left:30px;">#systemctl start iptables.service</pre>
<pre style="padding-left:30px;">#iptables --flush</pre>
<pre class="screen" style="padding-left:30px;">#systemctl restart iptables.service</pre>
<h4>Required iptables rules</h4>
<p>Below are the required iptables rules for a RHEV hypervisor host. Note this is not required, RHEV-M will automatically configure these rules upon install this is just in case you change rules later.</p>
<pre style="padding-left:30px;"><code># iptables -I INPUT -p tcp -m tcp --dport 54321 -j ACCEPT
# iptables -I INPUT -p tcp -m tcp --dport 22 -j ACCEPT
# iptables -I INPUT -p udp -m udp --dport 161 -j ACCEPT
# iptables -I INPUT -p tcp -m tcp --dport 16514 -j ACCEPT
# iptables -I INPUT -p tcp -m multiport --dports 5634:6166 -j ACCEPT
# iptables -I INPUT -p tcp -m multiport --dports 49152:49216 -j ACCEPT
# iptables -I INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
# iptables -I FORWARD -m physdev ! --physdev-is-bridged -j REJECT --reject-with icmp-host-prohibited
# service iptables save</code></pre>
<h4>Add RHEL Host to RHEV as Hypervisor</h4>
<p>Once the RHEL host has been prepared it can be added to RHEV-M environment. RHEV-M will install all the required packages for RHEV and add host to desired cluster. From RHEV-M UI logon as admin@internal and under host select add a new host.</p>
<p><a href="https://keithtenzer.files.wordpress.com/2015/06/rhev_add_host.jpg"><img class="alignnone wp-image-985" src="{{ site.baseurl }}/assets/2015/06/rhev_add_host.jpg?w=300" alt="RHEV_ADD_HOST" width="996" height="959" /></a></p>
<p>RHEV-M will use SSH in order to communicate with host and install packages as well as start services. RHEV-M will even configure the iptables rules as mentioned. It is important to add any additional iptables rules after the configuration is complete as RHEV-M will wipe previous iptables rules. Below we can see a new hypervisor host is being installed in the environment.</p>
<p class="screen"><a href="https://keithtenzer.files.wordpress.com/2015/06/rhev_install_host.jpg"><img class="alignnone wp-image-987" src="{{ site.baseurl }}/assets/2015/06/rhev_install_host.jpg?w=300" alt="RHEV_INSTALL_HOST" width="996" height="465" /></a></p>
<p>Once the installation is complete you can proceed to install any other packages and tweak things to your hearts content.</p>
<h3>Configure local storage in cluster</h3>
<p>Optionally you may want to use local storage of hypervisor host for images or other purposes. The easiest way to do this is by exporting mountpoints as NFS shares. In RHEV all storage in a cluster must be available to all hosts, therefore local storage is not an option unless you have a cluster consisting of just one RHEV host.</p>
<h4>Install NFS Services on RHEV Host</h4>
<pre class="screen" style="padding-left:30px;">#yum install nfs-utils rpcbind
#systemctl enable rpcbind
#systemctl enable nfs-server
#systemctl start rpcbind
#systemctl start nfs-server</pre>
<h4>Exporting NFS mountpoints</h4>
<p>In order to export NFS share to RHEV we need to create the mountpoint and ensure permissions are set correctly. In addition we need to ensure the mountpoint is also exported with read-write.</p>
<pre class="screen" style="padding-left:30px;">#mkdir /usr/share/rhev
#chown -R 36:36 /usr/share/rhev/
#chmod -R 0755 /usr/share/rhev/</pre>
<pre class="screen" style="padding-left:30px;">#vi /etc/exports
#/usr/share/rhev 192.168.2.0/24(rw)
#exportfs -a</pre>
<h4>Configure NFS iptables rules</h4>
<p>Once the NFS share is exported iptables rules need to be implemented in order to allow access to the NFS services.</p>
<p><strong>Portmapper (rpcbind)</strong></p>
<pre style="padding-left:30px;"><code># iptables -I INPUT -p tcp -m tcp --dport 111 -j ACCEPT
</code></pre>
<pre style="padding-left:30px;"><code># iptables -I INPUT -p udp -m udp --dport 111 -j ACCEPT</code></pre>
<p><code><strong>Mountd (defined in /etc/sysconfig/nfs)</strong><br />
</code></p>
<pre style="padding-left:30px;"><code># iptables -I INPUT -p tcp -m tcp --dport 892 -j ACCEPT
</code></pre>
<pre style="padding-left:30px;"><code># iptables -I INPUT -p udp -m udp --dport 892 -j ACCEPT</code></pre>
<p><strong><code>Rquotad (defined in /etc/sysconfig/nfs)</code></strong></p>
<pre style="padding-left:30px;"><code># iptables -I INPUT -p tcp -m tcp --dport 875 -j ACCEPT
</code></pre>
<pre style="padding-left:30px;"><code># iptables -I INPUT -p udp -m udp --dport 875 -j ACCEPT</code></pre>
<p><code><strong>NFS Statd (defined in /etc/sysconfig/nfs)</strong><br />
</code></p>
<pre style="padding-left:30px;"># iptables -I INPUT -p tcp -m tcp --dport 662 -j ACCEPT
</pre>
<pre style="padding-left:30px;"><code># iptables -I INPUT -p udp -m udp --dport 662 -j ACCEPT</code></pre>
<p><code><strong>NFSD</strong><br />
</code></p>
<pre style="padding-left:30px;"><code># iptables -I INPUT -p tcp -m tcp --dport 2049 -j ACCEPT</code></pre>
<p><code><strong>NFS Lock Manager (defined in /etc/sysconfig/nfs)</strong><br />
</code></p>
<pre style="padding-left:30px;"><code># iptables -I INPUT -p tcp -m tcp --dport 32803 -j ACCEPT</code></pre>
<p><code><strong>NFS Lockd (defined in /etc/sysconfig)</strong><br />
</code></p>
<pre style="padding-left:30px;"><code># iptables -I INPUT -p udp -m udp --dport 32769 -j ACCEPT
</code></pre>
<pre class="screen" style="padding-left:30px;">#service iptables save</pre>
<h3 class="screen">Summary</h3>
<p>Red Hat provides two Hypervisor options for RHEV. As we have seen you can use the optimized OS RHEV-H that is similar to VMware ESXi or you can build your own using RHEL 6 or 7 as base. The freedom of choice enables you to make the best decision for your IT infrastructure.</p>
<p>Happy RHEVing!</p>
<p>(c) 2015 Keith Tenzer</p>
