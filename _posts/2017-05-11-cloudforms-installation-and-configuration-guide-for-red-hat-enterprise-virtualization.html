---
layout: post
title: CloudForms Installation and Configuration Guide for Red Hat Virtualization
date: 2017-05-11 14:42:13.000000000 -07:00
type: post
parent_id: '0'
published: true
password: ''
status: publish
categories:
- CloudForms
tags:
- Cloud
- cloud management
- KVM
- ManageIQ
- RHEV
meta:
  _oembed_7c66888820ff8d14b238bbc1119aa4c4: "{{unknown}}"
  _oembed_db30709cacbfc99705453d55336b297e: "{{unknown}}"
  _oembed_3a14dde805a14e2e5f8302c3ca53592b: "{{unknown}}"
  _edit_last: '63054820'
  geo_public: '0'
  _wpas_skip_9468659: '1'
  _rest_api_published: '1'
  _rest_api_client_id: "-1"
  _publicize_job_id: '4937889163'
  publicize_linkedin_url: https://www.linkedin.com/updates?discuss=&scope=329229505&stype=M&topic=6268444933963812864&type=U&a=d6aq
  _publicize_done_9423386: '1'
  _wpas_done_9468659: '1'
author:
  login: ktenzer1
  email: keith.tenzer@gmail.com
  display_name: ktenzer
  first_name: ''
  last_name: ''
permalink: "/2017/05/11/cloudforms-installation-and-configuration-guide-for-red-hat-enterprise-virtualization/"
---
<h2><img class="alignnone wp-image-10020" src="{{ site.baseurl }}/assets/2017/05/manageiq-logo-glyph.png" alt="manageiq-logo-glyph" width="239" height="239" /></h2>
<h2>Overview</h2>
<p>In this article we will deploy CloudForms 4.2 on Red Hat Enterprise Virtualization (RHV). We will also show how to configure CloudForms in order to properly manage a RHV cluster and it's hosts as well as virtual machines.</p>
<p>Before you begin a RHV cluster is needed. If you haven't set one up, <a href="https://keithtenzer.com/2017/05/02/rhev-4-1-lab-installation-and-configuration-guide/">here </a>is a guide on how to build a basic two node RHV cluster.</p>
<p><!--more--></p>
<h2>Install CloudForms</h2>
<p>CloudForms is provided by Red Hat as a virtual applicance. Red Hat provides appliances for many infrastructure platforms such as RHV, VMware, Hyper-V, OpenStack, AWS, GCE and Azure. In this case we will download the RHV virtual appliance.</p>
<p><strong>Download Image</strong></p>
<p>Image should be downloaded to the CFME appliance using your RHN login.</p>
<p><a href="https://access.redhat.com/downloads/content/167/ver=/cf-me---4.2/4.2/x86_64/product-software">https://access.redhat.com/downloads/content/167/ver=/cf-me---4.2/4.2/x86_64/product-software</a></p>
<p><strong>Add Appliance into RHV Export Domain</strong></p>
<p>In order to import an appliance it needs to be copied to export domain or imported to export domain using CLI.</p>
<pre># cp cfme-rhevm-5.7.2.1-1.x86_64.rhevm.ova /usr/share/export/30621071-3dba-401d-9605-02a914b4069a</pre>
<p>Once copied to export domain we need to extract the appliance and set permissions.</p>
<pre># cd /usr/share/export/30621071-3dba-401d-9605-02a914b4069a/</pre>
<pre># tar xvf cfme-rhevm-5.3-15.x86_64.rhevm.ova</pre>
<pre># chown -R 36:36 images/
# chown -R 36:36 master/</pre>
<p><strong>Import CFME Appliance as Template</strong></p>
<p>Once the appliance is in the export domain we can import it as an appliance using the RHV-M management console. Under export domain and template, choose the import option.</p>
<p><img class="alignnone size-full wp-image-9595" src="{{ site.baseurl }}/assets/2017/05/rhevm_cfme_imported.jpg" alt="rhevm_cfme_imported" width="1367" height="786" /></p>
<p><img class="alignnone size-full wp-image-9598" src="{{ site.baseurl }}/assets/2017/05/rhevm_import_cfme.jpg" alt="rhevm_import_cfme" width="256" height="173" /></p>
<p>We can provide our CFME template with a new name.</p>
<p><img class="alignnone size-full wp-image-9599" src="{{ site.baseurl }}/assets/2017/05/cfme_import_2.jpg" alt="cfme_import_2" width="989" height="558" /></p>
<p>Once import completes the status will change to "OK".</p>
<p><img class="alignnone size-full wp-image-9601" src="{{ site.baseurl }}/assets/2017/05/rhevm_cfme_import_complete.jpg" alt="rhevm_cfme_import_complete" width="1094" height="134" /></p>
<p><strong>Create CloudForms Virtual Machine</strong></p>
<p>Under "Virtual Machines", select "new" in the RHV-M management console. For template choose the newly imported CFME template.</p>
<p><img class="alignnone size-full wp-image-9602" src="{{ site.baseurl }}/assets/2017/05/cfme_new_vm.jpg" alt="cfme_new_vm" width="874" height="627" /></p>
<p><strong>Add Additional Disk for CloudForms Database</strong></p>
<p>Under CFME "Virtual Machine" Disks select "new" to add a new disk. I would recommend 30GB but this is based on how much data is to be collected and for how long.</p>
<p><img class="alignnone size-full wp-image-9628" src="{{ site.baseurl }}/assets/2017/05/cfme_db_disk.jpg" alt="cfme_db_disk" width="807" height="600" /></p>
<h2>Configure Appliance</h2>
<p>Start CFME VM from RHV-M management console. Login as "root/smartvm" and run "appliance_console" to configure CloudForms.</p>
<p><img class="alignnone size-full wp-image-9629" src="{{ site.baseurl }}/assets/2017/05/cfme_setup1.jpg" alt="cfme_setup1" width="1018" height="227" /></p>
<p><strong>Configure static network settings</strong></p>
<p><img class="alignnone size-full wp-image-9633" src="{{ site.baseurl }}/assets/2017/05/cfme_setup2.jpg" alt="cfme_setup2" width="1023" height="216" /></p>
<p><strong>Configure local database</strong></p>
<p><img class="alignnone size-full wp-image-9635" src="{{ site.baseurl }}/assets/2017/05/cfme_db_1.jpg" alt="cfme_db_1" width="846" height="496" /></p>
<p><strong>Make sure you create an internal database</strong></p>
<p><img class="alignnone size-full wp-image-9639" src="{{ site.baseurl }}/assets/2017/05/cfme_db_22.jpg" alt="cfme_db_2" width="1013" height="439" /></p>
<p><strong>Choose a disk, this should be the 30GB disk we added</strong></p>
<p><img class="alignnone size-full wp-image-9641" src="{{ site.baseurl }}/assets/2017/05/cfme_db_3.jpg" alt="cfme_db_3" width="1016" height="162" /></p>
<p><strong>Choose "N" to run standalone database server</strong></p>
<p><img class="alignnone size-full wp-image-9642" src="{{ site.baseurl }}/assets/2017/05/cfme_db_4.jpg" alt="cfme_db_4" width="1022" height="199" /></p>
<p><strong>Create database region and choose password</strong></p>
<p><img class="alignnone size-full wp-image-9644" src="{{ site.baseurl }}/assets/2017/05/cfme_db_5.jpg" alt="cfme_db_5" width="1018" height="133" /></p>
<p><strong>Restart the CFME appliance</strong></p>
<p><img class="alignnone size-full wp-image-9645" src="{{ site.baseurl }}/assets/2017/05/cfme_db_6.jpg" alt="cfme_db_6" width="1015" height="491" /></p>
<p><strong>Below are the basic settings that should be configured</strong></p>
<p><img class="alignnone size-full wp-image-9647" src="{{ site.baseurl }}/assets/2017/05/cfme_db_7.jpg" alt="cfme_db_7" width="1019" height="406" /></p>
<h2>Configure RHV for CloudForms</h2>
<p>In order for CloudForms to report capacity &amp; utilization we need to configure access from RHV-M.</p>
<p><strong>Login to RHV-M host using ssh as root</strong></p>
<p><strong>Connect to RHV-M database</strong></p>
<pre># su - postgres</pre>
<p>As postgres user add a new role for CloudForms. As of this article CloudForms needs superuser but there is an RFE to enable read-only access in future.</p>
<pre>$ psql -U postgres CREATE ROLE cfme LOGIN UNENCRYPTED PASSWORD 'redhat01' \
SUPERUSER VALID UNTIL 'infinity'; \q</pre>
<p>&nbsp;</p>
<p><strong>Open firewall ports to allow communication to database</strong></p>
<pre># firewall-cmd --add-port=5432/tcp --permanent
# firewall-cmd --reload</pre>
<p><strong>Ensure PostgreSQL is exposing port and listening to all interfaces</strong></p>
<pre># vi /var/lib/pgsql/data/pg_hba.conf
host all all 0.0.0.0/0 md5</pre>
<pre># vi /var/lib/pgsql/data/postgresql.conf
listen_addresses = '*'</pre>
<p><strong>Restart PostgreSQL database</strong></p>
<pre># service postgresql reload</pre>
<h2>Configure RHV Provider in CloudForms</h2>
<p><strong>Connect to CloudForms management console</strong></p>
<p>Using browser you can simply hit the IP of CloudForms appliance using https. Login with "admin/smartvm".</p>
<p><img class="alignnone size-full wp-image-9648" src="{{ site.baseurl }}/assets/2017/05/cfme_login.jpg" alt="cfme_login" width="1233" height="867" /></p>
<p><strong>Add RHV Provider</strong></p>
<p>Under providers, choose "Infrastructure Providers" and "new". Add the default credentials using IP or name of RHV-M host. The user should be admin@internal for RHV-M.</p>
<p>Once that is complete, go to the "C&amp; U Database" tab. Here you will enter the IP or name for the RHV-M host and the superuser credentials you created above. In this example "cfme/redhat01".</p>
<p><img class="alignnone size-full wp-image-9620" src="{{ site.baseurl }}/assets/2017/05/cfme_add_rhev_provider.jpg" alt="cfme_add_rhev_provider" width="999" height="766" /><strong>Configure Hypervisors</strong></p>
<p>CloudForms requires access to hypervisors for certain capabilities like "smart state analysis". Ability to peer inside VM images in order to for example, check security vulnerabilities. In this environment there are two hypervisor hosts (rhevh01.lab and rhevh02.lab).</p>
<p><strong>Configure RHEVH01</strong></p>
<p>Under RHV infrastructure provider select host rhevh01.lab and configure.</p>
<p><img class="alignnone size-full wp-image-9623" src="{{ site.baseurl }}/assets/2017/05/cfme_rhev_hypervisor.jpg" alt="cfme_rhev_hypervisor" width="1688" height="739" /></p>
<p><strong>Configure RHEVH02</strong></p>
<p>Under RHV infrastructure provider select host rhevh02.lab and configure.</p>
<p><img class="alignnone size-full wp-image-9625" src="{{ site.baseurl }}/assets/2017/05/cfme_rhev_hypervisor2.jpg" alt="cfme_rhev_hypervisor2" width="1688" height="746" /></p>
<p><strong>Enable Capacity and Utilization</strong></p>
<p>On upper far right in CloudForms management console under user, select "Configuration". Enable the Capacity and Utilization roles underthe "Server: EVM".</p>
<p>C &amp; U</p>
<p><img class="alignnone size-full wp-image-9652" src="{{ site.baseurl }}/assets/2017/05/cfme_cu.jpg" alt="cfme_c+u" width="1249" height="725" /></p>
<p><strong>Set SmartProxy Affinity</strong></p>
<p>Under "Zone: Default Zone" associate all hosts and datastores.</p>
<p><img class="alignnone size-full wp-image-9653" src="{{ site.baseurl }}/assets/2017/05/cmfe_cu2.jpg" alt="cmfe_c+u2" width="1677" height="379" /></p>
<p><strong>Enable Capacity and Utilization Collection of RHV Environment</strong></p>
<p>Under "CFME:Region" enable collection for all clusters and datastores.</p>
<p><img class="alignnone size-full wp-image-9658" src="{{ site.baseurl }}/assets/2017/05/cfme_cu4.jpg" alt="cfme_c+u4" width="1679" height="372" /></p>
<p>At this point CloudForms is collecting capacity and utilization statistics and after a few hours you should start seeing data under VM. You can also use planning to forecast and model various growth scenarios.</p>
<h2>Summary</h2>
<p>In this article we installed and configured the CloudForms appliance on an existing RHV cluster. We prepared RHV-M for CloudForms data collection. Configured a new infrastructure provider for RHV in CloudForms. Finally we enabled capacity and utilization for RHV within CloudForms.</p>
<p>Happy CloudForming!</p>
<p>(c) 2017 Keith Tenzer</p>
<p>&nbsp;</p>
