---
layout: post
title: 'Application Containers: Kubernetes and Docker from Scratch'
date: 2015-06-01 13:51:39.000000000 -07:00
type: post
parent_id: '0'
published: true
password: ''
status: publish
categories:
- Containers
tags:
- Docker
- Kubernetes
- LXC
meta:
  _edit_last: '63054820'
  geo_public: '0'
  _wpas_skip_9542380: '1'
  _publicize_job_id: '11224849260'
  publicize_linkedin_url: https://www.linkedin.com/updates?discuss=&scope=329229505&stype=M&topic=6011136828390809601&type=U&a=Z2Sv
  _publicize_done_9423386: '1'
  _wpas_done_9468659: '1'
  _wpas_skip_9468659: '1'
author:
  login: ktenzer1
  email: keith.tenzer@gmail.com
  display_name: ktenzer
  first_name: ''
  last_name: ''
permalink: "/2015/06/01/application-containers-kubernetes-and-docker-from-scratch/"
---
<h3>Overview</h3>
<p>In this article we will look at how to configure a Kubernetes cluster using the Docker container format on CentOS or RHEL 7.1. For a detailed overview on Kubernetes and Docker take a look at this <a href="http://keithtenzer.com/2015/04/15/containers-at-scale-with-kubernetes-on-openstack/">article</a>. A Kubernetes cluster is comprised of a master and N nodes. The master acts as a control plane for the cluster and in this case also exposes a private Docker registry. A Kubernetes node runs Docker container images.</p>
<p><img class="  wp-image-964 aligncenter" src="{{ site.baseurl }}/assets/2015/06/kubernetes_high_level_architecture1.png?w=300" alt="Kubernetes_High_Level_Architecture" width="1373" height="856" /><!--more--></p>
<h3>Requirements</h3>
<p>In this article we will setup a master and one node. At minimum two hosts will be required. Kubernetes also has the following networking requirements:</p>
<ul>
<li>all containers can communicate with all other containers without NAT</li>
<li>all nodes can communicate with all containers (and vice-versa) without NAT</li>
<li>the IP that a container sees itself as is the same IP that others see it as</li>
</ul>
<p>In order to meet these networking requirements an overlay network  must be configured. Two commonly used overlay networks for Kuberentes are Flannel and Open vSwitch. In this article we will use Flannel.</p>
<h3>Setup Kubernetes Master</h3>
<p>Creating a Kubernetes master means configuring Kubernetes, Etcd, Flannel, Docker and a private Docker registry. The private Docker registry is used by the nodes in order to pull images.</p>
<h4>Install packages and enable services</h4>
<pre style="padding-left:30px;">#yum update -y</pre>
<pre style="padding-left:30px;">#yum install -y docker docker-registry etcd kubernetes flannel</pre>
<pre style="padding-left:30px;">#for SERVICES in docker.service docker-registry etcd kube-apiserver kube-controller-manager kube-scheduler flanneld 
   do systemctl enable $SERVICES 
done</pre>
<h4> Configure Private Docker Registry</h4>
<pre style="padding-left:30px;">#vi /etc/sysconfig/docker
INSECURE_REGISTRY='--insecure-registry kube-master.lab.com:5000'</pre>
<h4> Configure Kuberentes API Server</h4>
<pre style="padding-left:30px;">#vi /etc/kubernetes/apiserver
KUBE_API_ADDRESS="--address=0.0.0.0"
KUBE_API_PORT="--port=8080"
KUBE_ETCD_SERVERS="--etcd_servers=http://kube-master.lab.com:4001"</pre>
<h4> Configure Kubernetes Master</h4>
<pre style="padding-left:30px;">#vi /etc/kubernetes/config
KUBE_MASTER="--master=http://kube-master.lab.com:8080"
</pre>
<h4>Configure Kubernetes Nodes (kubelets)</h4>
<pre style="padding-left:30px;">#vi /etc/kubernetes/controller-manager
KUBELET_ADDRESSES="--machines=kube-node1.lab.com"</pre>
<h4>Configure ETCD</h4>
<pre style="padding-left:30px;">#vi /etc/etcd/etcd.conf
ETCD_LISTEN_PEER_URLS="http://localhost:2380,http://localhost:7001"
ETCD_LISTEN_CLIENT_URLS="http://0.0.0.0:4001,http://0.0.0.0:2379"</pre>
<pre style="padding-left:30px;">#systemctl start etcd</pre>
<h4>Configure Overlay Network using Flannel</h4>
<pre style="padding-left:30px;">#vi /etc/sysconfig/flanneld
FLANNEL_ETCD="http://kube-master.lab.com:4001"
FLANNEL_ETCD_KEY="/flannel/network"
FLANNEL_OPTIONS="eth0"</pre>
<pre style="padding-left:30px;">#vi /root/flannel-config.json
{
   "Network": "10.100.0.0/16",
   "SubnetLen": 24,
   "SubnetMin": "10.100.50.0",
   "SubnetMax": "10.100.199.0",
   "Backend": {
   "Type": "vxlan",
   "VNI": 1
   }
 }</pre>
<pre style="padding-left:30px;">curl -L http://kube-master.lab.com:4001/v2/keys/flannel/network/config -XPUT --data-urlencode value@flannel-config.json</pre>
<h4>Download Docker Images to private registry</h4>
<pre style="padding-left:30px;">#systemctl start docker</pre>
<pre style="padding-left:30px;">#systemctl start docker-registry</pre>
<pre style="padding-left:30px;">#for IMAGE in rhel6 rhel7  kubernetes/kube2sky:1.1 kubernetes/pause:go
   do docker pull $IMAGE
   docker tag $IMAGE kube-master.lab.com:5000/$IMAGE
   docker push kube-master.lab.com:5000/$IMAGES
done</pre>
<pre style="padding-left:30px;">systemctl reboot</pre>
<h3>Setup Kubernetes Node</h3>
<p>In this example we will setup a Kubernetes node from scratch. It is also possible to use a container OS like <a href="https://access.redhat.com/articles/rhel-atomic-getting-started">RHEL Atomic</a> as a Kubernetes node. RHEL Atomic is an OS optimized for running containers. Choosing whether to use RHEL Atomic or a standard RHEL depends greatly on your specific requirements.</p>
<h4>Install Packages and enable services</h4>
<pre style="padding-left:30px;">#yum update -y</pre>
<pre style="padding-left:30px;">#yum install -y docker docker-registry etcd kubernetes flannel</pre>
<pre>#for SERVICES in docker.service kubelet kube-proxy flanneld
   do  systemctl enable $SERVICES
done</pre>
<h4>Configure Kubernets Master</h4>
<pre style="padding-left:30px;">#vi /etc/kubernetes/config
KUBE_MASTER="--master=http://kube-master.lab.com:8080"</pre>
<h4>Configure Kubernetes Node (kubelet)</h4>
<pre style="padding-left:30px;">#vi /etc/kubernetes/kubelet
KUBELET_ADDRESS="--address=0.0.0.0"</pre>
<p>KUBELET_PORT="--port=10250"<br />
KUBELET_HOSTNAME=""</p>
<pre style="padding-left:30px;">KUBELET_API_SERVER="--api_servers=http://kube-master.lab.com:8080"</pre>
<h4>Configure Docker</h4>
<pre style="padding-left:30px;">#vi /etc/sysconfig/docker
ADD_REGISTRY='--add-registry registry.access.redhat.com'
ADD_REGISTRY='--add-registry kube-master.lab.com:5000'</pre>
<h4>Configure Flannel</h4>
<pre style="padding-left:30px;">#vi /etc/sysconfig/flanneld
FLANNEL_ETCD="http://kube-master.lab.com:4001"
FLANNEL_ETCD_KEY="/flannel/network"
FLANNEL_OPTIONS="eth0"</pre>
<pre style="padding-left:30px;">#systemctl reboot</pre>
<h3>Summary</h3>
<p>In this article we went through the steps of building a Kubernetes cluster from scratch on RHEL or CentOS 7.1. As you have seen standing up a Kubernetes cluster can be done very easily. Hopefully you have found this article helpful, feedback is always greatly appreciated.</p>
<div class="line">Happy Containerizing!</div>
<div class="line">
<p>(c) 2015 Keith Tenzer</p>
</div>
